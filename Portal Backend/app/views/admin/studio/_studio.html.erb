<base href="/studio/">

<!-- <link rel="stylesheet" href="css/bootstrap-yeti.min.css"> -->
<link rel="stylesheet" href="css/bootstrap-colorpicker.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" href="css/bootstrap-select.min.css">

<link rel="stylesheet" href="css/style.css">

<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
<script src="js/config.js"></script>
<!-- <script src="js/bootstrap.min.js"></script> -->
<script src="js/fabric.js"></script>
<script src="js/card.js"></script>

<script src="js/fabricjs_viewport.js"></script>
<script src="js/bootstrap-colorpicker.min.js"></script>
<script src="js/grid.js"></script>
<script src="js/validator.min.js"></script>
<script src="js/dropzone.js"></script>
<script src="js/jquery.fontavailable-1.1.min.js"></script>
<script src="js/bootstrap-select.min.js"></script>
<script src="js/jquery-sortable-min.js"></script>
<script src="https://cdn.jsdelivr.net/jsbarcode/3.3.7/JsBarcode.all.min.js"></script>

<!--
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>-->

<!--<script>var to_load = {org_id: 20000025, card_template_id: 11305}</script>-->

<div class="container">
    <div class="row" id="headerTitle">
        <h1><i class="fa fa-spinner fa-pulse"></i> Loading</h1>
    </div>

    <div class="row">

        <div class="col-xs-3" style="padding-right: 30px;"> <!-- Tools and Layers -->

            <!-- Tools -->
            <div class="row">
                <div class="col-xs-4"><button class="btn btn-default btn-tool active" data-toggle="tooltip" data-placement="bottom" title="Select and move objects" id="toolDefault"><i class="fa fa-arrows"></i></button></div>
                <div class="col-xs-4"><button class="btn btn-default btn-tool font-times" style="font-size: 20px;" data-toggle="tooltip" data-placement="bottom" title="Add new static text" id="toolText">T</button></div>
                <div class="col-xs-4"><button class="btn btn-default btn-tool font-times" style="font-size: 20px; padding-left: 15px;" data-toggle="tooltip" data-placement="bottom" title="Add variable text" id="toolVarText">T<sub style="font-size: 10px !important;">var</sub></button></div>
            </div>
            <div class="row">
                <div class="col-xs-4"><button class="btn btn-default btn-tool" data-toggle="tooltip" data-placement="bottom" title="Draw a shape" id="toolDrawObject"><i class="fa fa-object-ungroup"></i></button></div>
                <div class="col-xs-4" data-toggle="modal" data-target="#modalSelectImage" id="addNewImage"><button class="btn btn-default btn-tool" data-toggle="tooltip" data-placement="bottom" title="Add an image" id="newImage"><i class="fa fa-photo"></i></button></div>
                <div class="col-xs-4"><button class="btn btn-default btn-tool font-times" style="padding-left: 12px;" data-toggle="tooltip" data-placement="bottom" title="Add variable image" id="toolVarImage"><i class="fa fa-photo"></i><sub style="font-size: 10px !important; padding-left:2px">var</sub></button></div>
            </div>
            <div class="row">
                <div class="col-xs-4"><button class="btn btn-default btn-tool" data-toggle="tooltip" data-placement="bottom" title="Add barcode" id="toolBarcode"><i class="fa fa-barcode"></i></button></div>
                <div class="col-xs-4"><button class="btn btn-default btn-tool" data-toggle="tooltip" data-placement="bottom" title="Add QR code" id="toolQrcode"><i class="fa fa-qrcode"></i></button></div>
                <!--<div class="col-xs-4"><button class="btn btn-default btn-tool" data-toggle="tooltip" data-placement="bottom" title="Tooltip"> </button></div>-->
            </div>

            <!-- Layers -->
            <div class="row">
                <div class="col-xs-12"><h4>Layers <i class="fa fa-lock buttonWithTooltip" data-toggle="tooltip" data-placement="bottom" title="Lock the selection"></i></h4></div>
            </div>

            <div class="row layersList">
            </div>

            <div class="row">
                <div class="col-xs-12"><h4>Position</h4></div>
            </div>

            <div class="row position">
                <div class="col-xs-4">Units:</div>
                <div class="col-xs-8">
                    <select class="selectMetric">
                        <option value="px" selected>px</option>
                        <option value="mm">mm</option>
                        <option value="in">in</option>
                    </select>
                </div>
            </div>

            <div class="row position">
                <div class="col-xs-4">Width:</div>
                <div class="col-xs-6">
                    <input type="text" value="0" class="form-control small-input" id="positionWidth" />
                </div>
            </div>
            <div class="row position">
                <div class="col-xs-4">Height:</div>
                <div class="col-xs-6">
                    <input type="text" value="0" class="form-control small-input" id="positionHeight" />
                </div>
            </div>
            <div class="row position">
                <div class="col-xs-4">Top:</div>
                <div class="col-xs-6">
                    <input type="text" value="0" class="form-control small-input" id="positionTop" />
                </div>
            </div>
            <div class="row position">
                <div class="col-xs-4">Left:</div>
                <div class="col-xs-6">
                    <input type="text" value="0" class="form-control small-input" id="positionLeft" />
                </div>
            </div>

            <div class="row position">
                <div class="col-xs-12 checkbox" style="margin-top:0">
                    <label>
                        <input type="checkbox" id="positionKeepAspectRatio"> Keep Aspect Ratio
                    </label>
                </div>
            </div>
        </div>
        
        <div class="col-xs-9"> <!-- Tabs and Work Area -->
            <div class="row"> <!-- Tabs -->
                <div class="scroller scroller-left"><i class="glyphicon glyphicon-chevron-left"></i></div>
                <div class="scroller scroller-right"><i class="glyphicon glyphicon-chevron-right"></i></div>
                <div class="wrapper">
                    <ul class="nav nav-tabs list">
                        <li role="presentation" class="hidden"><a href="#" class="tab-image">Image</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-varImage">Variable Image</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-barcode">Barcode</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-qrcode">QR code</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-shape">Shape</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-text">Static Text</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-varText">Variable Text Field</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-align">Align Objects</a></li>
                        <li role="presentation" class="active"><a href="#" class="tab-card">Card</a></li>
                        <li role="presentation"><a href="#" class="tab-frontSide">Front Side</a></li>
                        <li role="presentation" class="hidden"><a href="#" class="tab-magstripe">Magstripe</a></li>
                        <li role="presentation"><a href="#" class="tab-handling">Handling Options</a></li>
                        <li role="presentation"><a href="#" class="tab-view">View</a></li>
                    </ul>
                </div>

                <!-- TAB STATIC TEXT -->
                <div class="col-xs-12 tab hidden" id="tab-text">
                    <div class="row">
                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editTextText">Text</label></div>
                                <!--<div class="col-xs-9"><input type="text" class="form-control" id="editTextText" placeholder="Placeholder Text"></div>-->
                                <div class="col-xs-9"><textarea class="form-control" style="height:40px" id="editTextText"></textarea></div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editTextFont">Font</label></div>
                                <div class="col-xs-9">
                                    <div class="dropdown">
                                        <button class="btn btn-default dropdown-toggle font-times" type="button" id="editTextFont" data-toggle="dropdown" aria-expanded="true">
                                            Times New Roman
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-fonts" role="menu" aria-labelledby="editTextFont">
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editTextFont font-arial">Arial</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editTextFont font-times">Times New Roman</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editTextFont font-calibri">Calibri</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editTextFont font-opensans">Open Sans</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editTextSize">Size</label></div>
                                <div class="col-xs-9">
                                    <div class="row">
                                        <div class="col-xs-6">
                                            <div style="float: left; width: 70px"><input type="text" value="14" class="form-control" id="editTextSize" /></div>
                                            <div style="padding-top: 7px">&nbsp; px</div>
                                        </div>
                                        <div class="col-xs-6" style="padding-left:0">
                                            <div class="checkbox" style="margin-top:0">
                                                <label style="padding-top:0">
                                                    <input type="checkbox" id="editTextAutoResize" checked> Auto-resize
                                                </label>
                                            </div>
                                            <div class="checkbox" style="margin-top:0">
                                                <label style="padding-top:0">
                                                    <input type="checkbox" id="editTextNoClip"> No clipping
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-12">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-default" id="editTextBold">
                                            <i class="fa fa-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editTextItalic">
                                            <i class="fa fa-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editTextUnderline">
                                            <i class="fa fa-underline"></i>
                                        </button>
                                    </div>

                                    <div class="btn-group" role="group" style="padding-left:24px">
                                        <button type="button" class="btn btn-default" id="editTextAlignLeft">
                                            <i class="fa fa-align-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editTextAlignCenter">
                                            <i class="fa fa-align-center"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editTextAlignRight">
                                            <i class="fa fa-align-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editTextColor">Color</label></div>
                                <div class="col-xs-9" style="padding:0">
                                    <div class="col-xs-9" style="padding-right:0; margin-right:0; width:166px">
                                        <div class="input-group editTextColor">
                                            <input type="text" value="#000000" class="form-control" id="editTextColor" />
                                            <span class="input-group-addon" style="border-right:0"><i></i></span>
                                        </div>
                                    </div>
                                    <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px;">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-default" id="editTextColorPicker">
                                                <i class="fa fa-eyedropper"></i>
                                            </button>
                                            <button type="button" class="btn btn-default colorpickerBlack"></button>
                                            <button type="button" class="btn btn-default colorpickerWhite"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- TAB VARIABLE TEXT -->

                <div class="col-xs-12 tab hidden" id="tab-varText">
                    <div class="row">
                        <div class="col-xs-6">

                            <div class="row tab-row" id="editVarTextVariableSelectGroup">
                                <div class="col-xs-3"><label for="editVarTextVariable">Field Name</label></div>
                                <div class="col-xs-9">
                                    <div class="input-group" role="group">
                                        <select class="form-control" id="editVarTextVariable">
                                            <option value="0" selected>First Name</option>
                                            <option value="1">Last Name</option>
                                            <option value="2">Position</option>
                                        </select>

                                        <div class="input-group-addon var">
                                            <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editVarTextVariableAddGroup">
                                <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                    <input type="text" class="form-control inputVar" data-type="text" placeholder="Variable Name">
                                </div>

                                <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success saveVar">
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-danger cancelVar">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row" style="padding-top:5px">
                                <div class="col-xs-3"><label for="editVarTextFont">Font</label></div>
                                <div class="col-xs-9">
                                    <div class="dropdown">
                                        <button class="btn btn-default dropdown-toggle font-times" type="button" id="editVarTextFont" data-toggle="dropdown" aria-expanded="true">
                                            Times New Roman
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-fonts" role="menu" aria-labelledby="editVarTextFont">
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editVarTextFont font-arial">Arial</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editVarTextFont font-times">Times New Roman</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editVarTextFont font-calibri">Calibri</a></li>
                                            <li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editVarTextFont font-opensans">Open Sans</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editVarTextSize">Size</label></div>
                                <div class="col-xs-9">
                                    <div class="row">
                                        <div class="col-xs-6">
                                            <div style="float: left; width: 70px"><input type="text" value="14" class="form-control" id="editVarTextSize" /></div>
                                            <div style="padding-top: 7px">&nbsp; px</div>
                                        </div>
                                        <div class="col-xs-6" style="padding-left:0">
                                            <div class="checkbox" style="margin-top:0">
                                                <label style="padding-top:0">
                                                    <input type="checkbox" id="editVarTextAutoResize" checked> Auto-resize
                                                </label>
                                            </div>
                                            <div class="checkbox" style="margin-top:0">
                                                <label style="padding-top:0">
                                                    <input type="checkbox" id="editVarTextNoClip"> No clipping
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-12">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-default" id="editVarTextBold">
                                            <i class="fa fa-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editVarTextItalic">
                                            <i class="fa fa-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editVarTextUnderline">
                                            <i class="fa fa-underline"></i>
                                        </button>
                                    </div>

                                    <div class="btn-group" role="group" style="padding-left:24px">
                                        <button type="button" class="btn btn-default" id="editVarTextAlignLeft">
                                            <i class="fa fa-align-left"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editVarTextAlignCenter">
                                            <i class="fa fa-align-center"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editVarTextAlignRight">
                                            <i class="fa fa-align-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editVarTextColor">Color</label></div>
                                <div class="col-xs-9" style="padding:0">
                                    <div class="col-xs-9" style="padding-right:0; margin-right:0; width:166px">
                                        <div class="input-group editVarTextColor">
                                            <input type="text" value="#000000" class="form-control" id="editVarTextColor" />
                                            <span class="input-group-addon" style="border-right:0"><i></i></span>
                                        </div>
                                    </div>
                                    <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px;">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-default" id="editVarTextColorPicker">
                                                <i class="fa fa-eyedropper"></i>
                                            </button>
                                            <button type="button" class="btn btn-default colorpickerBlack"></button>
                                            <button type="button" class="btn btn-default colorpickerWhite"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- TAB SHAPES -->

                <div class="col-xs-12 tab hidden" id="tab-shape" style="padding-bottom:0">
                    <div class="row">
                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-12">

                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-default" id="editShapeRectangle">
                                            <i class="fa fa-square"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editShapeEllipse">
                                            <i class="fa fa-circle"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editShapeTriangle">
                                            <i class="fa fa-caret-up"></i>
                                        </button>
                                        <button type="button" class="btn btn-default" id="editShapeLine">
                                            â€”
                                        </button>
                                    </div>

                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editShapeColor">Color</label></div>
                                <div class="col-xs-9">
                                    <div class="col-xs-9" style="padding-left:0; padding-right:0; margin-right:0; width:126px">
                                        <div class="input-group editShapeColor">
                                            <input type="text" value="#000000" class="form-control" id="editShapeColor" />
                                            <span class="input-group-addon" style="border-right:0"><i></i></span>
                                        </div>
                                    </div>
                                    <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-default" id="editShapeColorPicker">
                                                <i class="fa fa-eyedropper"></i>
                                            </button>
                                            <button type="button" class="btn btn-default colorpickerBlack"></button>
                                            <button type="button" class="btn btn-default colorpickerWhite"></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-3"><label style="margin-bottom:0">Transparency:</label></div>
                                <div class="col-xs-9"><input style="width: 149px; padding-top:10px;" type="range" id="editShapeTransparency" value="100" min="0" max="100"></div>
                            </div>

                            <div class="row tab-row" style="padding-top:0; height:38px" id="editShapeCorners">
                                <div class="col-xs-3"><label for="editShapeCornersValue">Rounded corners</label></div>
                                <div class="col-xs-3" style="padding-top:10px;"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editShapeCornersValue" value="0"></div>
                                <div class="col-xs-6" style="padding-top:10px; padding-left:0">px</div>
                            </div>

                            <div class="row tab-row hidden" style="padding-top:0; height:38px">
                                <div class="col-xs-3" style="padding-top:10px;"><label for="editShapeLineWidth">Width</label></div>
                                <div class="col-xs-3" style="padding-top:10px;"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editShapeLineWidth" value="5"></div>
                                <div class="col-xs-6" style="padding-top:10px; padding-left:0">px</div>
                            </div>
                        </div>

                        <div class="col-xs-6">
                            <div class="row tab-row">
                                <div class="col-xs-12">

                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="editShapeBorder"> Border
                                        </label>
                                    </div>

                                    <div class="row tab-row">
                                        <div class="col-xs-3"><label for="editShapeBorderWidth">Border Width</label></div>
                                        <div class="col-xs-3" style="padding-right:0;"><input style="width:55px" maxlength="3" type="text" class="form-control" id="editShapeBorderWidth" value="1"></div>
                                        <div class="col-xs-6" style="padding-top:7px; padding-left:0;">px</div>
                                    </div>

                                    <div class="row tab-row">
                                        <div class="col-xs-3"><label for="editShapeBorderColor">Border Color</label></div>
                                        <div class="col-xs-9">
                                            <div class="col-xs-9" style="padding:0; margin-right:0; width:126px">
                                                <div class="input-group editShapeBorderColor">
                                                    <input type="text" value="#000000" class="form-control" id="editShapeBorderColor" />
                                                    <span class="input-group-addon" style="border-right:0"><i></i></span>
                                                </div>
                                            </div>
                                            <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px">
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-default" id="editShapeBorderColorPicker">
                                                        <i class="fa fa-eyedropper"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                    <button type="button" class="btn btn-default colorpickerWhite"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB IMAGE -->
                <div class="col-xs-12 tab hidden" id="tab-image">

                    <div class="row">
                        <div class="col-xs-4">
                            <div class="row tab-row">

                                <div class="col-xs-12">
                                    <div class="checkbox" style="margin-top:0">
                                        <label>
                                            <input type="checkbox" id="editImageRemoveWhite"> Remove Color
                                        </label><br>
                                        <label style="margin-bottom:0; padding-top:0">Threshold: <input type="range" id="editImageRemoveWhiteThreshold" value="60" min="0" max="255"></label>
                                        <div class="row tab-row" style="padding-top:0">
                                            <div class="col-xs-12">
                                                <div class="col-xs-9" style="padding:0; margin-right:0; width:130px">
                                                    <div class="input-group editImageRemoveWhiteColor">
                                                        <input type="text" value="#000000" class="form-control" id="editImageRemoveWhiteColor" />
                                                        <span class="input-group-addon" style="border-right:0"><i></i></span>
                                                    </div>
                                                </div>
                                                <div class="col-xs-3" style="padding:0; margin-left:0; width:70px">

                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-default" id="editImageRemoveWhiteColorPicker">
                                                            <i class="fa fa-eyedropper"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                        <button type="button" class="btn btn-default colorpickerWhite"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="col-xs-3">
                            <div class="row tab-row">
                                <div class="col-xs-12">
                                    <label style="margin-bottom:0">Transparency: <input style="width: 149px" type="range" id="editImageTransparency" value="100" min="0" max="100"></label>

                                    <div class="checkbox" style="margin-top:0">
                                        <label>
                                            <input type="checkbox" id="editImageGrayscale"> Grayscale
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xs-5">
                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editImageCornerRadius">Corner Radius</label></div>
                                <div class="col-xs-3" style="padding-top:10px;"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editImageCornerRadius" value="0"></div>
                                <div class="col-xs-6" style="padding-top:10px;">px</div>
                            </div>

                            <div class="row tab-row" style="padding-top:0">
                                <div class="col-xs-12">

                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="editImageBorder"> Border
                                        </label>
                                    </div>

                                    <div class="row tab-row" style="padding-top:0">
                                        <div class="col-xs-3"><label for="editImageBorderWidth">Width</label></div>
                                        <div class="col-xs-3"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editImageBorderWidth" value="1"></div>
                                        <div class="col-xs-6">px</div>
                                    </div>

                                    <div class="row tab-row" style="padding-top:0">
                                        <div class="col-xs-12">
                                            <div class="col-xs-9" style="padding:0; margin-right:0; width:130px">
                                                <div class="input-group editImageBorderColor">
                                                    <input type="text" value="#000000" class="form-control" id="editImageBorderColor" />
                                                    <span class="input-group-addon" style="border-right:0"><i></i></span>
                                                </div>
                                            </div>
                                            <div class="col-xs-3" style="padding:0; margin-left:0; width:70px">

                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-default" id="editImageBorderColorPicker">
                                                        <i class="fa fa-eyedropper"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                    <button type="button" class="btn btn-default colorpickerWhite"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            <!-- TAB VARIABLE IMAGE -->

            <div class="col-xs-12 tab hidden" id="tab-varImage">

                <div class="row">
                    <div class="col-xs-5">
                        <div class="row tab-row" id="editVarImageVariableSelectGroup">
                            <div class="col-xs-3"><label for="editVarTextVariable">Image Name</label></div>
                            <div class="col-xs-9">
                                <div class="input-group" role="group">
                                    <select class="form-control" id="editVarImageVariable">
                                        <option value="0" selected>Portrait</option>
                                        <option value="1">Logo</option>
                                    </select>

                                    <div class="input-group-addon var">
                                        <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row hidden" id="editVarImageVariableAddGroup">
                            <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                <input type="text" class="form-control inputVar" data-type="image" placeholder="Variable Name">
                            </div>

                            <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success saveVar">
                                        Save
                                    </button>
                                    <button type="button" class="btn btn-danger cancelVar">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row" style="padding-top:5px; margin-top:0">
                            <div class="col-xs-3"><label>Resizing</label></div>
                            <div class="col-xs-9">
                                <div class="radio" style="padding-top:2px; margin-top:0; margin-bottom:0">
                                    <label>
                                        <input type="radio" name="editVarImageResizing" id="editVarImageResizingStretch" value="stretch" checked>
                                        Stretch
                                    </label>
                                </div>
                                <div class="radio" style="margin-bottom:0">
                                    <label>
                                        <input type="radio" name="editVarImageResizing" id="editVarImageResizingFit" value="fit">
                                        Fit
                                    </label>
                                </div>
                                <div class="radio" style="margin-bottom:0">
                                    <label>
                                        <input type="radio" name="editVarImageResizing" id="editVarImageResizingCrop" value="crop">
                                        Crop
                                    </label>
                                </div>
                            </div>

                        </div>


                        <div class="row tab-row" style="padding-top:0">
                            <div class="col-xs-3"><label for="editVarImageCornerRadius">Corner Radius</label></div>
                            <div class="col-xs-3" style="padding-top:10px;"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editVarImageCornerRadius" value="0"></div>
                            <div class="col-xs-6" style="padding-top:10px;">px</div>
                        </div>
                    </div>

                    <div class="col-xs-3">

                        <div class="row tab-row">
                            <div class="col-xs-12">
                                <label style="margin-bottom:0">Transparency: <input style="width: 149px" type="range" id="editVarImageTransparency" value="100" min="0" max="100"></label>

                                <div class="checkbox" style="margin-top:0">
                                    <label>
                                        <input type="checkbox" id="editVarImageGrayscale"> Grayscale
                                    </label>
                                </div>

                                <div class="checkbox" style="margin-top:0">
                                    <label>
                                        <input type="checkbox" id="editVarImageRemoveWhite"> Remove Color
                                    </label><br>
                                    <label style="margin-bottom:0; padding-top:0">Threshold: <input type="range" id="editVarImageRemoveWhiteThreshold" value="60" min="0" max="255"></label>
                                    <div class="row tab-row" style="padding-top:0">
                                        <div class="col-xs-12">
                                            <div class="col-xs-9" style="padding:0; margin-right:0; width:120px">
                                                <div class="input-group editVarImageRemoveWhiteColor">
                                                    <input type="text" value="#000000" class="form-control" id="editVarImageRemoveWhiteColor" />
                                                    <span class="input-group-addon" style="border-right:0"><i></i></span>
                                                </div>
                                            </div>
                                            <div class="col-xs-3" style="padding:0; margin-left:0; width:70px">

                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-default" id="editVarImageRemoveWhiteColorPicker">
                                                        <i class="fa fa-eyedropper"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                    <button type="button" class="btn btn-default colorpickerWhite"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>

                    <div class="col-xs-4">
                        <div class="row tab-row">
                            <div class="col-xs-12">

                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="editVarImageBorder"> Border
                                    </label>
                                </div>

                                <div class="row tab-row">
                                    <div class="col-xs-3"><label for="editVarImageBorderWidth">Width</label></div>
                                    <div class="col-xs-3"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editVarImageBorderWidth" value="1"></div>
                                    <div class="col-xs-6">px</div>
                                </div>

                                <div class="row tab-row">
                                    <div class="col-xs-12">
                                        <div class="col-xs-9" style="padding:0; margin-right:0; width:100px">
                                            <div class="input-group editVarImageBorderColor">
                                                <input type="text" value="#000000" class="form-control" id="editVarImageBorderColor" />
                                                <span class="input-group-addon" style="border-right:0"><i></i></span>
                                            </div>
                                        </div>
                                        <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px">

                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-default" id="editVarImageBorderColorPicker">
                                                    <i class="fa fa-eyedropper"></i>
                                                </button>
                                                <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                <button type="button" class="btn btn-default colorpickerWhite"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <!-- TAB BARCODE -->

            <div class="col-xs-12 tab hidden" id="tab-barcode">
                <div class="row">
                    <div class="col-xs-6">

                        <div class="row tab-row">
                            <div class="col-xs-3"><label for="editBarcodeType">Barcode Type</label></div>
                            <div class="col-xs-9">
                                <div class="input-group" role="group">
                                    <select class="form-control" id="editBarcodeType">
                                        <option value="Code25">Code 25</option>
                                        <option value="Code25Interleaved">Code 25 Interleaved</option>
                                        <option value="Code25IATA">Code 25 IATA</option>
                                        <option value="code39" selected>Code 39</option>
                                        <option value="code39extended">Code 39 (Extended)</option>
                                        <option value="code128A">Code 128A</option>
                                        <option value="code128B">Code 128B</option>
                                        <option value="code128C">Code 128C</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row">
                            <div class="col-xs-3"><label for="editBarcodeFixed">Text Type</label></div>
                            <div class="col-xs-9">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-default active" id="editBarcodeFixed">Fixed</button>
                                    <button class="btn btn-default" id="editBarcodeVariable">Variable</button>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row" id="editBarcodeTextRow">
                            <div class="col-xs-3"><label for="editBarcodeText">Fixed Text</label></div>
                            <div class="col-xs-9 form-group" style="margin-bottom:0">
                                <form data-toggle="validator" id="editBarcodeTextForm">
                                <input class="form-control" id="editBarcodeText"
                                       type="text" maxlength="25" pattern="^[-+.$/%\sA-Z0-9]+$"
                                       rel="txtTooltip" title="0-9, A-Z (upper case only), space, minus (-), plus (+), period (.), dollar sign ($), slash (/), and percent (%)" data-toggle="tooltip" data-placement="top">
                                </form>
                            </div>
                        </div>

                        <div class="row tab-row hidden" id="editBarcodeVariableRow">
                            <div class="col-xs-3" style="padding-right:0"><label for="editBarcodeTextVariable">Variable Text</label></div>
                            <div class="col-xs-9">
                                <div class="input-group" role="group">
                                    <select class="form-control" id="editBarcodeTextVariable">
                                        <option value="-1"></option>
                                    </select>

                                    <div class="input-group-addon var">
                                        <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row hidden" id="editBarcodeAddGroup">
                            <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                <input type="text" class="form-control inputVar" data-type="barcode" placeholder="Variable Name">
                            </div>

                            <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success saveVar">
                                        Save
                                    </button>
                                    <button type="button" class="btn btn-danger cancelVar">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="col-xs-6">
                        <div class="row tab-row">
                            <div class="col-xs-12">

                                <div class="checkbox">
                                    <label style="padding-top: 0">
                                        <input type="checkbox" id="editBarcodeBorder"> Border
                                    </label>
                                </div>

                                <div class="row tab-row" style="padding-top: 0">
                                    <div class="col-xs-4"><label for="editBarcodeBorderWidth" style="padding-top: 0">Border Width</label></div>
                                    <div class="col-xs-3" style="padding-right:0;"><input style="width:55px" maxlength="3" type="text" class="form-control small-input" id="editBarcodeBorderWidth" value="1"></div>
                                    <div class="col-xs-5" style="padding-left:0;">px</div>
                                </div>

                                <div class="row tab-row"  style="padding-top: 5px">
                                    <div class="col-xs-4"><label for="editBarcodeBorderColor">Border Color</label></div>
                                    <div class="col-xs-8">
                                        <div class="col-xs-9" style="padding:0; margin-right:0; width:126px">
                                            <div class="input-group editBarcodeBorderColor">
                                                <input type="text" value="#000000" class="form-control small-input" id="editBarcodeBorderColor" />
                                                <span class="input-group-addon small-input" style="border-right:0"><i></i></span>
                                            </div>
                                        </div>
                                        <div class="col-xs-3" style="padding-left:0; margin-left:0; padding-right:0">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-default small-input" id="editBarcodeBorderColorPicker">
                                                    <i class="fa fa-eyedropper"></i>
                                                </button>
                                                <button type="button" class="btn btn-default colorpickerBlack small-input"></button>
                                                <button type="button" class="btn btn-default colorpickerWhite small-input"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row tab-row" style="padding-top: 0">
                                    <div class="col-xs-4">
                                        <label>Bar Width:</label>
                                        <input type="text" style="width: 55px" maxlength="2" class="form-control small-input buttonWithTooltip" value="5" id="editBarcodeBarWidth"
                                                data-toggle="tooltip" data-placement="top" data-original-title="1-10">
                                    </div>

                                    <div class="col-xs-4">
                                        <label>Quiet Zone:</label>
                                        <input type="text" style="width: 55px" maxlength="3" class="form-control small-input buttonWithTooltip" value="10" id="editBarcodeQuietZone"
                                               data-toggle="tooltip" data-placement="top" data-original-title="0-100">
                                    </div>

                                    <div class="col-xs-4" style="padding-top:20px">
                                        <button type="button" class="btn btn-default small-input" data-toggle="modal" data-target="#modalBarcodePreview">Preview</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB QR CODE -->
            <div class="col-xs-12 tab hidden" id="tab-qrcode">
                <div class="row">
                    <div class="col-xs-6">

                        <div class="row tab-row">
                            <div class="col-xs-3"><label for="editQrcodeFixed">Text Type</label></div>
                            <div class="col-xs-9">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-default active" id="editQrcodeFixed">Fixed</button>
                                    <button class="btn btn-default" id="editQrcodeVariable">Variable</button>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row" id="editQrcodeTextRow">
                            <div class="col-xs-3"><label for="editQrcodeText">Fixed Text</label></div>
                            <div class="col-xs-9">
                                <input type="text" class="form-control" id="editQrcodeText">
                            </div>
                        </div>

                        <div class="row tab-row hidden" id="editQrcodeVariableRow">
                            <div class="col-xs-3" style="padding-right:0"><label for="editQrcodeTextVariable">Variable Text</label></div>
                            <div class="col-xs-9">
                                <div class="input-group" role="group">
                                    <select class="form-control" id="editQrcodeTextVariable">
                                        <option value="-1"></option>
                                    </select>

                                    <div class="input-group-addon var">
                                        <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row tab-row hidden" id="editQrcodeAddGroup">
                            <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                <input type="text" class="form-control inputVar" data-type="qrcode" placeholder="Variable Name">
                            </div>

                            <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success saveVar">
                                        Save
                                    </button>
                                    <button type="button" class="btn btn-danger cancelVar">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="col-xs-6">
                        <div class="row tab-row">
                            <div class="col-xs-12"> <!-- <div class="col-xs-12" style="position:relative; top:-30px"> -->
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="editQrcodeBorder"> Border
                                    </label>
                                </div>

                                <div class="row tab-row">
                                    <div class="col-xs-3"><label for="editQrcodeBorderWidth">Border Width</label></div>
                                    <div class="col-xs-3" style="padding-right:0;"><input style="width:55px" maxlength="3" type="text" class="form-control" id="editQrcodeBorderWidth" value="1"></div>
                                    <div class="col-xs-6" style="padding-top:7px; padding-left:0;">px</div>
                                </div>

                                <div class="row tab-row">
                                    <div class="col-xs-3"><label for="editQrcodeBorderColor">Border Color</label></div>
                                    <div class="col-xs-9">
                                        <div class="col-xs-9" style="padding:0; margin-right:0; width:126px">
                                            <div class="input-group editQrcodeBorderColor">
                                                <input type="text" value="#000000" class="form-control" id="editQrcodeBorderColor" />
                                                <span class="input-group-addon" style="border-right:0"><i></i></span>
                                            </div>
                                        </div>
                                        <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-default" id="editQrcodeBorderColorPicker">
                                                    <i class="fa fa-eyedropper"></i>
                                                </button>
                                                <button type="button" class="btn btn-default colorpickerBlack"></button>
                                                <button type="button" class="btn btn-default colorpickerWhite"></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

                <!-- TAB ALIGN OBJECTS -->
                <div class="col-xs-12 tab hidden" id="tab-align">
                    <div class="row">
                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="btn-group" role="group" style="padding-left:24px">
                                    <button type="button" class="btn btn-default" id="objectsAlignLeft" data-toggle="tooltip" data-placement="bottom" title="Align left">
                                        <i class="fa fa-align-left"></i>
                                    </button>
                                    <button type="button" class="btn btn-default" id="objectsAlignCenter" data-toggle="tooltip" data-placement="bottom" title="Align center">
                                        <i class="fa fa-align-center"></i>
                                    </button>
                                    <button type="button" class="btn btn-default" id="objectsAlignRight" data-toggle="tooltip" data-placement="bottom" title="Align right">
                                        <i class="fa fa-align-right"></i>
                                    </button>
                                </div>

                                <div class="btn-group" role="group" style="padding-left:24px">
                                    <button type="button" class="btn btn-default" id="objectsAlignTop" data-toggle="tooltip" data-placement="bottom" title="Align top">
                                        <i class="fa fa-align-left fa-rotate-90"></i>
                                    </button>
                                    <button type="button" class="btn btn-default" id="objectsAlignMiddle" data-toggle="tooltip" data-placement="bottom" title="Align middle">
                                        <i class="fa fa-align-center fa-rotate-270"></i>
                                    </button>
                                    <button type="button" class="btn btn-default" id="objectsAlignBottom" data-toggle="tooltip" data-placement="bottom" title="Align bottom">
                                        <i class="fa fa-align-right fa-rotate-90"></i>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- TAB CARD -->
                <div class="col-xs-12 tab" id="tab-card">
                    <div class="row">

                        <div class="col-xs-6">
                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="cardTypeSelect">Card Type</label></div>
                                <div class="col-xs-9">
                                    <div class="dropdown">
                                        <button class="btn btn-default dropdown-toggle" type="button" id="cardTypeSelect" data-toggle="dropdown" aria-expanded="true">
                                            <i class="fa fa-spinner fa-pulse"></i> Loading
                                        </button>
                                        <ul class="dropdown-menu" role="menu" aria-labelledby="cardTypeSelect">
                                        </ul>
                                    </div>
                                    <!--
                                    <select class="form-control" id="cardSize">
                                        <option value="0" selected>85.6mm x 54mm</option>
                                        <option value="1">60mm x 20mm</option>
                                    </select>-->
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label>Sides</label></div>
                                <div class="col-xs-9">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default" id="cardOneSided">One-sided</button>
                                        <button class="btn btn-default active" id="cardDoubleSided">Double-sided</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label>Orientation</label></div>
                                <div class="col-xs-9">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default" id="cardPortrait">Portrait</button>
                                        <button class="btn btn-default active" id="cardLandscape">Landscape</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xs-6">
                            <div class="row tab-row hidden">
                                <div class="col-xs-3"><label>Front Side</label></div>
                                <div class="col-xs-9">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default active" id="cardFrontSideColor">Color</button>
                                        <button class="btn btn-default" id="cardFrontSideBW">Black & White</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row" id="cardBackSideColoring">
                                <div class="col-xs-3"><label>Back Side</label></div>
                                <div class="col-xs-9">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default" id="cardBackSideColor">Color</button>
                                        <button class="btn btn-default active" id="cardBackSideBW">Black & White</button>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label>Slot Punch</label></div>
                                <div class="col-xs-9">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default active" id="cardSlotPunchNone"><i class="fa fa-remove"></i></button>
                                        <button class="btn btn-default" id="cardSlotPunchLong">Long Side</button>
                                        <button class="btn btn-default" id="cardSlotPunchShort">Short Side</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB FRONT SIDE -->
                <div class="col-xs-12 tab" id="tab-frontSide">
                    <div class="row">
                        <div class="col-xs-12">

                            <div class="row tab-row">
                                <div class="col-xs-3"><label>Background Image</label></div>
                                <div class="col-xs-5">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-default" style="width:185px" data-toggle="modal" data-target="#modalSelectBG">Select</button>
                                        <button class="btn btn-default" id="frontSideRemoveBG">Remove</button>
                                    </div>
                                </div>
                                <div class="col-xs-4">
                                    <label style="margin-bottom:0">Transparency: <input style="width: 149px" type="range" id="frontSideTransparency" value="100" min="0" max="100"></label>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="frontSideBG">Background Color</label></div>
                                <div class="col-xs-9">
                                    <div class="col-xs-9" style="padding:0; margin-right:0; width:166px">
                                        <div class="input-group frontSideBG">
                                            <input type="text" value="#ffffff" class="form-control" id="frontSideBG" />
                                            <span class="input-group-addon" style="border-right:0"><i></i></span>
                                        </div>
                                    </div>
                                    <div class="col-xs-3" style="padding-left:0; margin-left:0; width:100px;">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-default" id="frontSideColorPicker">
                                                <i class="fa fa-eyedropper"></i>
                                            </button>
                                            <button type="button" class="btn btn-default colorpickerBlack"></button>
                                            <button type="button" class="btn btn-default colorpickerWhite"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="col-xs-12">
                                    <button class="btn btn-default buttonWithTooltip" id="frontSideCopy" data-toggle="tooltip" data-placement="top" title="Everything on the other side will be deleted!">Copy everything to the other side</button>
                                    <span id="frontSideCopyDone" class="hidden" style="color: green; font-weight: bold">Done!</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- TAB HANDLING OPTIONS-->
                <div class="col-xs-12 tab" id="tab-handling">
                    <div class="row">
                        <div class="col-xs-6">
                            <div class="row tab-row">
                                <div id="specialHandlings">

                                </div>
                            </div>
                        </div>

                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-3"><label for="editHandlingLetter">Letter</label></div>
                                <div class="col-xs-9">
                                    <select class="form-control" id="editHandlingLetter">
                                        <option value="none" selected>None</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- TAB MAGSTRIPE -->
                <div class="col-xs-12 tab hidden" id="tab-magstripe">
                    <form data-toggle="validator">
                    <div class="row">
                        <div class="col-xs-7">
                            <!-- 1 -->
                            <div class="row tab-row" id="editMagstripeSelectGroupFixed1">
                                <div class="col-xs-3"><label for="magstripeTrackFixed1">Track 1</label></div>
                                <div class="col-xs-9 form-group" style="margin-bottom:0">
                                    <input class="form-control" id="magstripeTrackFixed1"
                                           type="text" maxlength="79" pattern="^[a-zA-Z0-9]+$"
                                           rel="txtTooltip" title="79 alphanumeric characters" data-toggle="tooltip" data-placement="bottom">
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editMagstripeSelectGroup1">
                                <div class="col-xs-3"><label for="magstripeTrack1">Track 1</label></div>
                                <div class="col-xs-9">
                                    <div class="input-group" role="group">
                                        <select class="form-control" id="magstripeTrack1">
                                            <option value="-1"></option>
                                        </select>

                                        <div class="input-group-addon var">
                                            <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editMagstripeAddGroup1">
                                <div class="col-xs-7" style="padding-right: 0; margin-right: 0;">
                                    <input type="text" class="form-control inputVar" data-type="track1" placeholder="Variable Name">
                                </div>

                                <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success saveVar">
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-danger cancelVar">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 2 -->
                            <div class="row tab-row" id="editMagstripeSelectGroupFixed2">
                                <div class="col-xs-3"><label for="magstripeTrackFixed2">Track 2</label></div>
                                <div class="col-xs-9 form-group" style="margin-bottom:0">
                                    <input class="form-control" id="magstripeTrackFixed2"
                                           type="number" maxlength="40"
                                           rel="txtTooltip" title="40 numeric characters" data-toggle="tooltip" data-placement="bottom">
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editMagstripeSelectGroup2">
                                <div class="col-xs-3"><label for="magstripeTrack2">Track 2</label></div>
                                <div class="col-xs-9">
                                    <div class="input-group" role="group">
                                        <select class="form-control" id="magstripeTrack2">
                                            <option value="-1" selected></option>
                                        </select>

                                        <div class="input-group-addon var">
                                            <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editMagstripeAddGroup2">
                                <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                    <input type="text" class="form-control inputVar" data-type="track2" placeholder="Variable Name">
                                </div>

                                <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success saveVar">
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-danger cancelVar">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 3 -->
                            <div class="row tab-row" id="editMagstripeSelectGroupFixed3">
                                <div class="col-xs-3"><label for="magstripeTrackFixed3">Track 3</label></div>
                                <div class="col-xs-9 form-group" style="margin-bottom:0">
                                    <input class="form-control" id="magstripeTrackFixed3"
                                           type="number" maxlength="107"
                                           rel="txtTooltip" title="107 numeric characters" data-toggle="tooltip" data-placement="top">
                                </div>
                            </div>

                            <div class="row tab-row hidden" id="editMagstripeSelectGroup3">
                                <div class="col-xs-3"><label for="magstripeTrack3">Track 3</label></div>
                                <div class="col-xs-9">
                                    <div class="input-group" role="group">
                                        <select class="form-control" id="magstripeTrack3">
                                            <option value="-1" selected></option>
                                        </select>

                                        <div class="input-group-addon var">
                                            <i class="fa fa-plus"></i> <i class="fa fa-pencil"></i> <i class="fa fa-remove"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="row tab-row hidden" id="editMagstripeAddGroup3">
                                <div class="col-xs-7" style="padding-right: 0; margin-right: 0">
                                    <input type="text" class="form-control inputVar" data-type="track3" placeholder="Variable Name">
                                </div>

                                <div class="col-xs-5" style="padding-left: 0; margin-left: 0">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success saveVar">
                                            Save
                                        </button>
                                        <button type="button" class="btn btn-danger cancelVar">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-xs-5">
                            <div class="row tab-row">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-default active" id="editMagstripeFixed1">Fixed</button>
                                    <button class="btn btn-default" id="editMagstripeVariable1">Variable</button>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-default active" id="editMagstripeFixed2">Fixed</button>
                                    <button class="btn btn-default" id="editMagstripeVariable2">Variable</button>
                                </div>
                            </div>

                            <div class="row tab-row">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-default active" id="editMagstripeFixed3">Fixed</button>
                                    <button class="btn btn-default" id="editMagstripeVariable3">Variable</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </form>
                </div>

                <!-- TAB VIEW -->
                <div class="col-xs-12 tab hidden" id="tab-view">
                    <div class="row">
                        <div class="col-xs-6">

                            <div class="row tab-row">
                                <div class="col-xs-12">
                                    <label>Grid Size <span id="gridSizeVal">10px</span>: <input style="width: 210px" type="range" id="editGridSize" value="10" min="10" max="50"></label>
                                </div>

                                <div class="col-xs-9">
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="gridShow"> Show the grid
                                        </label>
                                        <br>
                                        <label>
                                            <input type="checkbox" id="gridSnap" checked> Snap to the grid
                                        </label>
                                        <br>
                                        <label style="padding-left:0">
                                            <select class="selectMetric" style="margin-right:5px;">
                                                <option value="px" selected>px</option>
                                                <option value="mm">mm</option>
                                                <option value="in">in</option>
                                            </select>
                                            Metric
                                        </label>
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>


            </div>

            <div class="row" style="background-color: #ccc">
                <div class="sideButtons">
                    <div class="btn-group leftSideButtons" role="group">
                        <button class="btn btn-default" id="undo" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Undo"><i class="fa fa-reply"></i></button>
                        <button class="btn btn-default" id="redo" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Redo"><i class="fa fa-share"></i></button>

                        <button class="btn btn-default" id="copy" disabled="disabled" style="margin-left:20px" data-toggle="tooltip" data-placement="bottom" title="Copy"><i class="fa fa-copy"></i></button>
                        <button class="btn btn-default" id="cut" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Cut"><i class="fa fa-cut"></i></button>
                        <button class="btn btn-default" id="paste" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Paste"><i class="fa fa-paste"></i></button>
                        <button class="btn btn-default" id="remove" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Delete"><i class="fa fa-remove"></i></button>

                        <button class="btn btn-default" id="zoomOut" disabled="disabled" style="margin-left:20px" data-toggle="tooltip" data-placement="bottom" title="Zoom Out"><i class="fa fa-search-minus"></i></button>
                        <button class="btn btn-default" id="zoomIn" data-toggle="tooltip" data-placement="bottom" title="Zoom In"><i class="fa fa-search-plus"></i></button>
                        <button class="btn btn-default" id="reset" data-toggle="tooltip" data-placement="bottom" title="Reset"><i class="fa fa-repeat"></i></button>
                        <button class="btn btn-default" id="moveCanvas" disabled="disabled" data-toggle="tooltip" data-placement="bottom" title="Grab Tool"><i class="fa fa-hand-grab-o"></i></button>

                        <button class="btn btn-default" id="objectCenter" disabled="disabled" style="margin-left:20px" data-toggle="tooltip" data-placement="bottom" title="Center Object"><i class="fa fa-align-center"></i></button>
                    </div>

                    <div class="btn-group pull-right" role="group">
                        <button class="btn btn-default active" id="sideFront">Front</button>
                        <button class="btn btn-default" id="sideBack">Back</button>
                    </div>
                </div>
            </div>

            <div class="row" id="workArea"> <!-- Work Area -->
                <canvas id="c"></canvas>

                <div id="canvasLoading" class="hidden"><i class="fa fa-spinner fa-5x fa-pulse"></i></div>

                <div id="tip"></div>
            </div>
        </div>

    </div>

    <div class="row pull-right" style="padding-top:12px">
        <!--<button type="button" class="btn btn-default" style="width:150px;" id="menuTemplateNew" disabled>New Template</button>-->
        <button type="button" class="btn btn-default" style="width:150px;" id="menuTemplateNew" data-toggle="modal" data-target="#modalConfirmNewTemplate" disabled>New Template</button>
        <button type="button" class="btn btn-default" style="width:130px;" id="menuTemplateSave" disabled>Save</button>
        <button type="button" class="btn btn-default" style="width:140px;" id="menuTemplateSaveAs" data-toggle="modal" data-target="#modalSaveAsTemplate" disabled>Save As...</button>
        <button type="button" class="btn btn-default" style="width:150px;" id="menuTemplateLoad" data-toggle="modal" data-target="#modalLoadTemplate" disabled>Load Template</button>
        <button type="button" class="btn btn-default" style="width:150px;" id="menuListOfVariables" data-toggle="modal" data-target="#modalListOfVariables" disabled>List of Variables</button>
        <button type="button" class="btn btn-default" style="width:150px;" id="menuPreview" disabled>Preview</button>
    </div>
</div>

<div class="container hidden" style="padding-top:40px;">
    <div class="row">
        <div class="col-xs-8">
            <h4>Canvas Data:</h4>
            <textarea id="jsonOutput" style="width:600px; height:200px;"></textarea><br>
            <button type="button" class="btn btn-default" id="saveJSON"><i class="fa fa-refresh"></i>  Refresh JSON</button>
            <button type="button" class="btn btn-default" id="loadJSON">Load JSON</button>

            <h4>Other Side JSON:</h4>
            <textarea id="jsonOutputOtherSide" style="width:600px; height:200px;"></textarea><br>
            <button type="button" class="btn btn-default" id="saveJSONotherSide"><i class="fa fa-refresh"></i>  Refresh JSON</button>
        </div>
        <div class="col-xs-4">
            <div id="testTemplateData">
                Organization ID:    5<br>
                Template ID:        -1<br>
                Template Name:      -
            </div>
            <!--
            Card Data:
            <div id="cardData">

            </div>

            Template Fields:
            <div id="templateFields">

            </div>-->

            <!--History:
            <div id="history">

            </div> -->

            <div style="padding-top:20px;"><input type="text" class="form-control" id="loadTestTemplateOrganization" value="2"></div>
            <div><input type="text" class="form-control" id="loadTestTemplateID" value="10056"></div>
            <div><button type="button" class="btn btn-default" id="loadTestTemplate">Load template</button></div>
        </div>
    </div>

    <div class="row" style="padding-top:20px;">
        <div class="col-xs-12">
            <h4><i class="fa fa-refresh" id="objectsTableUpdate" title="Refresh"></i>  Full list of objects:</h4>

            <table class="table table-hover" id="objectsTable">
                <thead>
                <tr>
                    <th style="width:60px">#</th>
                    <th style="width:100px">Type</th>
                    <th>Data</th>
                    <th style="width:100px">Delete</th>
                </tr>
                </thead>

                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <h4><i class="fa fa-refresh" id="templateFieldsTableUpdate" title="Refresh"></i>  Template Fields:</h4>
            <table class="table table-hover" id="templateFieldsTable">
                <thead>
                <tr>
                    <th style="width:60px">#</th>
                    <th style="width:100px">Type</th>
                    <th>Data</th>
                    <th style="width:100px">Delete</th>
                </tr>
                </thead>

                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <h4><i class="fa fa-refresh" id="cardDataTableUpdate" title="Refresh"></i>  Card Data:</h4>
            <table class="table table-hover" id="cardDataTable">
                <thead>
                <tr>
                    <th style="width:60px">#</th>
                    <th style="width:100px">Type</th>
                    <th>Data</th>
                    <th style="width:100px">Delete</th>
                </tr>
                </thead>

                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-6">
            <h4>Template Fields JSON:</h4>
            <textarea id="jsonTemplateFields" style="width:100%; height:200px;"></textarea>
            <br>
            <button type="button" class="btn btn-default" id="saveJSONTemplateFields"><i class="fa fa-refresh"></i>  Refresh JSON</button>
            <button type="button" class="btn btn-default" id="loadJSONTemplateFields">Save</button>
        </div>

        <div class="col-xs-6">
            <h4>Card Data JSON:</h4>
            <textarea id="jsonCardData" style="width:100%; height:200px;"></textarea>
            <br>
            <button type="button" class="btn btn-default" id="saveJSONCardData"><i class="fa fa-refresh"></i>  Refresh JSON</button>
            <button type="button" class="btn btn-default" id="loadJSONCardData">Save</button>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- Backgrounds -->
<div class="modal fade" id="modalSelectBG" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Select Background</h4>
            </div>

            <div class="modal-body">
                <div class="row">

                    <div class="col-xs-5" style="height:495px; overflow: auto">
                        <div class="imageListModal" id="modalSelectBGImageList">
                        </div>
                    </div>

                    <div class="col-xs-7">
                        <div class="responsive-container" style="width: 488px; height: 495px;">
                            <div class="dummy"></div>

                            <div class="img-container">
                                <div class="centerer"></div>
                                <img id="modalSelectBGPreview" alt="" />
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <form id="modalSelectBGUploadForm" method="post" enctype="multipart/form-data" action="" class="hidden">
                    <input type="file" name="card_template[images][]" id="modalSelectBGUploadInput">
                </form>
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:100px">Close</button>
                <button type="button" class="btn btn-primary" id="modalSelectBGUpload" style="width:120px"><i class="fa fa-cloud-upload" style="padding-right:5px"></i>Upload</button>
                <button type="button" class="btn btn-success" id="modalSelectBGSelect" style="width:120px" disabled="disabled">Select</button>
            </div>
        </div>
    </div>
</div>

<!-- Images -->
<div class="modal fade" id="modalSelectImage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Select Image</h4>
            </div>

            <div class="modal-body">
                <div class="row">

                    <div class="col-xs-5" style="height:495px; overflow: auto">
                        <div class="imageListModal" id="modalSelectImageList">
                        </div>
                    </div>

                    <div class="col-xs-7">
                        <div class="responsive-container" style="width: 488px; height: 495px;">
                            <div class="dummy"></div>

                            <div class="img-container">
                                <div class="centerer"></div>
                                <img id="modalSelectImagePreview" alt="" />
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <form id="modalSelectImageUploadForm" method="post" enctype="multipart/form-data" action="" class="hidden">
                    <input type="file" name="card_template[images][]" id="modalSelectImageUploadInput">
                </form>
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:100px">Close</button>
                <button type="button" class="btn btn-primary" id="modalSelectImageUpload" style="width:120px"><i class="fa fa-cloud-upload" style="padding-right:5px"></i>Upload</button>
                <button type="button" class="btn btn-success" id="modalSelectImageSelect" style="width:120px" disabled="disabled">Select</button>
            </div>
        </div>
    </div>
</div>

<!-- Load Template -->
<div class="modal fade" id="modalLoadTemplate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Load Template</h4>
            </div>

            <div class="modal-body">
                <div class="row" style="padding-bottom:20px">
                    <div class="col-xs-2">
                        <label for="modalLoadTemplateOrganization">Organization</label>
                    </div>
                    <div class="col-xs-10">
                        <select class="form-control organizationList selectpicker" id="modalLoadTemplateOrganization" data-live-search="true">
                        </select>
                    </div>
                </div>

                <div class="row" style="padding-bottom:20px">
                    <div class="col-xs-2">
                        <label for="modalLoadTemplateTemplate">Template</label>
                    </div>
                    <div class="col-xs-10">
                        <select class="form-control selectpicker" id="modalLoadTemplateTemplate" data-live-search="true">
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-6">
                        <img class="previewFront img-responsive" src="">
                    </div>
                    <div class="col-xs-6">
                        <img class="previewBack img-responsive" src="">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-danger" id="modalLoadTemplateDelete" data-toggle="modal" data-target="#modalConfirmDeletion" style="width:120px" disabled="disabled"><i class="fa fa-trash"></i> Delete</button>
                <button type="button" class="btn btn-success" id="modalLoadTemplateSelect" style="width:120px" disabled="disabled">Load</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm new template -->
<div class="modal fade" id="modalConfirmNewTemplate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">New Template</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        Are you sure you want to create a new template? All changes to the current template will be lost
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-danger" id="modalConfirmNewTemplateNew" style="width:160px">New Template</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Deletion -->
<div class="modal fade" id="modalConfirmDeletion" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Delete</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        Are you sure you want to delete the "<strong><span id="modalConfirmDeletionName"></span></strong>" template?
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-danger" id="modalConfirmDeletionDelete" style="width:120px"><i class="fa fa-trash"></i> Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Save Template As -->
<div class="modal fade" id="modalSaveAsTemplate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Save Template As</h4>
            </div>

            <div class="modal-body">
                <div class="row hidden" id="modalSaveAsTemplateWarning">
                    <div class="alert alert-warning" role="alert">Please save the template before uploading images!</div>
                </div>

                <div class="row" style="padding-bottom:20px">
                    <div class="col-xs-2">
                        <label for="modalSaveAsOrganization">Organization</label>
                    </div>
                    <div class="col-xs-10">
                        <select class="form-control organizationList selectpicker" id="modalSaveAsOrganization" data-live-search="true">
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-2">
                        <label for="modalSaveAsTemplateName">Name</label>
                    </div>
                    <div class="col-xs-10">
                        <input type="text" class="form-control" id="modalSaveAsTemplateName" placeholder="Enter template's name">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-success" id="modalSaveAsTemplateSave" style="width:120px" disabled="disabled">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- LIST OF VARIABLES -->
<div class="modal fade" id="modalListOfVariables" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">List of variables</h4>
            </div>

            <div id="modalListOfVariablesContent">
                <table class="table table-hover sorted_table">
                    <thead>
                        <tr>
                            <th style="width:60px">#</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Requirements</th>
                        </tr>
                    </thead>

                    <tbody>

                    </tbody>
                </table>
            </div>
            <div id="modalListOfVariablesRepeatingVariables" class="hidden">
                *duplicated variables will be automatically removed
            </div>

            <div class="modal-header">
                <h4 class="modal-title">Add new variable</h4>
            </div>
            <div class="row modal-body" id="modalListOfVariablesAddNew">
                <div class="col-xs-6">
                    <input type="text" class="form-control" placeholder="Field Name">
                </div>
                <div class="col-xs-4">
                    <select class="form-control">
                        <option>Text</option>
                        <option>Placeholder</option>
                    </select>
                </div>
                <div class="col-xs-2">
                    <button class="btn btn-success">Add</button>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" style="width:120px">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT VARIABLE -->
<div class="modal fade" id="modalEditVariable" tabindex="-1" role="dialog"  aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Edit Variable</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-4">
                        <label for="editVariableType">Type</label>
                    </div>
                    <div class="col-xs-8">
                        <select class="form-control" id="editVariableType">
                            <option value="text" selected>Text</option>
                            <option value="checkbox">Checkbox</option>
                            <option value="selectbox">Selectbox</option>
                            <!--<option value="radiobox">Radiobox</option>-->
                            <option value="concatenated">Concatenated</option>
                            <option value="calculated_date">Calculated Date</option>
                            <!--<option value="placeholder">Placeholder</option>-->
                            <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                            <option value="qrcode">QR Code</option>
                            <option value="barcode">Barcode</option>
                            <option value="track1">Magstripe (track 1)</option>
                            <option value="track2">Magstripe (track 2)</option>
                            <option value="track3">Magstripe (track 3)</option>
                        </select>
                    </div>
                </div>

                <div class="row editVariableCheckbox hidden">
                    <div class="col-xs-4">
                        <label for="editVariableCheckboxChecked">Checked</label>
                    </div>
                    <div class="col-xs-8">
                        <input type="text" value="" class="form-control" id="editVariableCheckboxChecked">
                    </div>

                    <div class="col-xs-4">
                        <label for="editVariableCheckboxUnchecked">Unchecked</label>
                    </div>
                    <div class="col-xs-8">
                        <input type="text" value="" class="form-control" id="editVariableCheckboxUnchecked">
                    </div>
                </div>

                <div class="row editVariableSelectbox hidden"> <!-- same as radiobox -->
                    <div class="col-xs-4"></div>
                    <div class="col-xs-8"><button class="btn btn-default" id="editVariableSelectboxAdd">Add an option</button></div>
                </div>

                <div class="row editVariableConcatenated hidden">
                    <div class="col-xs-4">
                        <label>Concatenation</label>
                    </div>
                    <div class="col-xs-8">
                        <input type="text" class="form-control" value="" id="editVariableConcatenation">
                        <span class="text-danger hidden">The concatenation might have unnecessary spaces</span>
                    </div>

                    <div class="col-xs-4">
                        <label>Field 1</label>
                    </div>
                    <div class="col-xs-8">
                        <select class="form-control editVariableConcatenatedField">
                            <option value="FirstName" selected>First Name</option>
                            <option value="LastName">Last Name</option>
                        </select>
                    </div>

                    <div class="col-xs-4">
                        <label>Field 2</label>
                    </div>
                    <div class="col-xs-8">
                        <select class="form-control editVariableConcatenatedField">
                            <option value="0" selected>First Name</option>
                            <option value="1">Last Name</option>
                        </select>
                    </div>

                    <div class="col-xs-4"></div>
                    <div class="col-xs-8">
                        <button class="btn btn-default" id="editVariableConcatenatedAdd">Add existing field</button>
                        <button class="btn btn-default" id="editVariableConcatenatedAddNew">Add new field</button>
                    </div>
                </div>

                <div class="row editVariableCalculatedDate hidden">
                    <div class="col-xs-4">
                        <label>Format</label>
                    </div>
                    <div class="col-xs-8">
                        <input type="text" value="MM-DD-YYYY" class="form-control" id="editVariableCalculatedDateFormat">
                    </div>

                    <div class="col-xs-4">
                        <label>Units</label>
                    </div>
                    <div class="col-xs-8">
                        <select class="form-control" id="editVariableCalculatedDateUnits">
                            <option value="day">Day</option>
                            <option value="month" selected>Month</option>
                            <option value="year">Year</option>
                        </select>
                    </div>

                    <div class="col-xs-4">
                        <label>Plus</label>
                    </div>
                    <div class="col-xs-8">
                        <input type="text" value="0" class="form-control" id="editVariableCalculatedDatePlus">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-success" id="modalEditVariableSave" data-dismiss="modal" style="width:120px">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- CONFIRM DELETING A VARIABLE -->
<div class="modal fade" id="modalDeleteVariable" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Delete</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div id="modalDeleteVariableDescription" class="col-xs-12"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-danger" id="modalDeleteVariableDelete" data-dismiss="modal" style="width:120px">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Copying Of The Side -->
<div class="modal fade" id="modalCopySide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Copy this side</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        The other side isn't empty. If you proceed, everything on the other side will be lost. Are you sure you want to continue?
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-success" id="modalCopySideCopy" data-dismiss="modal" style="width:120px">Copy this side</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT TEMPLATE NAME -->
<div class="modal fade" id="modalEditName" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Edit Template Name</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12">
                        <input type="text" class="form-control" id="modalEditNameTitle" maxlength="100">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Cancel</button>
                <button type="button" class="btn btn-success" id="modalEditNameSave" style="width:120px">Save</button>
                <i class="fa fa-spinner fa-pulse fa-2x hidden"></i>
            </div>
        </div>
    </div>
</div>

<!-- BARCODE PREVIEW -->
<div class="modal fade" id="modalBarcodePreview" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Barcode Preview</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-2">
                        <label>Preview Value</label>
                    </div>
                    <div class="col-xs-5">
                        <input type="text" value="0123456789" class="form-control" id="modalBarcodePreviewValue">
                    </div>
                    <div class="col-xs-3">
                        <button type="button" class="btn btn-success" id="modalBarcodePreviewUpdate">Update Preview</button>
                    </div>
                </div>

                <div class="row hidden" id="modalBarcodePreviewWarning">
                    <div class="col-xs-12">
                        <span class="text-danger">This barcode type isn't supported by the preview system. Only CODE39 and CODE128 previews can be rendered. This preview image was generated using CODE39:</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-12">
                        <img id="modalBarcodePreviewImage" class="img-responsive previewBarcode hidden">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- WARNING -->
<div class="modal fade" id="modalWarning" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title text-danger">Warning!</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-xs-12" id="warning">
                        Warning!
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" style="width:120px">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- IMAGES -->
<div id="images" class="hidden">
    <img src="img/polka-dot.jpg" id="img-polka-dot">
    <img src="img/var-img.png" id="img-var-img">
    <!--Icon made by <a href="http://www.flaticon.com/authors/simpleicon" title="SimpleIcon">SimpleIcon</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a> -->
    <img src="img/barcodes/img-barcode-code25.png" id="img-barcode-code25">
    <img src="img/barcodes/img-barcode-code39.png" id="img-barcode-code39">
    <img src="img/barcodes/img-barcode-code128.png" id="img-barcode-code128">
    <img src="img/barcodes/img-barcode-qr.png" id="img-barcode-qr">
</div>

<div class="hidden">
    <canvas id="gridCanvas" width="727" height="500"></canvas>
</div>

<script>
    // default values for the test template
    var leftPadding     = 135,
        topPadding      = 106,
        cardWidth       = 457,
        cardHeight      = 288,
        toolSelected    = "toolDefault",
        gridSize        = 10,
        gridDraw        = false,
        gridSnapTo      = true,
        metric          = "px",
        orientation     = "landscape",
        sides           = "double",
        colors          = "colorblack",
        slotPunch       = "none",
        letter          = "none",
        copiedObjects   = [],
        copiedObject,
        copiedGroup,
        cardSides       = [],
        varTextFields   = [],
        varImageFields  = [],
        varBarcodeFields= [],
        cardTypes       = [],
        cardData        = [],
        specialHandlings= [],
        shiftPressed    = false,
        ctrlPressed     = false,
        imagesToUpload  = 0;

    var templateData = {
        organizationID: -1,
        templateID:     -1,
        templateName:   "New Template",
        cardTypeID:     1,
        template_fields: []
    };

    var cleanTemplate = '{"objects":[],"background":"","backgroundImage":{"type":"image","originX":"left","originY":"top","left":0,"top":0,"width":457,"height":288,"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"data:image/gif;base64,R0lGODlhAQABAPAAAP///////yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"}}';

    // default template for test purposes
    cardSides.push({
        "json":         cleanTemplate,
        "topPadding":   topPadding,
        "leftPadding":  leftPadding,
        "orientation":  orientation,
        "isSelected":   true
    },{
        "json":         '',
        "topPadding":   topPadding,
        "leftPadding":  leftPadding,
        "orientation":  orientation,
        "isSelected":   false
    });

    //////////////////////////////// CLASS EXTENSIONS ////////////////////////////////

    // New IText
    // FIX COPY PASTE FOR GROUPS

    // Image
    // I've edited the Image object in the fabric.js and added:
    // strokeWidth = 0
    // strokeWidthNew || 0
    // strokeShow || false
    // cornerRadius || 0
    // and also changed _render

    // Group objects with shift+click
    fabric.util.object.extend(fabric.Canvas.prototype, {
        _updateSelection: function() {
            var canvas = this;

            setTimeout(function() {
                var group = canvas.getActiveGroup();
                if(group) { // if more than 1 selected object
                    $('.btn-layer').removeClass('active');
                    var objects = canvas.getObjects();

                    group.forEachObject(function(object){
                        // make layers bold
                        $('#layer'+objects.indexOf(object)).addClass('active');
                    });
                }
            }, 100);
        },
        _shouldGroup: function (e, target) {
            var activeObject = this.getActiveObject();
            this._updateSelection();

            return shiftPressed &&
            (this.getActiveGroup() || (activeObject && activeObject !== target))
            && this.selection;
        },
        _shouldClearSelection: function (e, target) {
            var activeGroup = this.getActiveGroup(),
                activeObject = this.getActiveObject();

            return (
            !target
            ||
            (target &&
            activeGroup &&
            !activeGroup.contains(target) &&
            activeGroup !== target &&
            !shiftPressed)
            ||
            (target && !target.evented)
            ||
            (target &&
            !target.selectable &&
            activeObject &&
            activeObject !== target)
            );
        }
    });

    // Canvas settings
    fabric.Object.prototype.set({
        transparentCorners: false,
        cornerColor: 'rgba(102,153,255,0.5)',
        cornerSize: 10,
        borderScaleFactor: 0.5
    });

    ////////////////////////////////////////////////////////////////////////////

    $( document ).ready(function() {
        // plugins
        $('.fa-eyedropper').each(function(){
            var className = $(this).parent().attr('id').replace("Picker", "");
            $('.'+className).colorpicker();
        });
        $('.frontSideBG').colorpicker();
        $('.colorpickerBlack, .colorpickerWhite').on('click', function(){
            var color = '#000000';
            if($(this).hasClass('colorpickerWhite')) color = '#ffffff';
            $(this).parent().parent().parent().find('.colorpicker-element').colorpicker('setValue', color);
        });

        $('.buttonWithTooltip, .btn-tool, .leftSideButtons button, #tab-align button, input[rel="txtTooltip"]').tooltip();

        $('.selectpicker').selectpicker();

        new Dropzone(document.body, { // Make the whole body a dropzone
            url: config.apiURL+'card_templates/'+templateData.templateID+'/upload?organization_id='+templateData.organizationID, // Set the url
            clickable: false,
            createImageThumbnails: false,
            paramName: 'card_template[images][]',

            init: function() {
                this.on("processing", function(file) {
                    loadingCanvas(true);
                    this.options.url = config.apiURL+'card_templates/'+templateData.templateID+'/upload?organization_id='+templateData.organizationID;

                    if(templateData.templateID==-1 || templateData.organizationID == -1) {
                        loadingCanvas(false);
                        $('#menuTemplateSaveAs').trigger("click");
                        $('#modalSaveAsTemplateWarning').removeClass('hidden');
                        this.removeFile(file);
                    }
                });

                this.on("success", function(file, data) {
                    $('#imageUploadCover').hide();
                    $.ajax({
                        type: 'GET',
                        url: config.apiURL+'card_templates/'+templateData.templateID+'?organization_id='+templateData.organizationID,
                        success: function (data) {
                            fabric.Image.fromURL(data.images[0].url, function(img) {
                                img.left = leftPadding;
                                img.top = topPadding;
                                img.lockUniScaling = true;

                                canvas.add(img);
                                canvas.renderAll();

                                resizeHugeObject(newestObject());

                                addSnapshotToHistory();
                                selectDefaultTool();
                                updateImageList();
                                //selectNewestObject();
                                loadingCanvas(false);
                            }, {crossOrigin: '*'});
                        },
                        error: function (data) {
                            loadingCanvas(false);
                            alert('error');
                        }
                    });
                });

                this.on("error", function(file) {
                    $('#imageUploadCover').hide();
                    loadingCanvas(false);
                });
            }
        });

        function resizeHugeObject(object) {
            if(object.width>cardWidth || object.height>cardHeight) {
                if(cardWidth>cardHeight)
                    object.scaleToHeight(cardHeight);
                else
                    object.scaleToWidth(cardWidth);

                object.left = leftPadding;
                object.top = topPadding;
                object.setCoords();
                canvas.renderAll();
            }
        }

        // Sortable tables
        $('.sorted_table').sortable({
            containerSelector: 'table',
            itemPath: '> tbody',
            itemSelector: 'tr',
            placeholder: '<tr class="placeholder"/>',
            onDrop: templateFieldsReorder
        });

        function variableTypeNameToShort(type) {
            switch(type) {
                case "Text":
                    type = "text";
                    break;
                case "Checkbox":
                    type = "checkbox";
                    break;
                case "Selectbox":
                    type = "selectbox";
                    break;
                case "Radiobox":
                    type = "radiobox";
                    break;
                case "Concatenated":
                    type = "concatenated";
                    break;
                case "Calculated Date":
                    type = "calculated_date";
                    break;
                case "Image":
                    type = "image";
                    break;
                case "QR Code":
                    type = "qrcode";
                    break;
                case "Barcode":
                    type = "barcode";
                    break;
                case "Magstripe (Track 1)":
                    type = "track1";
                    break;
                case "Magstripe (Track 2)":
                    type = "track2";
                    break;
                case "Magstripe (Track 3)":
                    type = "track3";
                    break;
                case "PlaceHolder":
                    type = "placeholder";
                    break;
                default:
                        alert("Variable type error!");
                    break;
            }

            return type;
        }

        function templateFieldsReorder() {
            $('.sorted_table').sortable("refresh");

            var first = true,
                templateFieldsNewOrder = [];

            $('#modalListOfVariablesContent tr').each(function() {
                $(this).removeClass("dragged");
                if(first) {
                    first = false;
                    return true;
                }

                var label = $(this).children().eq(1).text(),
                    type = $(this).children().eq(2).text();

                //if(type!="Image" && type!="PlaceHolder") type = type.substring(2);
                if(type!="Image") type = type.substring(3);

                type = variableTypeNameToShort(type);

                for(i=0; i<templateData.template_fields.length; i++) {
                    if(templateData.template_fields[i].type == type && ((templateData.template_fields[i].label && templateData.template_fields[i].label == label) || templateData.template_fields[i].token == label)) {
                        templateFieldsNewOrder.push(templateData.template_fields[i]);
                        break;
                    }
                }
            });

            templateData.template_fields = templateFieldsNewOrder;
        }

        // Fonts
        var fonts = [];

        function loadFonts(organizationID) {
            if(organizationID == -1) {
                updateFonts();
                return;
            }

            $.ajax({
                type: 'GET',
                url: config.apiURL+'organizations/'+organizationID+'/fonts',
                success: function (data) {
                    updateFonts(data);
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function updateFonts(data) {
            if(data) fonts = data;

            for(i=0; i<defaultFonts.length; i++)
            {
                var isUsed = false

                for(z=0; z<fonts.length; z++) {
                    if(fonts[z].name == defaultFonts[i].name)
                        isUsed = true;
                }

                if(!isUsed)
                    fonts.push(defaultFonts[i]);
            }

            fonts.sort(dynamicSort("name"));

            for(var i=0; i<fonts.length; i++) {
                if($.fontAvailable(fonts[i].name))
                    continue;

                if(fonts[i].url && fonts[i].url != "") {
                    $('<style type="text/css">@import url("' + fonts[i].url + '")</style>')
                            .appendTo("head");
                }
                else if(fonts[i].files && fonts[i].files.length > 0) {
                    for(var z=0; z<fonts[i].files.length; z++) { // need to update this later so that eot is always first
                        $('<style type="text/css">@font-face {font-family: '+fonts[i].name+'; src: url('+fonts[i].files[z]+');}</style>')
                                .appendTo("head");
                    }
                }
            }

            var fontDropdown = $('#editTextFont').next('.dropdown-menu'),
                fontVarDropdown = $('#editVarTextFont').next('.dropdown-menu'),
                fontHTML = "";

            for(var i=0; i<fonts.length; i++) {
                fontHTML += '<li role="presentation"><a role="menuitem" tabindex="-1" href="#" class="editTextFont"  style="font-family: \'' + fonts[i].name + '\'">'+fonts[i].name+'</a></li>';
            }

            fontDropdown.html(fontHTML);
            fontVarDropdown.html(fontHTML);
        }

        function dynamicSort(property) {
            var sortOrder = 1;
            if(property[0] === "-") {
                sortOrder = -1;
                property = property.substr(1);
            }
            return function (a,b) {
                var result = (a[property].toLowerCase() < b[property].toLowerCase()) ? -1 : (a[property].toLowerCase() > b[property].toLowerCase()) ? 1 : 0;
                return result * sortOrder;
            }
        }

        // Keys
        $('html').keyup(function(e){
            if(!hotkeysAllowed()) return;

            if(e.keyCode == 46) { // delete
                removeSelectedObjects();
            }
            else if(e.keyCode == 67 && ctrlPressed) { // ctrl+c
                copy();
            }
            else if(e.keyCode == 88 && ctrlPressed) { // ctrl+x
                cut();
            }
            else if(e.keyCode == 86 && ctrlPressed) { // ctrl+v
                paste();
            }
            else if(e.keyCode == 90 && ctrlPressed) { // ctrl+z
                undo();
            }
            else if(e.keyCode == 89 && ctrlPressed) { // ctrl+y
                redo();
            }
            else if(e.keyCode == 84 && shiftPressed) {
                var target = $('#jsonOutput').parent().parent().parent();

                if(target.hasClass('hidden'))
                    target.removeClass('hidden');
                else
                    target.addClass('hidden');
            } // shift+t
            else if(e.keyCode == 187) { // +
                zoomIn();
            }
            else if(e.keyCode == 189) { // -
                zoomOut();
            }
            else if(e.keyCode == 32) { // space up
                grabMode(false);
            }
            else if(e.keyCode == 67 && shiftPressed) { // shift+c to console log the canvas json
                console.log(JSON.stringify(canvas));
            }
        });

        $('html').keydown(function(e){
            if(!hotkeysAllowed()) return;

            if(e.keyCode == 32) { // space down
                e.preventDefault();
                grabMode(true);
            }
            else if(e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40) { // arrow keys
                e.preventDefault();
                moveObjectOnArrowKeyPress(e.keyCode);
            }
        });

        $(window).keydown(function(evt) {
            if (evt.which == 17) // ctrl
                ctrlPressed = true;
            else if (evt.which == 16) // shift
                shiftPressed = true;
        }).keyup(function(evt) {
            if (evt.which == 17) // ctrl
                ctrlPressed = false;
            else if (evt.which == 16) // shift
                shiftPressed = false;
        });

        // Copy/Paste
        $('#copy').on('click', function() {
            copy();
        });

        $('#cut').on('click', function() {
            cut();
        });

        $('#paste').on('click', function() {
            paste();
        });

        $('#remove').on('click', function() {
            removeSelectedObjects();
        });

        function copy(isCut) {
            copiedObjects = [];

            if(canvas.getActiveGroup()){
                var ids = [];

                for(var i in canvas.getActiveGroup().objects){
                    var id = canvas.getObjects().indexOf(canvas.getActiveGroup().objects[i]);
                    ids.push(id);
                }

                canvas.deactivateAll();

                var z = 0;
                for(i=0; i<ids.length; i++) {
                    if(canvas.item(ids[i]).type == "static-text") continue;

                    var object = fabric.util.object.clone(canvas.item(ids[i]));
                    object.set("top", object.top+5);
                    object.set("left", object.left+5);
                    copiedObjects[z] = object;
                    z++;

                    if(isTextRect(object)) {
                        var textObj = fabric.util.object.clone(getTextByTextID(object.textID));
                        textObj.set("top", textObj.top+5);
                        textObj.set("left", textObj.left+5);

                        copiedObjects[z] = textObj;
                        z++;
                    }
                }

                if(isCut) {
                    for(i=0; i<ids.length; i++) {
                        canvas.remove(canvas.item(ids[i]));
                    }
                }
            }
            else if(canvas.getActiveObject()){
                var object = fabric.util.object.clone(canvas.getActiveObject());
                object.set("top", object.top+5);
                object.set("left", object.left+5);

                if(isTextRect(object)) {
                    var textObj = fabric.util.object.clone(getTextByTextID(object.textID));
                    textObj.set("top", textObj.top+5);
                    textObj.set("left", textObj.left+5);

                    copiedObjects[0] = object;
                    copiedObjects[1] = textObj;
                }
                else {
                    copiedObject = object;
                    copiedObjects = new Array();
                }

                if (isCut) {
                    canvas.remove(canvas.getActiveObject());
                }
            }
            else {
                return;
            }

            $('#paste').prop('disabled', false);
        }

        function cut() {
            copy(true);
        }

        function paste() {
            canvas.deactivateAll();
            canvas.forEachObject(function(object){
                if(isText(object)) updateTextObject(object);
            });

            var objects = [];

            if(copiedObjects.length > 0) {
                var items = copiedObjects;
                var newTextID = "",
                    generateNewTextID = true;

                for(var i = 0; i < items.length; i++) {
                    if(isText(items[i]) || isTextRect(items[i])){
                        if(generateNewTextID) {
                            newTextID = generateTextID();
                            generateNewTextID = false;
                        }
                        else
                            generateNewTextID = true;

                        items[i].textID = newTextID;
                    }

                    if(isText(items[i]) && items[i].variable) {
                        templateData.template_fields.push({
                            type: "text",
                            token: removeUnsupportedCharacters(items[i].text),
                            label: items[i].text
                        });
                    }
                    else if(items[i].type == "variable-image") {
                        templateData.template_fields.push({
                            "type":         "image",
                            "dimensions":   {width: items[i].width, height: items[i].height},
                            "token":        removeUnsupportedCharacters(items[i].fieldName),
                            "label":        items[i].fieldName
                        });
                    }

                    canvas.add(fabric.util.object.clone(items[i]));

                    var addedObj = newestObject();

                    if(addedObj.type == "image" || addedObj.type == "variable-image") {
                        addedObj.filters = jQuery.extend([], addedObj.filters);
                    }

                    objects.push(addedObj);
                }

                canvas.renderAll();

                var group = new fabric.Group(objects.reverse(), {
                    canvas: canvas
                });
                group.addWithUpdate();
                canvas.setActiveGroup(group);
                group.saveCoords();
                group.pasted = true;
                canvas.fire('selection:created', {target: group});
            }
            else if(copiedObject){
                if(copiedObject.type == "variable-image") {
                    templateData.template_fields.push({
                        "type":         "image",
                        "dimensions":   {width: copiedObject.width, height: copiedObject.height},
                        "token":        removeUnsupportedCharacters(copiedObject.name),
                        "label":        copiedObject.name
                    });
                }

                canvas.add(fabric.util.object.clone(copiedObject));

                var addedObj = newestObject();

                if(addedObj.type == "image" || addedObj.type == "variable-image") {
                    addedObj.filters = jQuery.extend([], addedObj.filters);
                }

                canvas.setActiveObject(addedObj);
            }
            canvas.renderAll();
        }

        function removeSelectedObjects() {
            if(canvas.getActiveGroup()){
                canvas.getActiveGroup().forEachObject(function(o){ canvas.remove(o) });
                canvas.discardActiveGroup().renderAll();
                addSnapshotToHistory();
                return;
            }

            var obj = canvas.getActiveObject();
            if(obj && !obj.isEditing && !$('input[type="text"], textarea').is(":focus")) {
                canvas.remove(canvas.getActiveObject());
                addSnapshotToHistory();
            }
        }

        function hotkeysAllowed() {
            if($('input[type=text], textarea').is(":focus") || (canvas.getActiveObject() && canvas.getActiveObject().isEditing)) return false;

            return true;
        }

        $('#objectCenter').on('click', function() {
            if(canvas.getActiveGroup()){
                canvas.getActiveGroup().centerH();
                groupCenterObjects(canvas.getActiveGroup());
                canvas.renderAll();
                return;
            }

            var object = canvas.getActiveObject();

            object.centerH();

            if(isTextRect(object)) {
                recalcTextPosition(object.textID);
            }

            object.setCoords();
            canvas.renderAll();
        });

        // Zoom
        $('#zoomIn').on('click', function() {
            zoomIn();
        });

        $('#zoomOut').on('click', function() {
            zoomOut();
        });

        $('#reset').on('click', function() {
            canvas.viewport.position = new fabric.Point(0,0);
            canvas.setZoom(1);
            checkZoom();
        });

        $('#moveCanvas').on('click', function() {
            if($(this).hasClass('active')) {
                grabMode(false);
            }
            else {
                grabMode(true);
            }

            canvas.renderAll();
        });

        function zoomIn() {
            if($('#zoomIn').prop('disabled')) return;

            canvas.setZoom(canvas.viewport.zoom*1.5);
            checkZoom();
        }

        function zoomOut() {
            if($('#zoomOut').prop('disabled')) return;

            canvas.setZoom(canvas.viewport.zoom/1.5);
            checkZoom();
        }

        function grabMode(grabMode) {
            if(grabMode) {
                selectDefaultTool();
                canvas.isGrabMode = true;
                $('#workArea canvas').addClass('dragCursor');
                $('#moveCanvas').addClass('active');
            }
            else {
                canvas.isGrabMode = false;
                $('#workArea canvas').removeClass('dragCursor');
                $('#moveCanvas').removeClass('active');
            }
        }

        function checkZoom() {
            if(canvas.viewport.zoom>1) {
                $('#zoomOut').prop("disabled", false);
                $('#moveCanvas').prop("disabled", false);
            }
            else {
                grabMode(false);
                canvas.viewport.position = new fabric.Point(0,0);
                $('#zoomOut').prop("disabled", true);
                $('#moveCanvas').prop("disabled", true);
            }

            if(canvas.viewport.zoom>4)
                $('#zoomIn').prop("disabled", true);
            else
                $('#zoomIn').prop("disabled", false);

            canvas.renderAll();
        }

        // Serialization
        // Debug
        $('#saveJSON').on("click", function() {
            $("#jsonOutput").val(prepareTemplateForSaving(JSON.stringify(canvas)));
        });

        $('#saveJSONotherSide').on("click", function() {
            $("#jsonOutputOtherSide").val(getUnselectedSide().json);
        });

        $('#loadJSON').on("click", function() {
            loadCanvasFromJSON($("#jsonOutput").val(), true, false, function(){
                grayscaleCanvasIfNeeded();
            });
        });

        // Table of objects
        $('#objectsTableUpdate').on('click', function() {
            updateObjectsTable();
        });

        $(document).on("click", "#objectsTable .fa-remove", function() {
            deleteObjectByID(parseInt($(this).parent().parent().find('td:first').text()));
        });

        function deleteObjectByID(id) {
            var objToDel = false;

            var i = 0;
            canvas.forEachObject(function(obj) {
                if(i==id) objToDel = obj;

                i++;
            });

            if(objToDel) {
                canvas.remove(objToDel);
                canvas.renderAll();
                updateObjectsTable();
                updateTemplateFieldsTable();
                updateCardDataTable();
            }
        }

        function updateObjectsTable() {
            var tbody = '#objectsTable > tbody';

            $(tbody).empty();
            var i = 0;
            canvas.forEachObject(function(obj) {
                var info = JSON.stringify(obj);
                var trClass = "";

                if(obj.name == "embedded_top") trClass='class="darkerRow"';

                $(tbody).append('<tr '+trClass+'><td>'+i+'</td><td>'+obj.type+'</td><td>'+info+'</td><td><i class="fa fa-remove fa-2x"></i></td></tr>');

                i++;
            });
        }

        // Table of template fields
        $('#templateFieldsTableUpdate, #saveJSONTemplateFields').on('click', function() {
            updateTemplateFieldsTable();
        });

        function updateTemplateFieldsTable() {
            var tbody = '#templateFieldsTable > tbody';

            $(tbody).empty();

            for(var i=0; i<templateData.template_fields.length; i++) {
                $(tbody).append('<tr><td>'+i+'</td><td>'+templateData.template_fields[i].type+'</td><td>'+JSON.stringify(templateData.template_fields[i])+'</td><td><i class="fa fa-remove fa-2x"></i></td></tr>');
            }

            $("#jsonTemplateFields").val(JSON.stringify(templateData.template_fields));
        }

        $(document).on("click", "#templateFieldsTable .fa-remove", function(){
            deleteTemplateFieldByID(parseInt($(this).parent().parent().find('td:first').text()));
        });

        function deleteTemplateFieldByID(id) {
            templateData.template_fields.splice(id, 1);
            updateTemplateFieldsTable();
        }

        // Table of card data
        $('#cardDataTableUpdate, #saveJSONCardData').on('click', function() {
            updateCardDataTable();
        });

        function updateCardDataTable() {
            var tbody = '#cardDataTable > tbody';

            $(tbody).empty();

            for(var i=0; i<cardData.length; i++) {
                $(tbody).append('<tr><td>'+i+'</td><td>'+cardData[i].type+'</td><td>'+JSON.stringify(cardData[i])+'</td><td><i class="fa fa-remove fa-2x"></i></td></tr>');
            }

            $("#jsonCardData").val(JSON.stringify(cardData));
        }

        $(document).on("click", "#cardDataTable .fa-remove", function() {
            deleteCardDataByID(parseInt($(this).parent().parent().find('td:first').text()));
        });

        function deleteCardDataByID(id) {
            cardData.splice(id, 1);
            updateCardDataTable();
        }

        // JSON stuff
        $('#loadJSONCardData').on('click', function(){
            cardData = JSON.parse($("#jsonCardData").val());
            updateCardDataTable();
        });

        $('#loadJSONTemplateFields').on('click', function(){
            templateData.template_fields = JSON.parse($("#jsonTemplateFields").val());
            updateTemplateFieldsTable();
        });

        ///////////////////////////////////////////////////////////

        var loadingCanvasCounter = 0;
        function loadCanvasFromJSON(json, targetCanvas, offset, onSuccess) {
            loadingCanvasCounter++;
            offset = offset || false;

            if(targetCanvas === true) {
                offset = true;
                targetCanvas = canvas;
            }
            targetCanvas = targetCanvas || canvas;

            if(json=="") {
                json = generateEmptySide();
            }

            var templateToLoad = prepareTemplateForLoading(json, offset);

            targetCanvas.clear();
            targetCanvas.loadFromJSON(templateToLoad, function(){
                if(targetCanvas == canvas) {
                    checkOverlay(3000);
                    checkOverlay(10000);
                }

                removeCornersFromTextObjects();
                //updateAlignOfAllObjects();
                //resizeAllTextObjects();
                updateCardTabSlotPunch();
                cardDataUpdate();

                updateCustomParameters();

                updateLayerList();

                if(targetCanvas == canvas) {
                    canvas.forEachObject(function(object){
                        if(object.name && object.name=="bg")
                            $('#frontSideTransparency').val(object.opacity*100);
                    });

                    addOverlay();

                    fixImageFieldsDimensions();
                }

                targetCanvas.renderAll();
                loadingCanvasCounter--;

                if(typeof(onSuccess) == "function")
                    onSuccess();
            });

            //console.log(templateToLoad);
        }

        function generateEmptySide() {
            return '{"objects":[],"background":"","backgroundImage":{"type":"image","originX":"left","originY":"top","left":0,"top":0,"width":'+cardWidth+',"height":'+cardHeight+',"fill":"rgb(0,0,0)","stroke":null,"strokeWidth":1,"strokeDashArray":null,"strokeLineCap":"butt","strokeLineJoin":"miter","strokeMiterLimit":10,"scaleX":1,"scaleY":1,"angle":0,"flipX":false,"flipY":false,"opacity":1,"shadow":null,"visible":true,"clipTo":null,"backgroundColor":"","fillRule":"nonzero","globalCompositeOperation":"source-over","src":"data:image/gif;base64,R0lGODlhAQABAPAAAP///////yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==","filters":[],"crossOrigin":"","alignX":"none","alignY":"none","meetOrSlice":"meet"}}';
        }

        function updateCustomParameters() {
            canvas.forEachObject(function(object) {
                if (object.type == "rect" && (object.name == "slotPunch" || object.name == "magStripe")) {
                    object.toObject = (function(toObject) {
                        return function() {
                            return fabric.util.object.extend(toObject.call(this), {
                                name: this.name
                            });
                        };
                    })(object.toObject);
                }
            });
        }

        function updateCardTabSlotPunch() {
            $('#cardSlotPunchNone, #cardSlotPunchLong, #cardSlotPunchShort').removeClass('active');
            $('#cardSlotPunchNone').addClass('active');

            canvas.forEachObject(function(object) {
                if (object.type == "rect" && object.name == "slotPunch") {
                    $('#cardSlotPunchNone').removeClass('active');
                    object.selectable = false;

                    if((object.width > object.height && orientation=="landscape") || (object.width < object.height && orientation=="portrait")) {
                        $('#cardSlotPunchLong').addClass('active');
                    }
                    else {
                        $('#cardSlotPunchShort').addClass('active');
                    }
                }
            });
        }

        // TEST BUTTONS

        $('#testPrepareForPrinting').on("click", function() {
            prepareCardForPrinting();
        });

        $('#loadTestTemplate').on("click", function() {
            loadCardTemplate($('#loadTestTemplateOrganization').val(), $('#loadTestTemplateID').val());
        });

        function prepareCardForPrinting() {
            // resize and crop images

            canvas.forEachObject(function (object) {
                if (object.get('type') == "variable-image") {
                    object.name = "";

                    if(object.scaleType=="stretch") return;

                    var imgWidth        = object.getOriginalSize().width,
                        imgHeight       = object.getOriginalSize().height,
                        objectWidth     = object.getWidth(),
                        objectHeight    = object.getHeight(),
                        objectTop       = object.getTop(),
                        objectLeft      = object.getLeft();

                    object.set('width', imgWidth);
                    object.set('height', imgHeight);
                    object.setCoords();

                    if(object.scaleType=="fit") {
                        if (objectWidth >= objectHeight) { // 1
                            if (imgWidth >= imgHeight) { // 1.1
                                object.scaleToWidth(objectWidth);
                                object.setTop(objectTop + Math.round((objectHeight - object.getHeight()) / 2));
                            }
                            else { // 1.2
                                object.scaleToHeight(objectHeight);
                                object.setLeft(objectLeft + Math.round((objectWidth - object.getWidth()) / 2));
                            }
                        }
                        else { // 2
                            if (imgWidth >= imgHeight) { // 2.1
                                object.scaleToHeight(objectHeight);
                                object.setLeft(objectLeft + Math.round((objectWidth - object.getWidth()) / 2));
                            }
                            else { // 2.2
                                object.scaleToWidth(objectWidth);
                                object.setTop(objectTop + Math.round((objectHeight - object.getHeight()) / 2));
                            }
                        }
                    }
                    else if(object.scaleType=="crop") {
                        if (objectWidth >= objectHeight) { // 1
                            if (imgWidth >= imgHeight) { // 1.1
                                object.scaleToHeight(objectHeight);
                                object.setLeft(objectLeft - Math.round((object.getWidth() - objectWidth) / 2));
                            }
                            else { // 1.2
                                object.scaleToWidth(objectWidth);
                                object.setTop(objectTop - Math.round((object.getHeight() - objectHeight) / 2));
                            }
                        }
                        else { // 2
                            if (imgWidth >= imgHeight) { // 2.1
                                object.scaleToWidth(objectWidth);
                                object.setTop(objectTop - Math.round((object.getHeight() - objectHeight) / 2));
                            }
                            else { // 2.2
                                object.scaleToHeight(objectHeight);
                                object.setLeft(objectLeft - Math.round((object.getWidth() - objectWidth) / 2));
                            }
                        }

                        object.clipTo = function (ctx) {
                            ctx.rect (-Math.round(objectWidth/2), -Math.round(objectHeight/2), objectWidth, objectHeight);
                        }

                        resizeVariableImage(object);
                    }

                    object.setCoords();
                }
            });
            canvas.renderAll();
        }

        // API
        function scale(int, coeff) {
            var newFloat = int*coeff,
                newInt = Math.ceil(newFloat);

            //console.log(int + ' ||| ' + newInt);

            return newFloat;
        }

        function scaleObjects(objects, background, scaleUp) {
            //TODO: templateFields images?

            // check if scaling needed by checking the bg size
            if((scaleUp && (background.width == 1012 || background.height == 1012)) || (!scaleUp && (background.width == 457 || background.height == 457)))
                return {objects: objects, background: background};

            var coeff = 1;

            if(scaleUp)
                coeff = 1012 / 457;
            else
                coeff = 457 / 1012;

            for(i=0; i<objects.length; i++) {
                if(objects[i].left)
                    objects[i].left = scale(objects[i].left, coeff);
                if(objects[i].top)
                    objects[i].top = scale(objects[i].top, coeff);
                if(objects[i].width)
                    objects[i].width = scale(objects[i].width, coeff);
                if(objects[i].height)
                    objects[i].height = scale(objects[i].height, coeff);
                if(objects[i].strokeWidth)
                    objects[i].strokeWidth = scale(objects[i].strokeWidth, coeff);
                if(objects[i].strokeWidthNew)
                    objects[i].strokeWidthNew = scale(objects[i].strokeWidthNew, coeff);
                if(objects[i].cornerRadius)
                    objects[i].cornerRadius = scale(objects[i].cornerRadius, coeff);
                if(objects[i].fontSize)
                    objects[i].fontSize = scale(objects[i].fontSize, coeff);
                if(objects[i].fontSizeOriginal)
                    objects[i].fontSizeOriginal = scale(objects[i].fontSizeOriginal, coeff);
                if(objects[i].x1)
                    objects[i].x1 = scale(objects[i].x1, coeff);
                if(objects[i].x2)
                    objects[i].x2 = scale(objects[i].x2, coeff);
                if(objects[i].clipWidth)
                    objects[i].clipWidth = scale(objects[i].clipWidth, coeff);
                if(objects[i].clipHeight)
                    objects[i].clipHeight = scale(objects[i].clipHeight, coeff);
                if(objects[i].rx)
                    objects[i].rx = scale(objects[i].rx, coeff);
                if(objects[i].ry)
                    objects[i].ry = scale(objects[i].ry, coeff);

                // TODO: check other rects like slotPunch
                /*
                if(objects[i].scaleX && objects[i].type=="rect")
                    objects[i].scaleX = scale(objects[i].scaleX, coeff);
                if(objects[i].scaleY && objects[i].type=="rect")
                    objects[i].scaleY = scale(objects[i].scaleY, coeff);*/
            }

            if(scaleUp) {
                if(background.width>background.height) {
                    background.width = 1012;
                    background.height = 638;
                }
                else {
                    background.width = 638;
                    background.height = 1012;
                }
            }
            else {
                if(background.width>background.height) {
                    background.width = 457;
                    background.height = 288;
                }
                else {
                    background.width = 288;
                    background.height = 457;
                }
            }

            return {objects: objects, background: background};
        }

        function prepareTemplateForSaving(canvasJSON) {
            var data = JSON.parse(canvasJSON);

            for(i=0; i<data.objects.length; i++) {
                if(data.objects[i].name && (data.objects[i].name == "embedded_top" || data.objects[i].name == "embedded_bottom")) {
                    delete data.objects[i];
                    continue;
                }
            }
            data.objects = data.objects.filter(function(n){ return n != undefined });

            if(data.objects.length == 0 && data.backgroundImage && data.backgroundImage.src == 'data:image/gif;base64,R0lGODlhAQABAPAAAP///////yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==') {
                return '';
            }

            var left    = leftPadding,
                top     = topPadding;

            for(i=0; i<data.objects.length; i++) {
                if(data.objects[i].type == "rect" && data.objects[i].rx == 10 && data.objects[i].ry == 10 && (data.objects[i].fill == '#2a3035' || data.objects[i].fill == 'rgba(47,47,47,1)') && (data.objects[i].stroke == '#697884' || data.objects[i].stroke == 'rgba(117,117,117,1)')) {
                    data.objects[i].name = "slotPunch";
                }

                if(data.objects[i].type == "static-text" && data.objects[i].variable) {
                    //if(data.objects[i].text.substring(0, 3) != '{{{')
                        data.objects[i].fieldName = data.objects[i].text;

                        if(data.objects[i].concatenation)
                            data.objects[i].text = data.objects[i].concatenation;
                        else
                            data.objects[i].text = '{{{'+removeUnsupportedCharacters(data.objects[i].text)+'}}}';
                }
                else if(data.objects[i].type == "image") {
                    data.objects[i].crossOrigin = '*'; // just in case. probably can remove later
                    if(data.objects[i].name && data.objects[i].name.slice(0,8) == "embedded")
                    {
                        data.objects[i].actualOpacity = data.objects[i].opacity;
                        data.objects[i].opacity = 0;
                    }
                }
                else if(data.objects[i].type == "variable-image") {
                    //data.objects[i].src = '{{'+data.objects[i].name+'}}';
                    data.objects[i].name = '';
                    data.objects[i].crossOrigin = '*';

                    data.objects[i].fieldName = stripBrackets(data.objects[i].src);
                    data.objects[i].src = '{{{'+removeUnsupportedCharacters(data.objects[i].fieldName)+'}}}';
                }
                else if(data.objects[i].type == "rect" && (data.objects[i].name == "slotPunch" || data.objects[i].name == "magStripe")) {
                    data.objects[i].fill = 'rgba(0,0,0,0)';
                    data.objects[i].stroke = 'rgba(0,0,0,0)';
                }
                //else if(data.objects[i].type == "barcode" && data.objects[i].barcodeType == "qrcode") {
                else if(data.objects[i].type == "barcode") {
                    data.objects[i].src = '{{{'+data.objects[i].name+'}}}';
                }

                // remove offset
                data.objects[i].left -= left;
                data.objects[i].top  -= top;
            }

            if(data.overlayImage) delete data.overlayImage;

            if(data.backgroundImage) {
                data.backgroundImage.left -= left;
                data.backgroundImage.top -= top;
            }

            var dataScaled = scaleObjects(data.objects, data.backgroundImage, true);

            data.objects = dataScaled.objects;
            data.backgroundImage = dataScaled.background;

            return JSON.stringify(data);
        }

        function prepareTemplateForLoading(canvasJSON, offset) {
            if(canvasJSON == "") return;

            var data = JSON.parse(canvasJSON),
                offset = offset || false;

            var left    = leftPadding,
                top     = topPadding;

            var dataScaled = scaleObjects(data.objects, data.backgroundImage, false);

            data.objects = dataScaled.objects;
            data.backgroundImage = dataScaled.background;

            for(i=0; i<data.objects.length; i++) {
                var isSlotPunch = false;
                if(data.objects[i].type == "rect" && data.objects[i].rx == 10 && data.objects[i].ry == 10 && data.objects[i].fill == 'rgba(0,0,0,0)' && data.objects[i].stroke == 'rgba(0,0,0,0)') {
                    isSlotPunch = true;
                }

                if(data.objects[i].type == "static-text" || data.objects[i].type == "variable-text") {
                    data.objects[i].fontSizeOriginal = data.objects[i].fontSize;
                }

                // remove brackets
                if((data.objects[i].type == "static-text" || data.objects[i].type == "variable-text") && (data.objects[i].text.substring(0,3)=="{{{" || data.objects[i].concatenation)) {
                    if(data.objects[i].fieldName && data.objects[i].fieldName != "")
                        data.objects[i].text = data.objects[i].fieldName;
                    else if(!data.objects[i].concatenation)
                        data.objects[i].text = stripBrackets(data.objects[i].text);
                }
                else if(data.objects[i].type == "image") {
                    if(data.objects[i].name && data.objects[i].name.slice(0,8) == "embedded")
                    {
                        data.objects[i].opacity = data.objects[i].actualOpacity;
                    }
                }
                else if(data.objects[i].type == "variable-image" && data.objects[i].src.substring(0,3)=="{{{") {
                    if(data.objects[i].fieldName && data.objects[i].fieldName != "")
                        data.objects[i].name = data.objects[i].fieldName;
                    else
                        data.objects[i].name = stripBrackets(data.objects[i].src);

                    data.objects[i].src = config.varIMG;
                }
                else if((data.objects[i].type == "rect" && data.objects[i].name == "slotPunch") || isSlotPunch) {
                    data.objects[i].name = "slotPunch";
                    data.objects[i].fill = '#2a3035';
                    data.objects[i].stroke = '#697884';
                }
                else if(data.objects[i].type == "rect" && data.objects[i].name == "magStripe") {
                    data.objects[i].fill = '#000';
                }
                else if(data.objects[i].type == "barcode" && data.objects[i].barcodeType == "qrcode") {
                    data.objects[i].src = config.barcodeIMG.qrcode;
                }
                else if(data.objects[i].type == "barcode" && (data.objects[i].barcodeType == "code39" || data.objects[i].barcodeType == "code39extended")) {
                    data.objects[i].src = config.barcodeIMG.code39;
                }
                else if(data.objects[i].type == "barcode" && (data.objects[i].barcodeType == "Code25" || data.objects[i].barcodeType == "Code25Interleaved" || data.objects[i].barcodeType == "Code25IATA")) {
                    data.objects[i].src = config.barcodeIMG.code25;
                }
                else if(data.objects[i].type == "barcode" && data.objects[i].barcodeType.slice(0, -1) == "code128") {
                    data.objects[i].src = config.barcodeIMG.code128;
                }

                // add offset
                if(offset) {
                    data.objects[i].left += left;
                    data.objects[i].top += top;
                }
            }

            if(offset) {
                data.backgroundImage.width = cardWidth;
                data.backgroundImage.height = cardHeight;
                data.backgroundImage.left += left;
                data.backgroundImage.top += top;
            }

            return JSON.stringify(data);
        }

        function removeAllObjects() {
            canvas.forEachObject(function(object) {
                if (object.type == "image" && object.name && object.name.slice(0,8) == "embedded") {
                    canvas.remove(object);
                }
            });
        }

        function loadCardTemplate(organizationID, templateID) {
            canvas.clear();
            getSelectedSide().json = "";
            getUnselectedSide().json = "";

            unlockSelection();
            cardData = [];
            templateData.template_fields = [];
            updateListOfVariables();

            //removeAllObjects();
            clearHistory();

            $.ajax({
                type: 'GET',
                url: config.apiURL+'card_templates/'+templateID+'?organization_id='+organizationID,
                success: function (data) {
                    var fixedData = fixMagstripeTokensOnLoad(data.template_fields, data.card_data);
                    data.template_fields = fixedData.template_fields;
                    data.card_data = fixedData.card_data;

                    data.front_data = fixConcatenatedFieldsJSON(data.front_data, data.template_fields);

                    if(getOptionValueByKey(data.options, "sides")=="double")
                        data.back_data = fixConcatenatedFieldsJSON(data.back_data, data.template_fields);

                    // fix migrated qr codes
                    data.front_data = fixMigratedQRcodes(data.front_data, data.card_data, data.template_fields);
                    if(getOptionValueByKey(data.options, "sides")=="double" && data.back_data)
                        data.back_data = fixMigratedQRcodes(data.back_data, data.card_data, data.template_fields);

                    if(orientation!=getOptionValueByKey(data.options, "orientation"))
                        changeOrientation();

                    slotPunch = getOptionValueByKey(data.options, "slot_punch");
                    if(!slotPunch) slotPunch = "none";

                    letter = getOptionValueByKey(data.options, "letter_id");
                    if(!letter) letter = "none";

                    setColorOfSides(getOptionValueByKey(data.options, "color"));

                    if(selectedSideID()==1) {
                        $("#sideFront").addClass("active");
                        $("#sideBack").removeClass("active");
                        flipSides();
                    }

                    if(getOptionValueByKey(data.options, "sides")=="double") {
                        setNumberOfSides(2);
                        cardSides[1].json = data.back_data;
                    }
                    else {
                        setNumberOfSides(1);
                        cardSides[1].json = cleanTemplate;
                    }

                    loadCanvasFromJSON(data.front_data, true);
                    clearHistory();
                    addSnapshotToHistory(data.front_data);

                    loadVariableFields(data.template_fields);

                    updateTemplateData(data);

                    updateLayerList();

                    loadFonts(organizationID);
                    loadLetters(organizationID, letter);
                    loadSpecialHandlings(organizationID, data.special_handlings);

                    updateCardTypes();
                    setSelectedCardType(getCardTypeArrayIDbyID(templateData.cardTypeID));

                    updateHeader();

                    updateImageList();
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function deleteCardTemplate(organizationID, templateID) {
            $.ajax({
                url: config.apiURL+'card_templates/'+templateID+'?organization_id='+organizationID,
                type: "post", // type: "DELETE" doesn't work for some reason
                dataType: "json",
                data: {"_method":"delete"},
                success: function() {
                    updateTemplatesSelect("#modalLoadTemplateTemplate", $("#modalLoadTemplateOrganization").val());
                }
            });
        }

        function getOptionValueByKey(options, key) {
            for(i=0; i<options.length; i++) {
                if(options[i].key == key)
                    return options[i].value;
            }
        }

        function addDefaultVariableFields() {
            for(i=0; i<defaultTextFields.length; i++) {
                var notUsed = true;

                for(z=0; z<varTextFields.length; z++) {
                    if(defaultTextFields[i].name==varTextFields[z].name)
                        notUsed = false;
                }

                if(notUsed) {
                    varTextFields.push({
                        id:     varTextFields.length,
                        name:   defaultTextFields[i].name
                    });
                }
            }

            for(i=0; i<defaultImageFields.length; i++) {
                var notUsed = true;

                for(z=0; z<varImageFields.length; z++) {
                    if(defaultImageFields[i].name==varImageFields[z].name)
                        notUsed = false;
                }

                if(notUsed) {
                    varImageFields.push({
                        id:     varImageFields.length,
                        name:   defaultImageFields[i].name
                    });
                }
            }

            for(i=0; i<defaultBarcodeFields.length; i++) {
                var notUsed = true;

                for(z=0; z<varBarcodeFields.length; z++) {
                    if(defaultBarcodeFields[i].name==varBarcodeFields[z].name) {
                        notUsed = false;
                        defaultBarcodeFields[i].type = varBarcodeFields[z].type;
                    }
                }

                if(notUsed) {
                    varBarcodeFields.push({
                        id:     varBarcodeFields.length,
                        name:   defaultBarcodeFields[i].name,
                        type:   defaultBarcodeFields[i].type
                    });
                }
            }
        }

        function fixMigratedQRcodes(data, card_data, template_fields) {
            // iterate through card_data, find qrcodes with variables
            // if(card_data[i].data[0].qrcode[0] == "{") then it's a variable
            // iterate through template_fields, find full field names of those variables
            // parse data if vars.length>0
            // iterate through dara.objects, fix barcodes with src=="{{{qrcode_0}}}" etc
            // qrcode, should be:
            // "textType":"variable","text":"FIELD NAME"
            // return data stringify
            if(!data || !card_data || !template_fields || card_data.length==0 || template_fields.length==0)
                return data;

            var qrcodes = [];

            for(var i=0; i<card_data.length; i++) {
                if(card_data[i].type == "qrcode" && card_data[i].data[0].qrcode.length>0 && card_data[i].data[0].qrcode[0] == "{") {
                    qrcodes.push({
                        qrcode: card_data[i].token,
                        token: stripBrackets(card_data[i].data[0].qrcode),
                        fieldName: ""
                    });
                }
            }

            if(qrcodes.length == 0) return data;

            var errors = 0;

            for(var i=0; i<qrcodes.length; i++) {
                var foundFieldName = false;

                for(var z=0; z<template_fields.length; z++) {
                    if(qrcodes[i].token == template_fields[z].token) {
                        qrcodes[i].fieldName = template_fields[z].label;
                        foundFieldName = true;
                        break;
                    }
                }

                if(!foundFieldName) {
                    errors++;
                    alert("There might be a problem with the qrcode " + qrcodes[i].qrcode);
                }
            }

            if(errors>0) return data;

            data = JSON.parse(data);

            if(data.objects.length == 0) return JSON.stringify(data);

            for(var i=0; i<data.objects.length; i++) {
                if(data.objects[i].type != "barcode" || data.objects[i].barcodeType != "qrcode")
                    continue;

                var qrcode = stripBrackets(data.objects[i].src);

                for(var z=0; z<qrcodes.length; z++) {
                    if(qrcodes[z].qrcode == qrcode) {
                        data.objects[i].textType = "variable";
                        data.objects[i].text = qrcodes[z].fieldName;
                    }
                }
            }

            return JSON.stringify(data);
        }

        function varFieldsCheckIfFieldExists(array, name) {
            if(!array || !name || array.length == 0) return false;

            for(var i=0; i<array.length; i++) {
                if(array[i].name == name) return true;
            }

            return false;
        }

        function loadVariableFields(template_fields) {
            if(template_fields=="") return;

            varTextFields   = [];
            varImageFields  = [];
            varBarcodeFields = [];

            for(i=0; i<template_fields.length; i++) {
                if(template_fields[i].type == "text" || template_fields[i].type == "calculated_date" || template_fields[i].type == "selectbox" || template_fields[i].type == "radiobox" || template_fields[i].type == "concatenated" || template_fields[i].type == "checkbox") {
                    var fieldName = "";

                    if(template_fields[i].label && template_fields[i].label != "")
                        fieldName = template_fields[i].label;
                    else
                        fieldName = template_fields[i].token;

                    if(!varFieldsCheckIfFieldExists(varTextFields, fieldName)) {
                        varTextFields.push({
                            id:     varTextFields.length,
                            name:   fieldName
                        });
                    }

                    if(!varFieldsCheckIfFieldExists(varBarcodeFields, fieldName)) {
                        varBarcodeFields.push({
                            id:     varBarcodeFields.length,
                            name:   fieldName,
                            token:  removeUnsupportedCharacters(fieldName),
                            //type:   [template_fields[i].type]
                            type:   ["barcode","qrcode","track1","track2","track3"]
                        });
                    }
                }
                else if(template_fields[i].type == "image") {
                    var fieldName = "";

                    if(template_fields[i].label && template_fields[i].label != "")
                        fieldName = template_fields[i].label;
                    else
                        fieldName = template_fields[i].token;

                    varImageFields.push({
                        id:     varImageFields.length,
                        name:   fieldName
                    });
                }
                else {
                    var name, token;

                    if(template_fields[i].label && template_fields[i].label != "") {
                        name = template_fields[i].label;
                        token = template_fields[i].token;
                    }
                    else {
                        name = template_fields[i].token;
                        token = name;
                    }

                    if(!varFieldsCheckIfFieldExists(varBarcodeFields, template_fields[i].label)) {
                        varBarcodeFields.push({
                            id:     varBarcodeFields.length,
                            name:   template_fields[i].label,
                            token:  template_fields[i].token,
                            //type:   [template_fields[i].type]
                            type:   ["barcode","qrcode","track1","track2","track3"]
                        });
                    }

                    // add a text field if there isn't one
                    if(!varFieldsCheckIfFieldExists(varTextFields, template_fields[i].label)) {
                        varTextFields.push({
                            id:     varTextFields.length,
                            name:   template_fields[i].label
                        });
                    }
                }
            }

            addDefaultVariableFields();

            updateVarTextList();
            updateVarImageList();
            updateVarMagstripeLists();

            updateListOfVariables();
        }

        function updateTemplateData(data) {
            data.organization_id    = data.organization_id || 1;
            data.id                 = data.id || -1;
            data.name               = data.name || "";
            data.card_type_id       = data.card_type_id || cardTypeIDs.default;
            data.card_data          = data.card_data || [],
            data.template_fields    = data.template_fields || [];

            templateData.organizationID = data.organization_id;
            templateData.templateID     = data.id;
            templateData.templateName   = data.name;
            templateData.cardTypeID     = data.card_type_id;
            templateData.template_fields = data.template_fields;
            updateCardData(data.card_data);

            $('#testTemplateData').html('OrganizationID: '+templateData.organizationID+'<br>TemplateID: '+templateData.templateID+'<br>Template Name: '+templateData.templateName);

            cardUpdateBasedOnType();

            if(templateData.templateID != -1)
                $('#menuPreview').prop("disabled", false);
        }

        function updateCardData(data) {
            clearCardData();
            cardData = data;
            updateMagstripeFieldsFromCardData(data);

            $('#cardData').text(JSON.stringify(cardData));
        }

        function clearCardData() {
            cardData = [];

            $('#editQrcodeText').val("");
            $('#editBarcodeType').val($("#editBarcodeType option:first").val());
            $('#editBarcodeText').val("");
            $('#magstripeTrackFixed1').val("");
            $('#magstripeTrackFixed2').val("");
            $('#magstripeTrackFixed3').val("");

            $('#cardData').text(JSON.stringify(cardData));
        }

        $('#modalConfirmNewTemplateNew').on("click", function(){
            createNewTemplate();
            $('#modalConfirmNewTemplate').modal('hide');
        });

        function createNewTemplate() {
            loadingCanvas(true);
                loadCanvasFromJSON(cleanTemplate, true);
                getUnselectedSide().json = cleanTemplate;

                setSelectedCardType(getCardTypeArrayIDbyID(cardTypeIDs.default));
                setNumberOfSides(1);
                setColorOfSides("colorblack");
                slotPunch       = "none";
                clearCardData();

                varTextFields = [];
                varImageFields = [];
                varBarcodeFields = [];
                addDefaultVariableFields();
                updateVarTextList();
                updateVarImageList();
                updateVarMagstripeLists();

                $('#cardOneSided, #cardDoubleSided').prop('disabled', false);
                $('#cardDoubleSided').css('font-weight', 'normal');
                $('#cardPortrait, #cardLandscape').prop('disabled', false);
                $('#cardLandscape').css('font-weight', 'normal');
                $('#cardSlotPunchLong').prop('disabled', false);

                setTimeout(function() {
                    if(orientation=="portrait") changeOrientation();

                    updateLayerList();
                    updateTemplateData({organization_id: templateData.organizationID});

                    loadSpecialHandlings(templateData.organizationID);

                    clearHistory();
                    addSnapshotToHistory();

                    updateHeader();

                    loadingCanvas(false);
                }, 500);

        }

        // Update Card Types
        function updateCardTypes() {
            var apiURL = config.apiURL+'card_types?organization_id='+templateData.organizationID;

            if(templateData.organizationID == -1) {
                apiURL = config.apiURL+'card_types';
                //updateCardTypesList();
                //return;
            }

            $.ajax({
                type: 'GET',
                url: apiURL,
                success: function (data) {
                    cardTypes = data;
                    updateCardTypesList();
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function updateCardTypesList() {
            if(cardTypes.length==0) {
                $('#cardTypeSelect').html('Default <span class="caret"></span>');
                $('#tab-card .dropdown-menu').html("");
                $('#menuTemplateNew').siblings().andSelf().prop("disabled", false);
                if(templateData.templateID == -1)
                    $('#menuPreview').prop("disabled", true);
                return;
            }

            var html = "";
            for(i=0; i<cardTypes.length; i++) {
                if(templateData.cardTypeID == cardTypes[i].id) $('#cardTypeSelect').html(cardTypes[i].name + '<span class="caret"></span>');

                html += '<li role="presentation"><a role="menuitem" tabindex="-1" href="'+i+'">' +
                '<div class="row"><div class="col-xs-12"><h4>' + cardTypes[i].name + '</h4></div></div>' +
                '<div class="row"><div class="col-xs-12 description">' + cardTypes[i].description + '</div></div>' +
                //'<div class="row"><div class="col-xs-12"><img class="img-responsive" src="img/cardTypePreview.png"></div></div>' +
                '</a></li>';
            }

            $('#menuTemplateNew').siblings().andSelf().prop("disabled", false);
            if(templateData.templateID == -1)
                $('#menuPreview').prop("disabled", true);
/*
            cardTypes[2].images = [{
                "src": "img/polka-dot.jpg",
                "layer": "bottom",
                "side": "front",
                "width": "100%", // px or % of the card width
                "height": "100%",
                "left": 0,
                "top": 0,
                "opacity": 0.3
            }];*/

            $('#tab-card .dropdown-menu').html(html);
        }

        $(document).on("click", '#tab-card .dropdown-menu a', function (event) {
            event.preventDefault();

            var id = parseInt($(this).attr('href'));

            $('#cardTypeSelect').html(cardTypes[id].name + '<span class="caret"></span>');

            templateData.cardTypeID = cardTypes[id].id;

            //if(cardTypes[id].width!=0 && cardTypes[id].height != 0) { //TODO: resize the card if needed because of the card type
                //resizeCard(cardTypes[id].width, cardTypes[id].height);
            //}
            cardUpdateBasedOnType();
        });

        function getCardTypeArrayIDbyID(cardTypeID) {
            for(i=0; i<cardTypes.length; i++) {
                if(cardTypes[i].id == cardTypeID) return i;
            }
        }

        function setSelectedCardType(id) {
            if(!cardTypes[id]) return;

            $('#cardTypeSelect').html(cardTypes[id].name + '<span class="caret"></span>');
        }

        function addCardTypeImage(data) {
            /*
             {
                 "id": 1,
                 "name": "PVC White",
                 "description": "PVC card white",
                 "width": 0,
                 "height": 0,
                 "images": [{
                     "src": "img/embed.jpg",
                     "layer": "top|bottom",
                     "side": "front|back|both",
                     "width": "150|100%", // px or % of the card width
                     "height": "150|100%",
                     "left": "100|10%",
                     "top": "100|10%",
                     "opacity": 0.8
                }]
             }
             */

            fabric.Image.fromURL(data.src, function(img) {
                if(typeof data.left == "string" && data.left.slice(-1)=="%")
                    data.left = Math.round(data.left.slice(0, -1) / 100 * cardWidth);

                if(typeof data.top == "string" && data.top.slice(-1)=="%")
                    data.top = Math.round(data.top.slice(0, -1)/100*cardHeight);

                if(typeof data.width == "string" && data.width.slice(-1)=="%")
                    data.width = Math.round(data.width.slice(0, -1)/100*cardWidth);

                if(typeof data.height == "string" && data.height.slice(-1)=="%")
                    data.height = Math.round(data.height.slice(0, -1)/100*cardHeight);

                img.left = data.left + leftPadding;
                img.top = data.top + topPadding;
                img.width = data.width;
                img.height = data.height;

                img.opacity = data.opacity;

                img.selectable = false;
                img.evented = false;

                img.name = "embedded_"+data.layer;

                canvas.add(img);
                canvas.renderAll();
            }, {crossOrigin: '*'});
        }

        function cardUpdateBasedOnType() {
            canvas.forEachObject(function(object) {
                if (object.type == "image" && object.name && object.name.slice(0,8) == "embedded") {
                    canvas.remove(object);
                }
            });

            if(templateData.cardTypeID == cardTypeIDs.magStripe) {
                setNumberOfSides(2); // force double sidedness
                $('#cardOneSided, #cardDoubleSided').prop('disabled', true); // disable one-sided/double-sided buttons
                $('#cardDoubleSided').css('font-weight', 'bold');

                //$('#cardPortrait, #cardLandscape').prop('disabled', true); // disable portrait/landscape buttons
                //$('#cardLandscape').css('font-weight', 'bold');

                $('#cardSlotPunchLong').prop('disabled', true);
                //if(slotPunch != "none") updateSlotPunch("cardSlotPunchNone");
                if(slotPunch == "long") {
                    warning("You had a slot punch on the long side of the card, which isn't allowed for magstripe cards. Slot punch was moved to the short side!");
                    updateSlotPunch('cardSlotPunchShort');
                }

                //if(orientation == "portrait") changeOrientation();

                showTab('tab-magstripe');

                magStripeAdd(); // draw a stripe on the back
            }
            else {
                // enable buttons
                $('#cardOneSided, #cardDoubleSided').prop('disabled', false);
                $('#cardDoubleSided').css('font-weight', 'normal');

                $('#cardPortrait, #cardLandscape').prop('disabled', false); // disable portrait/landscape buttons
                $('#cardLandscape').css('font-weight', 'normal');

                $('#cardSlotPunchLong').prop('disabled', false);

                hideTab('tab-magstripe');

                magStripeRemove(); // remove the stripe
                cardDataRemove({type: "magstripe"});
                showMagstripeFixed(1);
                showMagstripeFixed(2);
                showMagstripeFixed(3);
                $('#magstripeTrackFixed1').val("");
                $('#magstripeTrackFixed2').val("");
                $('#magstripeTrackFixed3').val("");
            }

            var arrayID = getCardTypeArrayIDbyID(templateData.cardTypeID);

            if(!cardTypes[arrayID] || !cardTypes[arrayID].images) return;

            for(i=0; i<cardTypes[arrayID].images.length; i++) {
                addCardTypeImage(cardTypes[arrayID].images[i]);
            }
        }

        // List of Variables
        var editVariableSelectedLabel = "";

        $('#modalListOfVariables').on('shown.bs.modal', function() {
            updateListOfVariables();
        });

        function updateListOfVariables() {

            var templateFields = templateData.template_fields,
                //templateFields = JSON.parse(templateFieldsJSON()),
                tbody = '#modalListOfVariablesContent > table > tbody';

            $(tbody).empty();

            var nameCounter = [];

            for(i=0; i<templateFields.length; i++) {
                var type, req,
                    name = templateFields[i].label || templateFields[i].token;
                    //name = templateFields[i].token;

                var addToCounter = true;
                for(var z=0; z<nameCounter.length; z++) {
                    if(nameCounter[z].name == name) {
                        addToCounter = false;
                        nameCounter[z].counter++;
                    }
                }
                if(addToCounter) {
                    nameCounter.push({
                        name: name,
                        counter: 1
                    });
                }

                switch(templateFields[i].type) {
                    case "text":
                        type = 'Text';
                        req = '&lt; 100 characters';
                        break;
                    case "checkbox":
                        type = "Checkbox";
                        req = "";
                        break;
                    case "selectbox":
                        type = "Selectbox";
                        req = "";
                        break;
                    case "calculated_date":
                        type = "Calculated Date";
                        req = "";
                        break;
                    case "radiobox":
                        type = "Radiobox";
                        req = "";
                        break;
                    case "concatenated":
                        type = "Concatenated";
                        req = "";
                        break;
                    case "image":
                        type = 'Image';
                        req = '&lt; 5mb, .jpg or .png';
                        break;
                    case "qrcode":
                        type = 'QR Code';
                        req = '&lt; 100 characters';
                        break;
                    case "barcode":
                        type = 'Barcode';
                        req = '';
                        break;
                    case "track1":
                        type = 'Magstripe (Track 1)';
                        req = '&lt; 79 alphanumeric characters';
                        break;
                    case "track2":
                        type = 'Magstripe (Track 2)';
                        req = '&lt; 40 numeric characters';
                        break;
                    case "track3":
                        type = 'Magstripe (Track 3)';
                        req = '&lt; 107 numeric characters';
                        break;
                    case "placeholder":
                        type = 'PlaceHolder';
                        req = '';
                        break;
                    default:
                        type = '';
                        req = '';
                        break;
                }

                var editButton = "";

                //if(type != "Image" && type != "PlaceHolder") editButton = '<i class="fa fa-pencil"></i>&nbsp;&nbsp;';
                if(type != "Image") editButton = '<i class="fa fa-pencil"></i>&nbsp;<i class="fa fa-remove"></i>&nbsp;&nbsp;';
                if(type == "PlaceHolder") editButton = '&nbsp;<i class="fa fa-remove"></i>&nbsp;&nbsp;';

                $(tbody).append('<tr><td>'+(i+1)+'</td><td>'+name+'</td><td>'+editButton+type+'</td><td>'+req+'</td></tr>');
            }

            var shouldShowWarning = false;
            for(var z=0; z<nameCounter.length; z++) {
                if(nameCounter[z].counter>1) {
                    shouldShowWarning = true;
                    break;
                }
            }
            if(shouldShowWarning) $('#modalListOfVariablesRepeatingVariables').removeClass('hidden');
            else $('#modalListOfVariablesRepeatingVariables').addClass('hidden');

            $('.sorted_table').sortable("refresh");
        }

        function countObjectsThatUseVariable(label) {
            var counter = 0;

            canvas.forEachObject(function(obj) {
                if(obj.type == "static-text" && obj.variable && obj.text == label)
                    counter++;
                else if(obj.type == "barcode" && obj.textType == "variable" && obj.text == label)
                    counter++;
            });

            if(sides=="double" && getUnselectedSide().json != "") {
                var data = JSON.parse(getUnselectedSide().json);

                for (i = 0; i < data.objects.length; i++) {
                    if(data.objects[i].type == "static-text" && data.objects[i].variable && data.objects[i].fieldName == label)
                        counter++;
                    else if(data.objects[i].type == "barcode" && data.objects[i].textType == "variable" && data.objects[i].text == label)
                        counter++;
                }
            }

            return counter;
        }

        $(document).on("click", "#modalListOfVariablesContent .fa-remove", function() {
            //TODO:
            //alert("want to delete?");
            //this template contains [number] objects that use variable [field name], they will also be deleted. Are you sure you want to delete [variable name]?
            var type = variableTypeNameToShort($(this).parent().text().substring(3)),
                label = $(this).parent().prev().text();

            $('#modalDeleteVariable').data('type', type);
            $('#modalDeleteVariable').data('label', label);

            var counter = countObjectsThatUseVariable(label),
                description = "";

            if(counter>0) {
                description = "This template contains <strong>" + counter + "</strong> objects that use the field \"" + label + "\" (" + type + ").<br>"
                            +  "You'll need to delete these objects or assign new variables to them.<br><br>";
            }

            description += "Are you sure you want to delete \"" + label + "\" (" + type + ")?";

            $('#modalDeleteVariable .modal-title').text("Delete \"" + label + "\"?");
            $('#modalDeleteVariableDescription').html(description);

            $('#modalDeleteVariable').modal('show');
        });

        $("#modalDeleteVariableDelete").on("click", function() {
            var type = $('#modalDeleteVariable').data('type'),
                label = $('#modalDeleteVariable').data('label');

            deleteVariable_modal(type, label);

            updateListOfVariables();
        });

        $('#modalListOfVariablesAddNew select').change(function(){
            if($(this).val() == "Text")
                $('#modalListOfVariablesAddNew input[type="text"]').prop('disabled', false);
            else
                $('#modalListOfVariablesAddNew input[type="text"]').prop('disabled', true);
        });

        $('#modalListOfVariablesAddNew button').on('click', function(){
            var type = $('#modalListOfVariablesAddNew select').val();

            if(type=="Placeholder") {
                templateData.template_fields.push({
                    type: "placeholder",
                    token: "PlaceHolder",
                    label: "PlaceHolder"
                });
            }
            else {
                var label = $('#modalListOfVariablesAddNew input[type="text"]').val(),
                    token = removeUnsupportedCharacters(label);

                if(!token || token.length == 0) {
                    warning("Can't add a field with this name");
                    return;
                }

                // check if a variable with this token exists
                var tokenExists = false;
                for(var i=0; i<templateData.template_fields.length; i++) {
                    if(templateData.template_fields[i].token && templateData.template_fields[i].token == token) {
                        tokenExists = true;
                        break;
                    }
                }

                if(tokenExists) {
                    warning("Can't add a field with this name. A field with the same token already exists. Please use Shift+T -> \"Template Fields JSON\" to add this field manually if you actually need it.");
                    return;
                }

                templateData.template_fields.push({
                    type: "text",
                    token: token,
                    label: label
                });

                varTextFields.push({
                    id:     varTextFields.length,
                    name:   label
                });

                varBarcodeFields.push({
                    id:     varBarcodeFields.length,
                    name:   label,
                    token:  token,
                    type:   ["barcode","qrcode","track1","track2","track3"]
                });

                updateVarTextList();
                updateVarBarcodeList("barcode");
                updateVarBarcodeList("qrcode");
                updateVarMagstripeLists();
            }

            updateListOfVariables();
        });

        $(document).on("click", "#modalListOfVariablesContent .fa-pencil", function(){
            $('#modalEditVariable').modal('show');

            var type = $(this).parent().text();
            editVariableSelectedLabel = $(this).parent().prev().text();

            var variableData = getVariableByLabel(editVariableSelectedLabel);
            if(!variableData) {
                alert("Couldn't find the variable \""+editVariableSelectedLabel+"\"");
                return;
            }

            if(type!="Image") type = type.substring(3);

            type = variableTypeNameToShort(type);

            $('#editVariableType').val(type);
            editVariableShowTypeOptions(type);

            $('#editVariableCheckboxChecked').val("");
            $('#editVariableCheckboxUnchecked').val("");
            $('#editVariableCalculatedDateFormat').val("MM-DD-YYYY");
            $('#editVariableCalculatedDatePlus').val("0");

            if(type != "selectbox" && type != "radiobox")
                editVariableResetOptionFields();
            else
                editVariableRemoveOptionFields();

            if(type != "concatenated")
                editVariableResetConcatenatedFields();
            else
                editVariableRemoveConcatenatedFields();

            if(type == "checkbox") {
                var checked = variableData.checked,
                    unchecked = variableData.unchecked;

                if(!checked) checked = "";
                if(!unchecked) unchecked = "";

                $('#editVariableCheckboxChecked').val(checked);
                $('#editVariableCheckboxUnchecked').val(unchecked);
            }
            else if(type == "selectbox" || type == "radiobox") {
                if(!variableData.options) return;

                for (var i = 0; i < variableData.options.length; i++) {
                    editVariableAddOption(variableData.options[i]);
                }
            }
            else if(type == "concatenated") {
                $('#editVariableConcatenation').val(variableData.concatenation);

                if(!variableData.fields) return;

                for(var i = 0; i < variableData.fields.length; i++) {
                    editVariableAddConcatenatedField(variableData.fields[i]);
                }
            }
            else if(type == "calculated_date") {
                var format = "", plus = "", unit = "";
                var token = removeUnsupportedCharacters(editVariableSelectedLabel);

                for(var i=0; i<cardData.length; i++) {
                    if(cardData[i].type == "calculated_date" && cardData[i].token == token) {
                        for(var z=0; z<cardData[i].data.length; z++) {
                            if(cardData[i].data[z].hasOwnProperty("unit"))
                                unit = cardData[i].data[z].unit;
                            else if(cardData[i].data[z].hasOwnProperty("plus"))
                                plus = cardData[i].data[z].plus;
                            else if(cardData[i].data[z].hasOwnProperty("format"))
                                format = cardData[i].data[z].format;
                        }
                    }
                }

                $('#editVariableCalculatedDateFormat').val(format);
                $('#editVariableCalculatedDatePlus').val(plus);
                $('#editVariableCalculatedDateUnit').val(unit);
            }
        });

        function editVariableShowTypeOptions(type) {
            $(".editVariableCheckbox, .editVariableSelectbox, .editVariableConcatenated, .editVariableCalculatedDate").addClass("hidden");

            switch(type) {
                case "checkbox":
                        $(".editVariableCheckbox").removeClass("hidden");
                    break;
                case "radiobox":
                case "selectbox":
                        $(".editVariableSelectbox").removeClass("hidden");
                    break;
                case "concatenated":
                        $(".editVariableConcatenated").removeClass("hidden");
                    break;
                case "calculated_date":
                        $(".editVariableCalculatedDate").removeClass("hidden");
                    break;
                default:
                    break;
            }
        }

        $('#editVariableType').on('change', function(){
            editVariableShowTypeOptions($(this).val());
        });

        $('#modalEditVariableSave').on('click', function(){
            var type = $('#editVariableType').val(),
                label = editVariableSelectedLabel,
                newData = {};

            if(type=="checkbox") {
                newData = {
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label,
                    checked: $('#editVariableCheckboxChecked').val(),
                    unchecked: $('#editVariableCheckboxUnchecked').val()
                }
            }
            else if(type=="selectbox" || type=="radiobox") {
                // remove empty fields?
                var fields = [];

                for(var i=0; i<editVariableSelectboxFields.length; i++) {
                    //if(editVariableSelectboxFields[i] && editVariableSelectboxFields[i] != "") {
                        fields.push(editVariableSelectboxFields[i]);
                    //}
                }

                newData = {
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label,
                    options: fields
                }
            }
            else if(type=="concatenated") {
                var fields = [];

                $('.editVariableConcatenatedField').each(function(){
                    fields.push($(this).val());
                });

                $('.editVariableConcatenatedFieldNew').each(function(){
                    fields.push(removeUnsupportedCharacters($(this).val()));

                    templateData.template_fields.push({
                        type: "text",
                        token: removeUnsupportedCharacters($(this).val()),
                        label: $(this).val()
                    });
                });

                newData = {
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label,
                    concatenation: $('#editVariableConcatenation').val(),
                    fields: fields
                }
            }
            else if(type=="placeholder") {
                newData = {
                    type: type,
                    token: "PlaceHolder",
                    label: "PlaceHolder"
                }
            }
            else {
                newData = {
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label
                }
            }

            if(type=="calculated_date") {
                var calcDateData = [
                    {   plus:   parseInt($("#editVariableCalculatedDatePlus").val())    },
                    {   unit:   $("#editVariableCalculatedDateUnits").val()             },
                    {   format: $("#editVariableCalculatedDateFormat").val()            }
                ];

                cardData.push({
                    type:   "calculated_date",
                    token:  removeUnsupportedCharacters(label),
                    data:   calcDateData
                });
            }
            else {
                for(var i=cardData.length - 1; i>-1; i--) {
                    if(cardData[i].type == "calculated_date" && cardData[i].token == removeUnsupportedCharacters(label))
                        cardData.splice(i, 1);
                }
            }

            editVariable(label, newData);
            updateListOfVariables();
            fixConcatenatedFields();
        });

        function editVariable(label, newData) {
            for(var i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].label == label) {
                    templateData.template_fields[i] = newData;
                    updateTemplateFieldsTable();
                    break;
                }
            }
        }

        function getVariableByLabel(label) {
            for(var i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].label == label) {
                    return templateData.template_fields[i];
                }
            }
        }

        var editVariableSelectboxFields = ["", "", ""];

        function editVariableRemoveOptionFields() {
            editVariableSelectboxFields = [];
            $('.editVariableSelectboxOption').parent().prev().remove();
            $('.editVariableSelectboxOption').parent().remove();
        }

        function editVariableResetOptionFields() {
            editVariableRemoveOptionFields();
            editVariableAddOption("");
            editVariableAddOption("");
            editVariableAddOption("");
        }

        function editVariableAddOption(text) {
            if(!text) text="";

            editVariableSelectboxFields.push(text);

            var fieldHTML = '<div class="col-xs-4">'+
                                '<label>Option ' + editVariableSelectboxFields.length + '</label> <i class="fa fa-remove"></i>'+
                            '</div><div class="col-xs-8">'+
                                '<input type="text" value="'+text+'" class="form-control editVariableSelectboxOption">'+
                            '</div>';

            $('#editVariableSelectboxAdd').parent().prev().before(fieldHTML);
        }

        $('#editVariableSelectboxAdd').on("click", function(){
            editVariableAddOption("");
        });

        $(document).on("input", ".editVariableSelectboxOption", function(){
            var id = parseInt($(this).parent().prev().text().split(" ")[1]);

            if(editVariableSelectboxFields.length < id-1) {
                alert("Error: Couldn't find the field #"+id);
                return;
            }

            editVariableSelectboxFields[id-1] = $(this).val();
        });

        function editVariableRemoveConcatenatedFields() {
            $('#editVariableConcatenation').val("");

            $('.editVariableConcatenatedField').parent().prev().remove();
            $('.editVariableConcatenatedField').parent().remove();

            $('.editVariableConcatenatedFieldNew').parent().prev().remove();
            $('.editVariableConcatenatedFieldNew').parent().remove();

        }

        function editVariableResetConcatenatedFields() {
            editVariableRemoveConcatenatedFields();
            editVariableAddConcatenatedField("", true);
            editVariableAddConcatenatedField("", true);
        }

        function editVariableAddConcatenatedField(token, isNew) {
            var id = parseInt($('#editVariableConcatenatedAdd').parent().prev().prev().prev().text().split(" ")[1]);

            if(!id || !parseInt(id)) id = 0;
            id++;

            if(isNew) {
                var fieldHTML = '<div class="col-xs-4">' +
                        '<label>Field ' + id + '</label> <i class="fa fa-remove"></i>' +
                        '</div><div class="col-xs-8">' +
                        '<input type="text" class="form-control editVariableConcatenatedFieldNew" data-prev="' + token + '" value="' + token + '"></div>';

                $('#editVariableConcatenatedAdd').parent().prev().before(fieldHTML);

                return;
            }

            var listOfVariables = [];

            for(var i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].type != "image") {
                    listOfVariables.push({
                        token: templateData.template_fields[i].token,
                        label: templateData.template_fields[i].label
                    });
                }
            }

            if(!listOfVariables || !listOfVariables[0] || !listOfVariables[0].token) {
                alert("Error! Couldn't find any variables");
                return;
            }

            var selectedToken = token;
            if(!selectedToken) selectedToken = listOfVariables[0].token;

            var fieldHTML = '<div class="col-xs-4">' +
                    '<label>Field ' + id + '</label> <i class="fa fa-remove"></i>' +
                    '</div><div class="col-xs-8">' +
                    '<select class="form-control editVariableConcatenatedField" data-prev="' + listOfVariables[0].token + '">';

            for(var i=0; i<listOfVariables.length; i++) {
                var selected = "";
                if(listOfVariables[i].token == token) selected = " selected";

                fieldHTML += '<option value="' + listOfVariables[i].token + '"' + selected + '>' + listOfVariables[i].label + '</option>';
            }

            fieldHTML += '</select></div>';

            $('#editVariableConcatenatedAdd').parent().prev().before(fieldHTML);

            if(!token) {
                var concText = $('#editVariableConcatenation').val() + " {{{" + listOfVariables[0].token + "}}}";
                $('#editVariableConcatenation').val(concText);
            }
        }

        $('#editVariableConcatenatedAdd').on("click", function(){
            editVariableAddConcatenatedField();
        });

        $('#editVariableConcatenatedAddNew').on("click", function() {
            editVariableAddConcatenatedField("", true);
        });

        String.prototype.reverse = function () {
            return this.split('').reverse().join('');
        };

        String.prototype.replaceLast = function (what, replacement) {
            return this.reverse().replace(new RegExp(what.reverse()), replacement.reverse()).reverse();
        };

        function editVariableUpdateConcatenation(oldToken, newToken) {
            var str = $('#editVariableConcatenation').val(),
                space = "";

            if(str && str.length>0) space = " ";

            if(newToken)
                newToken = "{{{"+newToken+"}}}";
            else
                newToken = "";

            if(oldToken && str.indexOf("{{{"+oldToken+"}}}") > -1)
                str = str.replaceLast("{{{"+oldToken+"}}}", newToken);
            else if(newToken)
                str += space+newToken;

            $('#editVariableConcatenation').val(str);

            editVariableConcatenationCheckForSpaces();
        }

        function editVariableConcatenationCheckForSpaces() {
            var text = $('#editVariableConcatenation').val(),
                unnecessarySpaces = false;

            if(text.slice(0, 1) == " " || text.slice(-1) == " " || text.indexOf("  ") > -1)
                unnecessarySpaces = true;

            if(unnecessarySpaces)
                $('#editVariableConcatenation').next().removeClass('hidden');
            else
                $('#editVariableConcatenation').next().addClass('hidden');
        }

        $('#editVariableConcatenation').on("input", function(){
            editVariableConcatenationCheckForSpaces();
        });

        $(document).on("change", ".editVariableConcatenatedField", function(){
            editVariableUpdateConcatenation($(this).data("prev"), $(this).val());

            $(this).data("prev", $(this).val());
        });

        $(document).on("input", ".editVariableConcatenatedFieldNew", function() {
            var oldVal = $(this).data("prev"),
                newVal = $(this).val();

            editVariableUpdateConcatenation(oldVal, removeUnsupportedCharacters(newVal));

            $(this).data("prev", removeUnsupportedCharacters(newVal));
        });

        $(document).on("click", ".editVariableConcatenated .fa-remove", function(){
            var oldToken = $(this).parent().next().find(".form-control").data("prev");

            if(!$(this).parent().next().find(".form-control").hasClass("editVariableConcatenatedField")) {
                var id = parseInt($(this).prev().text().split(" ")[1]);

                if(editVariableSelectboxFields.length < id-1) {
                    alert("Error: Couldn't find the field #"+id);
                    return;
                }

                editVariableSelectboxFields.splice(id - 1, 1);
            }

            editVariableUpdateConcatenation(oldToken);

            $(this).parent().next().remove();
            $(this).parent().remove();

            var i = 1;
            $('.editVariableConcatenated').find("label").each(function(){
                if($(this).text() != "Concatenation") {
                    $(this).text("Field " + i);
                    i++;
                }
            });
        });

        $(document).on("click", ".editVariableSelectbox .fa-remove", function(){
            var id = parseInt($(this).prev().text().split(" ")[1]);

            if(editVariableSelectboxFields.length < id-1) {
                alert("Error: Couldn't find the field #"+id);
                return;
            }

            editVariableSelectboxFields.splice(id - 1, 1);

            $(this).parent().next().remove();
            $(this).parent().remove();

            var i = 1;
            $('.editVariableSelectbox').find("label").each(function(){
                $(this).text("Option " + i);
                i++;
            });
        });

        function fixConcatenatedFieldsJSON(data, fields) {
            if(!data || !data.objects || data.objects.length == 0) return data;

            var concatFields = [];

            for(var i=0; i<fields.length; i++) {
                if(fields[i].type == "concatenated") {
                    var label = "";
                    if(!fields[i].label)
                        label = fields[i].token;
                    else
                        label = fields[i].label;

                    concatFields.push({
                        label: label,
                        concatenation: fields[i].concatenation
                    });
                }
            }

            if(concatFields.length == 0) return data;

            for(var i=0; i<data.objects.length; i++) {
                if (data.objects[i].type == "static-text" && data.objects[i].variable) {
                    for(var z=0; i<concatFields.length; i++) {
                        if(stripBrackets(data.objects[i].text) == removeUnsupportedCharacters(concatFields[z].label)) {
                            data.objects[i].concatenation = concatFields[z].concatenation;
                        }
                    }
                }
            }
        }

        function fixConcatenatedFields() {
            var concatFields = [];

            for(var i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].type == "concatenated") {
                    concatFields.push({
                        label: templateData.template_fields[i].label,
                        concatenation: templateData.template_fields[i].concatenation
                    });
                }
            }

            canvas.forEachObject(function(obj) {
                if(obj.type == "static-text" && obj.variable) {
                    var concat = false;

                    for(var i=0; i<concatFields.length; i++) {
                        if(obj.text == concatFields[i].label) {
                            concat = true;
                            obj.concatenation = concatFields[i].concatenation;
                        }
                    }

                    if(!concat)
                        obj.concatenation = "";
                }
            });

            if(sides=="double" && getUnselectedSide().json != "") {
                var data = JSON.parse(getUnselectedSide().json);

                for (var i = 0; i < data.objects.length; i++) {
                    if (data.objects[i].type == "static-text" && data.objects[i].variable) {
                        var concat = false;

                        for(var z=0; i<concatFields.length; i++) {
                            if(data.objects[i].text == concatFields[z].label) {
                                concat = true;
                                data.objects[i].concatenation = concatFields[z].concatenation;
                            }
                        }

                        if(!concat)
                            data.objects[i].concatenation = "";
                    }
                }
            }
        }

        // Save & Save As...

        $('#modalSaveAsTemplateName').on("input", function(){
            if($(this).val()=="") $('#modalSaveAsTemplateSave').prop("disabled", true);
            else $('#modalSaveAsTemplateSave').prop("disabled", false);
        });

        $('#modalSaveAsTemplateName').keyup(function (e) {
            if (e.keyCode == 13) {
                $('#modalSaveAsTemplateSave').trigger('click');
            }
        });

        $('#menuTemplateSave').on("click", function(){
            if(templateData.templateID==-1) {
                $('#menuTemplateSaveAs').trigger("click");
                return;
            }

            loadingCanvas(true);

            if(sides=="double") {
                flipSides(flipSides);
            }

            saveCheckLoading();
        });

        function saveAs() {
            unlockSelection();
            fixImageFieldsDimensions();

            var //template_fields = templateFieldsJSON(),
                    template_fields = templateData.template_fields,
                    card_data = templateCardData();

            var fixed_data = fixMagstripeTokens(template_fields, card_data);

            template_fields = removeRepeatingTokens(fixed_data.template_fields);
            card_data = fixed_data.card_data;

            checkForBrokenObjects(templateDataJSON("front"), templateDataJSON("back"), template_fields);

            $.ajax({
                type: 'POST',
                url: config.apiURL+'card_templates?organization_id='+$('#modalSaveAsOrganization').val(),
                data: {
                    "card_template[card_type_id]":      templateData.cardTypeID,
                    "card_template[name]":              $('#modalSaveAsTemplateName').val(),
                    "card_template[front_data]":        templateDataJSON("front"),
                    "card_template[back_data]":         templateDataJSON("back"),
                    "card_template[options]":           templateOptionsJSON(),
                    "card_template[template_fields]":   JSON.stringify(template_fields),
                    "card_template[card_data]":         card_data,
                    "card_template[special_handlings]": templateSpecialHandlings()
                },
                success: function (data) {
                    var newOrgID = $('#modalSaveAsOrganization').val();

                    if(newOrgID != templateData.organizationID)
                        getAllImagesBase64FromTemplate(data);
                    else
                        loadingCanvas(false);

                    updateTemplateData(data);
                    updateHeader();
                    loadFonts(newOrgID);
                    loadLetters(newOrgID, letter);
                    loadSpecialHandlings(newOrgID, data.special_handlings);

                    updateCardTypes();
                    setSelectedCardType(getCardTypeArrayIDbyID(templateData.cardTypeID));
                },
                error: function (response) {
                    loadingCanvas(false);
                    alert(JSON.stringify(response));
                }
            });
        }

        function save() {
            unlockSelection();
            fixImageFieldsDimensions();

            var //template_fields = templateFieldsJSON(),
                    template_fields = templateData.template_fields,
                    card_data = templateCardData();

            var fixed_data = fixMagstripeTokens(template_fields, card_data);

            template_fields = removeRepeatingTokens(fixed_data.template_fields);
            card_data = fixed_data.card_data;

            checkForBrokenObjects(templateDataJSON("front"), templateDataJSON("back"), template_fields);

            $.ajax({
                type: 'PATCH',
                url: config.apiURL+'card_templates/'+templateData.templateID+'?organization_id='+templateData.organizationID,
                data: {
                    "card_template[card_type_id]":      templateData.cardTypeID,
                    "card_template[front_data]":        templateDataJSON("front"),
                    "card_template[back_data]":         templateDataJSON("back"),
                    "card_template[options]":           templateOptionsJSON(),
                    "card_template[template_fields]":   JSON.stringify(template_fields),
                    "card_template[card_data]":         card_data,
                    "card_template[special_handlings]": templateSpecialHandlings()
                },
                success: function (data) {
                    loadingCanvas(false);
                    console.log(data);
                },
                error: function (data) {
                    loadingCanvas(false);
                    alert(JSON.stringify(data));
                }
            });
        }

        function saveAsCheckLoading() {
            if(loadingCanvasCounter>0) {
                window.setTimeout(saveAsCheckLoading, 100);
            } else {
                saveAs();
            }
        }

        function saveCheckLoading() {
            if(loadingCanvasCounter>0) {
                window.setTimeout(saveCheckLoading, 100);
            } else {
                save();
            }
        }

        $('#modalSaveAsTemplateSave').on("click", function(){
            if($(this).prop('disabled')) return;

            $('#modalSaveAsTemplate').modal('hide');

            loadingCanvas(true);

            if(sides=="double") {
                flipSides(flipSides);
            }

            saveAsCheckLoading();
        });

        function getAllImagesBase64FromTemplate(data) {
            var images = [];

            function checkIfImageIsInTheArray(oldURL) {
                var used = false;

                images.forEach(function(item) {
                    if(item && item == oldURL)
                        used = true;
                });

                return used;
            }

            function getBASE64(url) {
                return new Promise(function(resolve, reject){
                    var img64 = new Image();
                    img64.crossOrigin = 'Anonymous';
                    img64.onload = function(){
                        // This doesn't work in my firefox for some reason because of some "security" issues
                        var canvas64 = document.createElement('CANVAS'),
                            ctx = canvas64.getContext('2d'), dataURL;
                        canvas64.height = this.height;
                        canvas64.width = this.width;
                        ctx.drawImage(this, 0, 0);
                        dataURL = canvas64.toDataURL('png');
                        canvas64 = null;
                        return resolve({url: url, base64: dataURL});
                    };
                    img64.src = url;
                });
            }

            var side = 0;

            while(side<2) {
                side++;

                var tmplt = {};

                if(side == 1 && data.front_data)
                    tmplt = JSON.parse(data.front_data);
                else if(side == 2 && data.back_data)
                    tmplt = JSON.parse(data.back_data);

                if(!tmplt || !tmplt.objects || tmplt.objects.length == 0)
                    continue;

                for(var i=0; i<tmplt.objects.length; i++) {
                    if(!tmplt.objects[i].type || tmplt.objects[i].type != "image")
                        continue;

                    // check for repeats
                    if(checkIfImageIsInTheArray(tmplt.objects[i].src)) continue;

                    // add url to the array
                    images.push(tmplt.objects[i].src);
                }

                if(     tmplt.backgroundImage &&
                        tmplt.backgroundImage.src &&
                        tmplt.backgroundImage.src.length > 1 &&
                        tmplt.backgroundImage.src[0] != "d" &&
                        !checkIfImageIsInTheArray(tmplt.backgroundImage.src)    )
                    images.push(tmplt.backgroundImage.src);
            }

            if(images.length == 0) {
                loadingCanvas(false);
                return;
            }

            var promises = images.map(getBASE64);

            Promise.all(promises)
                    .then(imageData => {
                        images = imageData;

                        uploadImagesToTheNewOrganization(data, images);
                    })
                    .catch(reason => {
                        console.log("Error: couldn't get base64 data of all images");
                        warning("Error: image uploading has failed");
                        loadingCanvas(false);
                    });
        }

        function uploadImagesToTheNewOrganization(data, images) {
            if(images.length == 0) {
                console.log("NO IMAGES");
                loadingCanvas(false);
                return;
            }

            imagesToUpload = images.length;

            for(i=0; i<images.length; i++) {
                var oldUrl = images[i].url,
                    path = oldUrl.split("/"),
                    imgName = path[path.length-1];

                var imgBlob = base64toBlob(images[i].base64);
                var imgFile = blobToFile(imgBlob, imgName);

                var fd = new FormData();
                fd.append('card_template[images][]', imgFile, imgName);

                $.ajax({
                    type: 'POST',
                    url: config.apiURL+'card_templates/'+data.id+'/upload?organization_id='+data.organization_id,
                    async: false,
                    data: fd,
                    contentType: false,
                    processData: false,
                    cache: false,
                    success: function (imgData) {
                        imagesToUpload--;

                        //var newUrl = imgData.images[imgData.images.length-1].url; // should be 0? parse urls to get the latest id?
                        var newUrl = "";

                        for(var z=0; z<imgData.images.length; z++) {
                            var thisPath = imgData.images[z].url.split("/"),
                                thisName = thisPath[thisPath.length-1];

                            if(thisName == imgName)
                                newUrl = imgData.images[z].url;
                        }

                        console.log("IMAGE UPLOADED");
                        console.log(oldUrl);
                        console.log(newUrl);

                        data.front_data = JSON.parse(JSON.stringify(data.front_data).replace(oldUrl, newUrl));
                        data.back_data = JSON.parse(JSON.stringify(data.back_data).replace(oldUrl, newUrl));

                        if(imagesToUpload == 0) {
                            console.log("WILL BE PATCHED");
                            console.log(data);
                            $.ajax({
                                type: 'PATCH',
                                url: config.apiURL+'card_templates/'+data.id+'?organization_id='+data.organization_id,
                                data: {
                                    "card_template[front_data]":        data.front_data,
                                    "card_template[back_data]":         data.back_data
                                },
                                success: function () {
                                    console.log("patched!");
                                    loadCardTemplate(data.organization_id, data.id);
                                    loadingCanvas(false);
                                },
                                error: function (data) {
                                    console.log("PATCH error");
                                    loadCardTemplate(data.organization_id, data.id);
                                    loadingCanvas(false);
                                    alert(JSON.stringify(data));
                                }
                            });
                        }
                    },
                    error: function (response) {
                        loadingCanvas(false);
                        alert("Ooops! Couldn't upload images");
                        console.log('error: '+JSON.stringify(response));
                    }
                });
            }
        }

        $('#modalSaveAsTemplate').on('shown.bs.modal', function() {
            updateOrganizationsSelect('#modalSaveAsOrganization', templateData.organizationID);
            $('#modalSaveAsTemplateName').val("");
            $('#modalSaveAsTemplateSave').prop('disabled', true);
        });

        $('#modalSaveAsTemplate').on('hidden.bs.modal', function () {
            $('#modalSaveAsTemplateWarning').addClass('hidden');
            if(templateData.templateID == -1) {
                $('#modalSelectImage, #modalSelectBG').modal('hide');
            }
            else {
                if($('#modalSelectImage').hasClass('in')) {
                    updateImageList();
                }
                else if($('#modalSelectBG').hasClass('in')) {
                    updateBGImageList();
                }
            }
        });

        function updateOrganizationsSelect(selector, orgID, tempID) { // only works with IDs for some reason!
            if($(selector).val() == orgID && selector == '#modalLoadTemplateOrganization') { // no need to update the list

                if($('#modalLoadTemplateTemplate').val() != tempID)
                    updateTemplatesSelect('#modalLoadTemplateTemplate', orgID, tempID);

                return;
            }

            $.ajax({
                type: 'GET',
                url: config.apiURL+'organizations',
                success: function (organizations) {
                    $(selector).removeClass('hidden');
                    $(selector).empty();

                    organizations.sort(dynamicSort("name"));

                    for(i=0; i<organizations.length; i++) {
                        $(selector).append('<option value="'+organizations[i].id+'">'+organizations[i].name+'</option>');
                    }

                    $(selector).selectpicker('refresh');

                    var sel = orgID;
                    if(sel == -1) sel = organizations[0].id;
                    $(selector).selectpicker('val', sel);

                    if(selector == '#modalLoadTemplateOrganization') updateTemplatesSelect('#modalLoadTemplateTemplate', sel, tempID);
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function updateTemplatesSelect(selector, organizationID, selectID) {
            $.ajax({
                type: 'GET',
                url: config.apiURL+'card_templates?organization_id='+organizationID,
                success: function (templates) {
                    $(selector).empty();

                    templates.sort(dynamicSort("name"));

                    for(i=0; i<templates.length; i++) {
                        $(selector).append('<option value="'+templates[i].id+'">'+templates[i].name+'</option>');
                    }

                    $(selector).selectpicker('refresh');

                    if(!templates[0]) return;

                    var sel = templates[0].id;
                    if(selectID && selectID != -1) sel = selectID;
                    $(selector).selectpicker('val', sel);

                    onTemplateSelected(sel);
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function fixMagstripeTokens(template_fields, card_data) {
            card_data = JSON.parse(card_data);

            for(i=0; i<template_fields.length; i++) {
                if(template_fields[i].type == "track1" || template_fields[i].type == "track2" || template_fields[i].type == "track3") {
                    if(!template_fields[i].label)
                        template_fields[i].label = template_fields[i].token;

                    template_fields[i].token = removeUnsupportedCharacters(template_fields[i].token);
                }
            }

            for(i=0; i<card_data.length; i++) {
                //console.log(card_data[i].type);
                if(card_data[i].type == "magstripe") {
                    for(z=0; z<card_data[i].data.length; z++) {
                        if(card_data[i].data[z].track1 && card_data[i].data[z].track1.substring(0, 3) == "{{{")
                            card_data[i].data[z].track1 = "{{{" + removeUnsupportedCharacters(card_data[i].data[z].track1) + "}}}";
                        if(card_data[i].data[z].track2 && card_data[i].data[z].track2.substring(0, 3) == "{{{")
                            card_data[i].data[z].track2 = "{{{" + removeUnsupportedCharacters(card_data[i].data[z].track2) + "}}}";
                        if(card_data[i].data[z].track3 && card_data[i].data[z].track3.substring(0, 3) == "{{{")
                            card_data[i].data[z].track3 = "{{{" + removeUnsupportedCharacters(card_data[i].data[z].track3) + "}}}";
                    }
                }
            }

            // 03.13.2016
            if(templateData.cardTypeID == cardTypeIDs.magStripe) {
                var track1label = $('#magstripeTrack1  option:selected').text(),
                    track2label = $('#magstripeTrack2  option:selected').text(),
                    track3label = $('#magstripeTrack3  option:selected').text();

                for (i = 0; i < template_fields.length; i++) {
                    if (template_fields[i].type == "track1" && track1label && track1label.length > 0) {
                        template_fields[i].label = track1label;
                        template_fields[i].token = removeUnsupportedCharacters(track1label);
                    }
                    else if (template_fields[i].type == "track2" && track2label && track2label.length > 0) {
                        template_fields[i].label = track2label;
                        template_fields[i].token = removeUnsupportedCharacters(track2label);
                    }
                    else if (template_fields[i].type == "track3" && track3label && track3label.length > 0) {
                        template_fields[i].label = track3label;
                        template_fields[i].token = removeUnsupportedCharacters(track3label);
                    }
                }
            }

            return {template_fields: template_fields, card_data: JSON.stringify(card_data)};
        }

        function fixMissingVariablesFromCardData(template_fields, card_data) {
            for(i=0; i<card_data.length; i++) {
                var value = [],
                        type = card_data[i].type;

                if(type == "barcode") {
                    value.push({type: type, val: stripBrackets(card_data[i].data[1].barcode)});
                }
                else if(type == "qrcode") {
                    value.push({type: type, val: stripBrackets(card_data[i].data[0].qrcode)});
                }
                else if(type == "magstripe") {
                    for(var z=0; z<card_data[i].data.length; z++) {
                        if(card_data[i].data[z].track1 && card_data[i].data[z].track1.substring(0, 3)=="{{{")
                            value.push({type: "track1", val: stripBrackets(card_data[i].data[z].track1)});
                        if(card_data[i].data[z].track2 && card_data[i].data[z].track2.substring(0, 3)=="{{{")
                            value.push({type: "track2", val: stripBrackets(card_data[i].data[z].track2)});
                        if(card_data[i].data[z].track3 && card_data[i].data[z].track3.substring(0, 3)=="{{{")
                            value.push({type: "track3", val: stripBrackets(card_data[i].data[z].track3)});
                    }
                }

                // check if a variable with required type and token exists
                for(var z=0; z<value.length; z++) {
                    var exists = false;

                    for(var y=0; y<template_fields.length; y++) {
                        if(template_fields[y].type == value[z].type && template_fields[y].token == value[z].val)
                            exists = true;
                    }

                    if(!exists) {
                        var label = false;

                        for(var y=0; y<template_fields.length; y++) {
                            if(template_fields[y].token == value[z].val)
                                label = template_fields[y].label;
                        }

                        if(!label) label = value[z].val;

                        template_fields.push({
                            type: value[z].type,
                            token: value[z].val,
                            label: label
                        });
                    }
                }
            }

            return template_fields;
        }

        function fixMagstripeTokensOnLoad(template_fields, card_data) {
            var isMagstripe = false,
                oldMagstripeData,
                track1 = false,
                track2 = false,
                track3 = false;

            for(i=0; i<card_data.length; i++) {
                if(card_data[i].type == "magstripe") {
                    isMagstripe = true;
                    oldMagstripeData = card_data[i].data;
                }
            }

            if(!isMagstripe) return {template_fields: template_fields, card_data: card_data};

            for(i=0; i<template_fields.length; i++) {
                switch(template_fields[i].type) {
                    case "track1":
                        template_fields[i].token = template_fields[i].label;
                        track1 = '{{{'+template_fields[i].token+'}}}';
                        break;
                    case "track2":
                        template_fields[i].token = template_fields[i].label;
                        track2 = '{{{'+template_fields[i].token+'}}}';
                        break;
                    case "track3":
                        template_fields[i].token = template_fields[i].label;
                        track3 = '{{{'+template_fields[i].token+'}}}';
                        break;
                    default:
                        break;
                }
            }

            for(i=0; i<oldMagstripeData.length; i++) {
                if(track1 && oldMagstripeData[i].track1)
                    oldMagstripeData[i].track1 = track1;
                if(track2 && oldMagstripeData[i].track2)
                    oldMagstripeData[i].track2 = track2;
                if(track3 && oldMagstripeData[i].track3)
                    oldMagstripeData[i].track3 = track3;
            }

            for(i=0; i<card_data.length; i++) {
                if(card_data[i].type == "magstripe") {
                    card_data[i].data = oldMagstripeData;
                }
            }

            return {template_fields: template_fields, card_data: card_data};
        }

        function removeRepeatingTokens(template_fields) {
            // remove repeating tokens
            //var new_template_fields = template_fields.filter(function(item, pos, self) {
            //    return self.indexOf(item) == pos;
            //});
            //TODO
            //return template_fields;
            var new_template_fields = template_fields;

            // find the biggest var image and remove the other one
            var listOfImageTokens = [];

            for(var i=0; i<new_template_fields.length; i++) {
                if(new_template_fields[i].type!="image") {
                    listOfImageTokens.push(new_template_fields[i]);
                    continue;
                }

                var used = false;

                for(var z=0; z<listOfImageTokens.length; z++) {
                    if(new_template_fields[i].token == listOfImageTokens[z].token) {
                        used = true;
                        if(new_template_fields[i].dimensions.width > listOfImageTokens[z].dimensions.width) {
                            listOfImageTokens[z].dimensions = new_template_fields[i].dimensions;
                        }
                    }
                }

                if(!used) {
                    listOfImageTokens.push(new_template_fields[i]);
                }
            }

            // remove repeating text variables
            var template_fields_new = [];

            for(var i=0; i<listOfImageTokens.length; i++) {
                if(listOfImageTokens[i].type == "image") {
                    template_fields_new.push(listOfImageTokens[i]);
                    continue;
                }

                var isUsed = false;
                for(var z=0; z<template_fields_new.length; z++) {
                    if(listOfImageTokens[i].type != "placeholder" && listOfImageTokens[i].label == template_fields_new[z].label)
                        isUsed = true;
                }

                if(!isUsed)
                    template_fields_new.push(listOfImageTokens[i]);
            }

            return template_fields_new;
        }

        function getAllImageUrls() {
            var urls = [];
            var uniqueUrls = [];

            var z=2;

            while(z>0) {
                var data;

                if(z==2) {
                    var _template = prepareTemplateForSaving(JSON.stringify(canvas));

                    if(_template == "") {
                        z--;
                        continue;
                    }

                    data = JSON.parse(_template).objects;
                }
                else {
                    if(!getUnselectedSide().json) {
                        z--;
                        continue;
                    }

                    data = JSON.parse(getUnselectedSide().json).objects;
                }

                for (i = 0; i < data.length; i++) {
                    if (data[i].type == "image") {
                        urls.push(data[i].src);
                    }
                }

                z--;
            }

            if(urls.length == 0) return [];

            // remove repeating urls
            $.each(urls, function(i, el){
                if($.inArray(el, uniqueUrls) === -1) uniqueUrls.push(el);
            });

            return uniqueUrls;
        }

        function getAllImagesBase64() {
            var urls = getAllImageUrls();
            var images = [];

            if (urls.length==0) return [];

            $( ".imageListPic img" ).each( function( i, el ) {
                var elem = $( el );
                var oldUrl = elem.attr('data-url');

                for(i=0; i<urls.length; i++) {
                    if(urls[i] == oldUrl) {
                        images.push({
                            url: oldUrl,
                            base64: elem.attr("src")
                        });
                        continue;
                    }
                }
            });

            return images;
        }

        function base64toBlob(dataURI, callback) {
            // convert base64 to raw binary data held in a string
            // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
            var byteString = atob(dataURI.split(',')[1]);

            // separate out the mime component
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]

            // write the bytes of the string to an ArrayBuffer
            var ab = new ArrayBuffer(byteString.length);
            var ia = new Uint8Array(ab);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            // write the ArrayBuffer to a blob, and you're done
            var bb = new Blob([ab], { type: 'image/jpeg' });
            return bb;
        }

        function blobToFile(theBlob, fileName){
            theBlob.lastModifiedDate = new Date();
            theBlob.name = fileName;
            return theBlob;
        }

        function checkForBrokenObjects(front, back, template_fields) {
            var loop = 0,
                data,
                error = false,
                template_fields_error = false;

            if(front) front = JSON.parse(front);
            if(back) back = JSON.parse(back);

            if(front) data = front;
            else if(back) data = back;
            else loop = 2;

            while(loop<2) {
                var listOfTextIDs = [],
                    listOfRectIDs = [];

                for(var i=0; i<data.objects.length; i++) {
                    // check if any objects use deleted variables
                    var checkToken = "";
                    if(data.objects[i].type == "static-text" && data.objects[i].variable && data.objects[i].fieldName)
                        checkToken = removeUnsupportedCharacters(data.objects[i].fieldName);
                    else if(data.objects[i].type == "barcode" && data.objects[i].textType == "variable" && data.objects[i].text)
                        checkToken = removeUnsupportedCharacters(data.objects[i].text);

                    if(checkToken.length > 0) {
                        var used = false;

                        for(var z=0; z<template_fields.length; z++) {
                            if(template_fields[z].token && template_fields[z].token == checkToken)
                                used = true;
                        }

                        if(!used) template_fields_error = true;
                    }



                    var leftPadding1 = -scale(leftPadding, 1012 / 457),
                        leftPadding2 = -scale(leftPadding, 457 / 1012),
                        topPadding1 = -scale(topPadding, 1012 / 457),
                        topPadding2 = -scale(topPadding, 457 / 1012),
                        top = data.objects[i].top,
                        left = data.objects[i].left;

                    if(top === null || top == -topPadding || top == topPadding1 || top == topPadding2) error = true;
                    if(left === null || left == -leftPadding || left == leftPadding1 || left == leftPadding2) error = true;

                    if(data.objects[i].type == "static-text")
                        listOfTextIDs.push(data.objects[i].textID);
                    else if(data.objects[i].type == "rect" && data.objects[i].textID)
                        listOfRectIDs.push(data.objects[i].textID);
                }

                if(listOfTextIDs.length != listOfRectIDs.length) error = true;

                for(var i=0; i<listOfTextIDs.length; i++) {
                    var found = false;

                    for(var z=0; z<listOfRectIDs.length; z++) {
                        if(listOfTextIDs[i] == listOfRectIDs[z])
                            found = true;
                    }

                    if(!found) error = true;
                }

                if(loop == 0 && !back) loop = 2;
                data = back;
                loop++;
            }

            if(error) alert("There might be a ghost text object in this template, please check both sides. DO NOT print this card until this error is fixed!");
            if(template_fields_error) alert("An object uses a variable field that doesn't exist, please check both sides. DO NOT print this card until this error is fixed!");
        }

        //
        $('#menuPreview').on('click', function(){
            if($(this).prop('disabled')) return;

            if(templateData.templateID == -1) {
                warning("Incorrect TemplateID");
                return;
            }

            var win = window.open(window.location.origin + '/admin/card_templates/' + templateData.templateID + '/preview', '_blank');
            if (win) {
                //Browser has allowed it to be opened
                win.focus();
            } else {
                //Browser has blocked it
                warning('Please allow popups for this website');
            }
        });

        // Tools
        $('.btn-tool').on("click", function() {
            if($(this).attr('id')=="newImage") return;

            selectTool($(this).attr('id'));
        });

        // Front or Back
        $('#sideFront, #sideBack').on("click", function() {
            if($(this).hasClass("active")) return;

            loadingCanvas(true);

            $('#sideFront, #sideBack').removeClass("active");
            $(this).addClass("active");
            flipSides();

            setTimeout(function(){
                loadingCanvas(false);
            },500);
        });

        // Undo & Redo
        $('#undo').on("click", function() {
            undo();
        });

        $('#redo').on("click", function() {
            redo();
        });

        // Layers
        $(document).on("click", ".layerUp", function (event) {
            event.preventDefault();

            var objID = parseInt($(this).closest('li').attr('id').substr(5)),
                object = canvas.item(objID),
                skip = 1;

            if(!isTextRect(object) && canvas.item(objID+1) && (isTextRect(canvas.item(objID+1)) || canvas.item(objID+1).type=="static-text"))
                skip++;

            for(i=0; i<skip; i++) {
                canvas.bringForward(object);

                if (isTextRect(object)) {
                    canvas.bringForward(object);
                    canvas.bringForward(getTextByTextID(object.textID));
                    canvas.bringForward(getTextByTextID(object.textID));
                }
            }

            moveAdditionalLayersToTheTop();
            updateLayerList();
        });

        $(document).on("click", ".layerUpAll", function (event) {
            event.preventDefault();

            var objID = $(this).closest('li').attr('id').substr(5),
                object = canvas.item(objID);

            canvas.bringToFront(object);

            if(isTextRect(object))
                canvas.bringToFront(getTextByTextID(object.textID));

            moveAdditionalLayersToTheTop();
            updateLayerList();
        });

        $(document).on("click", ".layerDown", function (event) {
            event.preventDefault();

            var objID = parseInt($(this).closest('li').attr('id').substr(5)),
                object = canvas.item(objID),
                skip = 1;

            if(canvas.item(objID-1) && (isTextRect(canvas.item(objID-1)) || canvas.item(objID-1).type=="static-text"))
                skip++;

            for(i=0; i<skip; i++) {
                canvas.sendBackwards(object);

                if (isTextRect(object)) {
                    canvas.sendBackwards(getTextByTextID(object.textID));
                }
            }

            moveAdditionalLayersToTheTop();
            updateLayerList();
        });

        $(document).on("click", ".layerDownAll", function (event) {
            event.preventDefault();

            var objID = $(this).closest('li').attr('id').substr(5),
                object = canvas.item(objID);

            canvas.sendToBack(object);

            if(isTextRect(object))
                canvas.sendToBack(getTextByTextID(object.textID));

            moveAdditionalLayersToTheTop();
            updateLayerList();
        });

        $(document).on("click", ".layerText", function (event) {
            event.preventDefault();

            if(lockedObject || lockedGroup) return;

            var li = $(this).closest('li');
            var objID = li.attr('id').substr(5);
            var wasSelected = li.hasClass("active");

            // if pressed with shift then add to or remove from selection
            if(shiftPressed) {
                if(canvas.getActiveGroup() && !wasSelected) { // add to group
                    canvas.getActiveGroup().addWithUpdate(canvas.item(objID));
                    canvas.getActiveGroup().setCoords();
                    canvas.fire('selection:created', {target: canvas.getActiveGroup()});
                    li.addClass("active");
                }
                else if(canvas.getActiveObject() && !wasSelected) { // create active group
                    var group = new fabric.Group([canvas.getActiveObject(), canvas.item(objID)], {
                        canvas: canvas
                    });
                    group.addWithUpdate();
                    canvas.setActiveGroup(group);
                    group.saveCoords();
                    canvas.fire('selection:created', { target: group });
                    li.addClass("active");
                }
                else if(canvas.getActiveGroup() && wasSelected) { // remove from the group
                    var objectToRemove = canvas.item(objID);

                    if(isTextRect(objectToRemove))
                        canvas.getActiveGroup().removeWithUpdate(getTextByTextID(objectToRemove.textID));
                    canvas.getActiveGroup().removeWithUpdate(objectToRemove);

                    canvas.getActiveGroup().setCoords();
                    canvas.fire('selection:created', {target: canvas.getActiveGroup()});
                    li.removeClass("active");
                }
                else {
                    canvas.deactivateAll();
                }

                canvas.renderAll();
            }
            else {
                canvas.deactivateAll();
                canvas.setActiveObject(canvas.item(objID));
            }
        });

        var lockedObject = false,
            lockedGroup = false,
            lockedObjectSelected = false;

        $(document).on("click", ".fa-lock", function(event) {
            if($(this).hasClass("active"))
                unlockSelection();
            else
                lockSelection();
        });

        function unlockSelection() {
            lockedObject = false;
            lockedGroup = false;
            lockedObjectSelected = false;

            canvas.selection = true;
            $(".fa-lock").removeClass("active");
            makeAllObjectsEvented();
            canvas.deactivateAll();
        }

        function lockSelection() {
            lockedObject = false;
            lockedGroup = false;
            lockedObjectSelected = false;

            canvas.selection = false;
            $(".fa-lock").addClass("active");
            makeAllObjectsUnevented();

            if(canvas.getActiveGroup()) {
                lockedGroup = canvas.getActiveGroup();
                lockedGroup.forEachObject(function(obj) {
                    if(!isText(obj)) {
                        obj.selectable = true;
                        obj.evented = true;
                    }
                });
            }
            else if(canvas.getActiveObject()) {
                lockedObject = canvas.getActiveObject();
                lockedObject.selectable = true;
                lockedObject.evented = true;
            }
        }


        function isTextRect(object) {
            if(object.type == "rect" && object.name == "textRect")
                return true;
            else
                return false;
        }

        function isText(object) {
            if(object.type == "static-text")
                return true;
            else
                return false;
        }

        function isGroup(object) {
            if(object._objects) return true;

            return false;
        }

        /////////////////////////////////////////////////////////////
        //                                                         //
        //                          TABS                           //
        //                                                         //
        /////////////////////////////////////////////////////////////

        $('.nav-tabs a').on("click", function (event) {
            event.preventDefault();
            $('.nav-tabs li').removeClass('active');
            $(this).parent().addClass('active');
            $('.tab').addClass('hidden');
            var tabName = $(this).attr("class");
            $('#'+tabName).removeClass('hidden');
        });

        // TAB: Text Edit

        $('#editTextText').on("input", function(event) {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            text.setText($(this).val());
            //updateAlign(text);

            updateTextObject(text);
            canvas.renderAll();

            updateLayerList();
        });

        $('#editTextSize, #editVarTextSize').on("input", function(event) {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            text.setFontSize(parseInt($(this).val()));
            text.fontSizeOriginal = parseInt($(this).val());

            //updateAlign(text);
            updateTextObject(text);
            canvas.renderAll();
        });

        $('#editTextAutoResize, #editVarTextAutoResize').on('change', function() {
            switchAutoResize(canvas.getActiveObject(), $(this).is(':checked'));
        });

        $('#editTextNoClip, #editVarTextNoClip').on('change', function() {
            switchNoClip(canvas.getActiveObject(), $(this).is(':checked'));
        });

        function switchNoClip(textRect, isChecked) {
            var text = getTextByTextID(textRect.textID);

            if(isChecked)
                text.noClip = true;
            else
                text.noClip = false;

            canvas.renderAll();
        }

        function switchAutoResize(textRect, isChecked) {
            var text = getTextByTextID(textRect.textID);

            if(isChecked) {
                text.autoResize = true;
                resizeObject(text);
            }
            else {
                text.autoResize = false;
                text.set({
                    textAlign:  text.align,
                    width: text.clipWidth,
                    height: text.clipHeight,
                    fontSize: text.fontSizeOriginal,
                    scaleX: 1,
                    scaleY: 1,
                    clipTo: function (ctx) {
                        ctx.rect(this.clipLeft, this.clipTop, this.clipWidth, this.clipHeight);
                    }
                });
            }
            recalcTextPosition(text.textID);
            canvas.renderAll();
        }

        $(document).on("click", ".editTextFont, .editVarTextFont", function (event) {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            text.setFontFamily($(this).text());
            textFontDropdownSet($(this).text());
            //updateAlign(text);
            updateTextObject(text);
            canvas.renderAll();
            event.preventDefault();
        });

        $('.editTextColor, .editVarTextColor').colorpicker().on('changeColor.colorpicker', function(event){
            var text = getTextByTextID(canvas.getActiveObject().textID);
            text.setColor(event.color.toHex());

            canvas.renderAll();
        });

        $('#editTextColorPicker, #editVarTextColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        $('#editTextBold, #editVarTextBold').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);

            if(text.getFontWeight()=="normal") {
                text.setFontWeight("bold");
                $("#editTextBold, #editVarTextBold").addClass("active");
            }
            else {
                text.setFontWeight("normal");
                $("#editTextBold, #editVarTextBold").removeClass("active");
            }

            updateTextObject(text);

            canvas.renderAll();
        });

        $('#editTextItalic, #editVarTextItalic').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            if(text.getFontStyle()=="") {
                text.setFontStyle("italic");
                $("#editTextItalic, #editVarTextItalic").addClass("active");
            }
            else {
                text.setFontStyle("");
                $("#editTextItalic, #editVarTextItalic").removeClass("active");
            }

            updateTextObject(text);
            canvas.renderAll();
        });

        $('#editTextUnderline, #editVarTextUnderline').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            if(text.getTextDecoration()=="") {
                text.setTextDecoration("underline");
                $("#editTextUnderline, #editVarTextUnderline").addClass("active");
            }
            else {
                text.setTextDecoration("");
                $("#editTextUnderline, #editVarTextUnderline").removeClass("active");
            }

            updateTextObject(text);
            canvas.renderAll();
        });

        $('#editTextAlignLeft, #editVarTextAlignLeft').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);

            text.textAlign = "left";
            text.align = "left";
            //updateAlign(text);
            updateTextObject(text);
            $('#editTextAlignCenter, #editVarTextAlignCenter, #editTextAlignRight, #editVarTextAlignRight').removeClass("active");
            $(this).addClass("active");

            canvas.renderAll();
        });

        $('#editTextAlignCenter, #editVarTextAlignCenter').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);

            text.textAlign = "center";
            text.align = "center";
            //updateAlign(text);
            updateTextObject(text);
            $('#editTextAlignLeft, #editVarTextAlignLeft, #editTextAlignRight, #editVarTextAlignRight').removeClass("active");
            $(this).addClass("active");

            canvas.renderAll();
        });

        $('#editTextAlignRight, #editVarTextAlignRight').on("click", function() {
            var text = getTextByTextID(canvas.getActiveObject().textID);

            text.textAlign = "right";
            text.align = "right";
            //updateAlign(text);
            updateTextObject(text);
            $('#editTextAlignLeft, #editVarTextAlignLeft, #editTextAlignCenter, #editVarTextAlignCenter').removeClass("active");
            $(this).addClass("active");

            canvas.renderAll();
        });

        // TAB: Variable Text
        $(document).on("change","#editVarTextVariable",function (event) {
            var text = getTextByTextID(canvas.getActiveObject().textID);
            setVarText(text, $(this).val());
        });

        $('.var .fa-remove').on("click", function() {
            var parentDiv = $(this).parents().eq(3),
                nextDiv = parentDiv.next(),
                varType = nextDiv.find("input").data("type"),
                varName = $(this).parent().prev().find('option:selected').text();

            if(!varType) return;
            if(varName.length > 0) deleteVariable(varType, varName);
        }); // delete

        function deleteVariable_modal(type, label) {
            // I intentionally don't delete the removed variable from selectboxes, this way it's easier for an operator to fix objects that used this variable
            // And I think it would be bad to automatically delete these objects, or automatically assign some new variable

            for(var i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].type == type && templateData.template_fields[i].label == label) {
                    templateData.template_fields.splice(i, 1);
                    break;
                }
            }
        }

        function deleteVariable(type, name) {
            if(type == "text") {
                for(i=0; i<varTextFields.length; i++) {
                    if(name==varTextFields[i].name) {
                        varTextFields.splice(i, 1);
                        break;
                    }
                }
                updateVarTextList();

                var text = getTextByTextID(canvas.getActiveObject().textID);
                if(varTextFields.length>0) setVarTextName(text, varTextFields[0].name);
                else setVarTextName(text, "Undefined");
            }
            else if(type=="image") {
                var object = canvas.getActiveObject();

                for(i=0; i<varImageFields.length; i++) {
                    if(name==varImageFields[i].name) {
                        varImageFields.splice(i, 1);
                        break;
                    }
                }
                updateVarImageList();

                var newName = "Undefined";
                var oldName = object.name;

                if(varImageFields.length>0)
                    newName = varImageFields[0].name;
                object.set('name', newName);
                canvas.renderAll();

                templateFieldsChangeVariable("image", oldName, newName, {width: object.width, height: object.height});
            }
            else { //TODO
                for(i=0; i<varBarcodeFields.length; i++) {
                    if(name==varBarcodeFields[i].name) {
                        varBarcodeFields.splice(i, 1);
                        break;
                    }
                }

                if(type=="barcode" || type=="qrcode") {
                    var object = canvas.getActiveObject();
                    var oldLabel = object.text,
                        newLabel = false;

                    updateVarBarcodeList(object.barcodeType);
                    if(varBarcodeFields.length>0) {
                        newLabel = varBarcodeFields[0].name;
                        object.text = newLabel;
                    }
                    else object.text = "Undefined";
                    cardDataAddBarcode(object);

                    templateFieldsChangeVariable(type, oldLabel, newLabel);
                }
                else {
                    var oldLabel = name,
                        newLabel = false;

                    if(varBarcodeFields.length>0) {
                        newLabel = varBarcodeFields[0].name;
                    }

                    updateVarMagstripeLists();
                    updateMagstripeCardData();

                    templateFieldsChangeVariable(type, oldLabel, newLabel);
                }
            }
        }

        $('.var .fa-pencil').on("click", function() {
            var parentDiv = $(this).parents().eq(3),
                nextDiv = parentDiv.next(),
                input = nextDiv.find("input"),
                varName = $(this).parent().prev().find('option:selected').text();

            parentDiv.addClass("hidden");
            nextDiv.removeClass("hidden");
            input.val(varName);
            input.addClass("editing");

            /////////////////////////////////////////////////////////
            ////////////////// Warning message check ////////////////
            ////////////////// Show a message if user is trying to
            ////////////////// edit a variable that is being used in
            ////////////////// multiple objects
            var object = canvas.getActiveObject(),
                counter = 0;

            if(!object) return;

            if(isTextRect(object)) {
                var label = getTextByTextID(object.textID).text;

                canvas.forEachObject(function (obj) {
                    if (obj.type == "static-text" && obj.variable && obj.text == label)
                        counter++;
                });

                if (sides == "double" && getUnselectedSide().json != "") {
                    var data = JSON.parse(getUnselectedSide().json);

                    for (var z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == "static-text" && data.objects[z].variable && removeUnsupportedCharacters(data.objects[z].text) == removeUnsupportedCharacters(label))
                            counter++
                    }
                }
            }
            else if(object.type == "variable-image") {
                var label = object.name;

                canvas.forEachObject(function(obj) {
                    if(obj.type == "variable-image" && obj.name == label)
                        counter++;
                });

                if(sides == "double" && getUnselectedSide().json != "") {
                    var data = JSON.parse(getUnselectedSide().json);

                    for(var z = 0; z < data.objects.length; z++) {
                        if(data.objects[z].type == "variable-image" && removeUnsupportedCharacters(data.objects[z].src) == removeUnsupportedCharacters(label))
                            counter++;
                    }
                }
            }

            if(counter==2)
                warning("There's another object that uses this variable field, you might want to add a new field instead of editing this one");
            else if(counter>2)
                warning("There are " + (counter-1) + " other objects that use this variable field, you might want to add a new field instead of editing this one");
        }); // edit

        $('.var .fa-plus').on("click", function() {
            var parentDiv = $(this).parents().eq(3),
                nextDiv = parentDiv.next(),
                input = nextDiv.find("input");

            parentDiv.addClass("hidden");
            nextDiv.removeClass("hidden");
            input.val("");
            input.removeClass("editing");
        }); // add

        $('.cancelVar').on("click", function() {
            var parentDiv = $(this).parents().eq(2),
                prevDiv = parentDiv.prev();

            parentDiv.addClass("hidden");
            prevDiv.removeClass("hidden");
        }); // cancel

        $('.saveVar').on("click", function() {
            var parentDiv = $(this).parents().eq(2),
                prevDiv = parentDiv.prev(),
                input = parentDiv.find("input"),
                type = input.data("type"),
                isEditing = input.hasClass("editing"),
                oldVarName = prevDiv.find('option:selected').text();

            // get type
            if(input.val() == "") return;

            if(type=="text") {
                for(i=0; i<varTextFields.length; i++) {
                    if(input.val()==varTextFields[i].name) {
                        alert("The fields with this name already exists");
                        return;
                    }
                }

                if(!isEditing) {
                    varTextFields.push({
                        id: varTextFields.length,
                        name: input.val()
                    });
                }
                else {
                    for(i=0; i<varTextFields.length; i++) {
                        if(oldVarName == varTextFields[i].name) {
                            varTextFields[i].name = input.val();
                            break;
                        }
                    }
                }

                updateVarTextList();

                var text = getTextByTextID(canvas.getActiveObject().textID);
                setVarTextName(text, input.val());
            }
            else if(type=="image") {
                for(i=0; i<varImageFields.length; i++) {
                    if(input.val()==varImageFields[i].name) {
                        alert("The fields with this name already exists");
                        return;
                    }
                }

                if(!isEditing) {
                    varImageFields.push({
                        id: varImageFields.length,
                        name: input.val()
                    });
                }
                else {
                    for(i=0; i<varImageFields.length; i++) {
                        if(oldVarName == varImageFields[i].name) {
                            varImageFields[i].name = input.val();
                            break;
                        }
                    }
                }

                updateVarImageList();

                var object = canvas.getActiveObject();
                var newName = input.val();
                var oldName = object.name;

                object.set('name', newName);
                templateFieldsChangeVariable("image", oldName, newName, {width: object.width, height: object.height});
            }
            else if(type=="barcode" || type=="qrcode" || type=="track1" || type=="track2" || type=="track3") { //TODO
                for(i=0; i<varBarcodeFields.length; i++) {
                    if(input.val()==varBarcodeFields[i].name) {
                        alert("The fields with this name already exists");
                        return;
                    }
                }

                if(!isEditing) {
                    varBarcodeFields.push({
                        id:     varBarcodeFields.length,
                        name:   input.val(),
                        type:   [type]
                    });
                }
                else {
                    for(i=0; i<varBarcodeFields.length; i++) {
                        if(oldVarName == varBarcodeFields[i].name) {
                            varBarcodeFields[i].name = input.val();
                            break;
                        }
                    }
                }

                if(type=="barcode" || type=="qrcode") {
                    var object = canvas.getActiveObject();
                    var oldLabel = object.text,
                        newLabel = input.val();
                    updateVarBarcodeList(object.barcodeType);
                    object.text = newLabel;

                    if(type=="barcode")
                        cardDataAddBarcode(object);
                    else
                        cardDataAddQrcode(object);

                    templateFieldsChangeVariable(type, oldLabel, newLabel);
                }
                else {
                    var magData = getMagstripeCardData();
                    var newLabel = input.val(),
                        oldLabel = false;

                    if(isEditing) oldLabel = oldVarName;

                    var newVar = '{{{'+input.val()+'}}}';

                    if(type=="track1") magData.data[0].track1 = newVar;
                    else if(type=="track2") magData.data[1].track2 = newVar;
                    else magData.data[2].track3 = newVar;

                    cardDataAdd(magData);
                    updateVarMagstripeLists();

                    templateFieldsChangeVariable(type, oldLabel, newLabel);
                }
            }

            prevDiv.find('option').prop('selected', false);
            prevDiv.find('option:contains("'+input.val()+'")').prop('selected', true);

            parentDiv.addClass("hidden");
            prevDiv.removeClass("hidden");

            canvas.renderAll();
            updateLayerList();
        }); // save

        $('.inputVar').keyup(function (e) {
            if (e.keyCode == 13) {
                $(this).parent().next().find(".saveVar").trigger('click');
            }
        }); // key press in the input field

        function setVarTextName(object, name) {
            var oldLabel, newLabel;

            oldLabel = object.text;
            newLabel = name;

            object.setText(name);
            //resizeObject(object);
            //updateAlign(object);
            updateTextObject(object);
            canvas.renderAll();

            updateLayerList();

            templateFieldsChangeVariable("text", oldLabel, newLabel);
            fixConcatenatedFields();
        }

        function setVarText(object, id) {
            var oldLabel, newLabel;

            oldLabel = object.text;
            newLabel = getVarTextNameFromID(id);

            object.setText(newLabel);
            //resizeObject(object);
            //updateAlign(object);
            updateTextObject(object);
            canvas.renderAll();

            updateLayerList();

            templateFieldsChangeVariable("text", oldLabel, newLabel);
            fixConcatenatedFields();
        }

        function selectVarTextByName(name) {
            $('#editVarTextVariable option').prop('selected', false);
            $('#editVarTextVariable option[value="'+getVarTextIDFromName(name)+'"]').prop('selected', true);
        }

        function templateFieldsPush(type, label, params) {
            if(type=="image") {
                templateData.template_fields.push({
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label,
                    dimensions: params
                });
            }
            else {
                templateData.template_fields.push({
                    type: type,
                    token: removeUnsupportedCharacters(label),
                    label: label
                });
            }

            updateTemplateFieldsTable();
        }

        function templateFieldsRemoveRepeatingTexts(data) {

        }

        function templateFieldsRemoveRepeatingImages(data) {
            var biggestImages = [];

            for(i=0; i<data.length; i++) {
                if(data[i].type != "image") continue;

                var found = false;
                for(z=0; z<biggestImages.length; z++) {
                    if(data[i].label == biggestImages[z].label) {
                        found = true;
                        if(data[i].dimensions.width > biggestImages[z].dimensions.width)
                            biggestImages[z].dimensions = data[i].dimensions;
                    }
                }

                if(!found) biggestImages.push(data[i]);
            }

            // loop again to remove duplicates
            // first one gets the biggest dimensions
            // others = false
            // then clean up: http://stackoverflow.com/questions/281264/remove-empty-elements-from-an-array-in-javascript
            // bug when two images with the same var, then one sets to different
            // made a control array just for this? remove copies on saving?
            for(i=0; i<data.length; i++) {
                if(data[i].type != "image") continue;

                for(z=0; z<biggestImages.length; z++) {
                    if(data[i].label == biggestImages[z].label) {
                        if(!biggestImages[z].used) {
                            biggestImages[z].used = true;
                            data[i].dimensions = biggestImages[z].dimensions;
                        }
                        else {
                            data[i] = false;
                        }
                    }
                }
            }

            //todo: return data?
        }

        function templateFieldsGetAFieldID(data, type, label) {
            var id = -1;

            for(i=0; i<data.length; i++) {
                if(data[i].type == type) {
                    if(!label && (type=="track1" || type=="track2" || type=="track3")) {
                        id = i;
                        break;
                    }

                    var thisLabel;

                    if(!data[i].label) thisLabel = data[i].token;
                    else thisLabel = data[i].label;

                    if(thisLabel == label) id = i;
                }
            }

            return id;
        }

        function templateFieldsChangeVariable(type, oldLabel, newLabel, params) {
            var id = templateFieldsGetAFieldID(templateData.template_fields, type, oldLabel);

            // check if should delete (in case there are multiple images with the same token)
            var shouldDelete = true;
            if(type == "image") {
                var counter = 0;
                var counterFields = 0;

                canvas.forEachObject(function(object){
                    if(object.type=="variable-image" && (object.name == oldLabel || object.fieldName == oldLabel))
                        counter++;
                });

                if(sides=="double" && getUnselectedSide().json != "") {
                    var data = JSON.parse(getUnselectedSide().json);

                    for (var z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == "variable-image" && stripBrackets(data.objects[z].src) == removeUnsupportedCharacters(oldLabel))
                            counter++
                    }
                }

                for(i=0; i<templateData.template_fields.length; i++) {
                    if(templateData.template_fields[i].type=="image" && templateData.template_fields[i].token == removeUnsupportedCharacters(oldLabel))
                        counterFields++;
                }

                if(counter>1 && counterFields <= 1) shouldDelete = false;
            }

            if(id > -1 && !newLabel && shouldDelete) { // remove the old field
                templateData.template_fields.splice(id, 1);
            }
            else if(id > -1) {
                var newField;

                if(type=="image") {
                    newField = {
                        type: type,
                        token: removeUnsupportedCharacters(newLabel),
                        label: newLabel,
                        dimensions: params
                    };
                }
                else {
                    newField = {
                        type: type,
                        token: removeUnsupportedCharacters(newLabel),
                        label: newLabel
                    };
                }

                templateData.template_fields[id] = newField;
            }
            else if(id == -1 && newLabel)
                templateFieldsPush(type, newLabel, params); // push a new one

            updateListOfVariables();
            updateTemplateFieldsTable();

            // Remove on saving instead:
            //templateFieldsRemoveRepeatingTexts(templateData.template_fields); // todo: do this on save
            //templateFieldsRemoveRepeatingImages(templateData.template_fields); // todo: do this on save
        }

        // TAB: Shape
        $('#editShapeRectangle, #editShapeEllipse, #editShapeTriangle, #editShapeLine').on("click", function() {
            var object = canvas.getActiveObject();
            var typeOld = object.get('type');
            var newObj, typeNew, posX, posY, width, height, angle, fill, stroke, strokeWidth;

            if(this.id == "editShapeRectangle") typeNew = "rect";
            else if(this.id == "editShapeEllipse") typeNew = "ellipse";
            else if(this.id == "editShapeTriangle") typeNew = "triangle";
            else if(this.id == "editShapeLine") typeNew = "line";

            if(typeOld == typeNew) return;

            posX = object.getLeft();
            posY = object.getTop();
            width = object.width;
            height = object.height;
            angle = object.angle;
            fill = object.fill;
            stroke = object.stroke;
            strokeWidth = object.strokeWidth;

            if(typeOld == "line") {
                strokeWidth = 0;
                height = Math.ceil(width/2);
                fill = stroke;
            }

            canvas.remove(object);

            if (typeNew == "rect") {
                newObj = new fabric.Rect({
                    left: posX,
                    top: posY,
                    originX: 'left',
                    originY: 'top',
                    width: width,
                    height: height,
                    angle: angle,
                    fill: fill,
                    stroke: stroke,
                    strokeWidth: strokeWidth
                });
            }
            else if (typeNew == "ellipse") {
                newObj = new fabric.Ellipse({
                    left: posX,
                    top: posY,
                    rx: Math.ceil(width/2),
                    ry: Math.ceil(height/2),
                    angle: angle,
                    fill: fill,
                    perPixelTargetFind: true,
                    stroke: stroke,
                    strokeWidth: strokeWidth
                });
            }
            else if (typeNew == "triangle") {
                newObj = new fabric.Triangle({
                    left: posX,
                    top: posY,
                    width: width,
                    height: height,
                    angle: angle,
                    fill: fill,
                    perPixelTargetFind: true,
                    stroke: stroke,
                    strokeWidth: strokeWidth
                });
            }
            else if (typeNew == "line") {
                if(width<10) width = 100;
                newObj = new fabric.Line([0, 250, width, 250], {
                    left: posX,
                    top: posY,
                    angle: angle,
                    stroke: fill,
                    strokeWidth: 5,
                    lockUniScaling: true
                });
            }

            canvas.add(newObj);
            canvas.renderAll();

            addSnapshotToHistory();

            selectNewestObject();
        });

        $('.editShapeColor').colorpicker().on('changeColor.colorpicker', function(event){
            var object = canvas.getActiveObject();

            if(object.type == "line")
                object.setStroke(event.color.toHex());
            else
                object.fill = new fabric.Color(event.color.toHex()).setAlpha($('#editShapeTransparency').val()/100).toRgba();

            canvas.renderAll();
        });

        $('#editShapeColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        $('#editShapeCornersValue').keyup(function (e) {
            $(this).val($(this).val().replace(/\D/g,'')); // only numbers

            var radius = parseInt($(this).val());
            if(!radius) radius=0;

            canvas.getActiveObject().set('rx', radius);
            canvas.getActiveObject().set('ry', radius);
            canvas.renderAll();
        });

        $('#editShapeBorder').on('change', function() {
            var object = canvas.getActiveObject();

            if($(this).is(':checked')) { // draw a border
                // check if value is set and is a number
                var width = parseInt($('#editShapeBorderWidth').val());

                if(!width || !Number.isInteger(width)) {
                    $('#editShapeBorderWidth').val("1");
                    width = 1;
                }

                object.setStrokeWidth(width);
                object.setStroke($('#editShapeBorderColor').val());
            }
            else // remove a border
                object.setStroke();

            canvas.renderAll();
        });

        $('#editShapeBorderWidth').keyup(function (e) {
            $(this).val($(this).val().replace(/\D/g,'')); // only numbers
            if(!$('#editShapeBorder').is(':checked')) return;

            var width = parseInt($(this).val());
            if(!width) width=0;

            canvas.getActiveObject().setStrokeWidth(width);
            canvas.renderAll();
        });

        $('#editShapeLineWidth').keyup(function(e) {
            $(this).val($(this).val().replace(/\D/g,'')); // only numbers

            var width = parseInt($(this).val());
            if(!width) width=0;

            canvas.getActiveObject().setStrokeWidth(width);
            canvas.renderAll();
        });

        $('.editShapeBorderColor').colorpicker().on('changeColor.colorpicker', function(event){
            if(!$('#editShapeBorder').is(':checked')) return;

            var object = canvas.getActiveObject();
            object.setStroke(event.color.toHex());

            canvas.renderAll();
        });

        $('#editShapeBorderColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        $('#editShapeTransparency').on("change mousemove", function() {
            var object = canvas.getActiveObject();

            if(object.type=="line")
                object.setOpacity($(this).val() / 100);
            else
                object.fill = new fabric.Color(object.fill).setAlpha($(this).val() / 100).toRgba();

            canvas.renderAll();
        });

        // TAB: Image
        var filters = [];

        function updateFilters() {
            var thisType = 'editImage';
            if(canvas && canvas.getActiveObject() && canvas.getActiveObject().get('type')=="variable-image") {
                thisType = 'editVarImage';
            }

            var colorHash = $('.'+thisType+'RemoveWhiteColor').data('colorpicker').color.toRGB();
            var color = [colorHash.r, colorHash.g, colorHash.b];

            filters = [
                new fabric.Image.filters.Grayscale(),                       // grayscale    0
                new fabric.Image.filters.RemoveWhite({                      // remove white 1
                    threshold: $('#'+thisType+'RemoveWhiteThreshold').val(),
                    color: color
                })
            ];
        }

        $('#editImageTransparency, #editVarImageTransparency').on("change mousemove", function() {
            var obj = canvas.getActiveObject();

            obj.setOpacity($(this).val() / 100); //0-1
            canvas.renderAll();
        });

        $('#editImageRemoveWhiteThreshold, #editVarImageRemoveWhiteThreshold').on("change mousemove", function() {
            filterRemoveWhite(canvas.getActiveObject());
        });

        $('.editImageRemoveWhiteColor, .editVarImageRemoveWhiteColor').colorpicker().on('changeColor.colorpicker', function(event){
            filterRemoveWhite(canvas.getActiveObject());
        });

        $('#editImageRemoveWhiteColorPicker, #editVarImageRemoveWhiteColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        function filterRemoveWhite(obj) {
            updateFilters();

            var thisType = '#editImage';
            if(obj.get('type')=="variable-image") thisType = '#editVarImage';

            if($(thisType+'RemoveWhite').prop('checked')) {
                obj.filters[1] = filters[1];
            }
            else {
                obj.filters[1] = false;
            }

            obj.applyFilters(function () {
                canvas.renderAll();
            });
        }

        $('#editImageGrayscale, #editVarImageGrayscale').change(function() {
            var obj = canvas.getActiveObject();

            if(this.checked) {
                obj.filters[0] = filters[0];
            }
            else {
                obj.filters[0] = false;
            }

            obj.applyFilters(function () {
                canvas.renderAll();
            });
        });

        $('#editImageRemoveWhite, #editVarImageRemoveWhite').change(function() {
            var obj = canvas.getActiveObject();

            if(this.checked) {
                obj.filters[1] = filters[1];
            }
            else {
                obj.filters[1] = false;
            }

            obj.applyFilters(function () {
                canvas.renderAll();
            });
        });

        $('#editImageBorder, #editVarImageBorder').on('change', function() {
            var object = canvas.getActiveObject();

            if($(this).is(':checked')) { // draw a border
                // check if value is set and is a number
                var imType = '#editVarImage';
                if(object.get('type')=="image")
                    imType = '#editImage';

                var width = parseInt($(imType+'BorderWidth').val());

                if(!width || !Number.isInteger(width)) {
                    $(imType+'BorderWidth').val("1");
                    width = 1;
                }

                //object.setStrokeWidth(width);
                object.strokeShow = true;
                object.strokeWidthNew = width;
                object.setStroke($(imType+'BorderColor').val());
            }
            else // remove a border
                object.strokeShow = false;

            canvas.renderAll();
        });

        $('#editImageBorderWidth, #editVarImageBorderWidth').keyup(function (e) {
            var object = canvas.getActiveObject(),
                imType = '#editVarImage';

            if(object.get('type')=="image")
                imType = '#editImage';

            $(this).val($(this).val().replace(/\D/g,'')); // only numbers
            if(!$(imType+'Border').is(':checked')) return;

            var width = parseInt($(this).val());
            if(!width) width=0;

            //object.setStrokeWidth(width);
            object.strokeWidthNew = width;
            canvas.renderAll();
        });

        $('.editImageBorderColor, .editVarImageBorderColor').colorpicker().on('changeColor.colorpicker', function(event){
            var object = canvas.getActiveObject(),
                imType = '#editVarImage';

            if(object.get('type')=="image")
                imType = '#editImage';

            if(!$(imType+'Border').is(':checked')) return;

            object.setStroke(event.color.toHex());

            canvas.renderAll();
        });

        $('#editImageBorderColorPicker, #editVarImageBorderColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        $('#editImageCornerRadius, #editVarImageCornerRadius').keyup(function (e) {
            var object = canvas.getActiveObject();

            $(this).val($(this).val().replace(/\D/g,'')); // only numbers

            var radius = parseInt($(this).val());
            if(!radius) radius=0;

            //object.setStrokeWidth(width);
            object.cornerRadius = radius;
            canvas.renderAll();
        });

        $('.selectMetric').change(function() {
            if(!canvas.getActiveObject()) {
                metric = $(this).val();
                $('.selectMetric').val(metric);

                updateGridSize();
                if($('#gridShow').is(':checked'))
                {
                    hideGrid();
                    drawGrid(gridSize);
                }
                return;
            }

            var fromWidth, fromHeight, toWidth, toHeight, fromLeft, fromTop, toLeft, toTop;

            fromWidth = $('#positionWidth').val();
            fromHeight = $('#positionHeight').val();
            fromLeft = $('#positionLeft').val();
            fromTop = $('#positionTop').val();

            if(metric=="px" && $(this).val()=="in") {
                toWidth     = px2in(fromWidth);
                toHeight    = px2in(fromHeight);
                toLeft      = px2in(fromLeft);
                toTop       = px2in(fromTop);
            }
            else if(metric=="px" && $(this).val()=="mm") {
                toWidth     = px2mm(fromWidth);
                toHeight    = px2mm(fromHeight);
                toLeft      = px2mm(fromLeft);
                toTop       = px2mm(fromTop);
            }
            else if(metric=="in" && $(this).val()=="px") {
                toWidth     = in2px(fromWidth);
                toHeight    = in2px(fromHeight);
                toLeft      = in2px(fromLeft);
                toTop       = in2px(fromTop);
            }
            else if(metric=="in" && $(this).val()=="mm") {
                toWidth     = px2mm(in2px(fromWidth));
                toHeight    = px2mm(in2px(fromHeight));
                toLeft      = px2mm(in2px(fromLeft));
                toTop       = px2mm(in2px(fromTop));
            }
            else if(metric=="mm" && $(this).val()=="px") {
                toWidth     = mm2px(fromWidth);
                toHeight    = mm2px(fromHeight);
                toLeft      = mm2px(fromLeft);
                toTop       = mm2px(fromTop);
            }
            else if(metric=="mm" && $(this).val()=="in") {
                toWidth     = px2in(mm2px(fromWidth));
                toHeight    = px2in(mm2px(fromHeight));
                toLeft      = px2in(mm2px(fromLeft));
                toTop       = px2in(mm2px(fromTop));
            }

            $('#positionWidth').val(toWidth);
            $('#positionHeight').val(toHeight);
            $('#positionLeft').val(toLeft);
            $('#positionTop').val(toTop);

            metric = $(this).val();
            $('.selectMetric').val(metric);
            updateGridSize();

            if($('#gridShow').is(':checked'))
            {
                hideGrid();
                drawGrid(gridSize);
            }
        });

        function fixObjectBorder(object) {
            object.width = object.getWidth();
            object.height = object.getHeight();
            object.scaleX = 1;
            object.scaleY = 1;

            if(object.type == "ellipse") {
                object.rx = object.width / 2;
                object.ry = object.height / 2;
            }
        }

        function realCardWidth() {
            if(cardWidth>cardHeight)
                return cardWidth;
            else
                return cardHeight;
        }

        function px2in(pixels){
            var inches = ((pixels * 3.375) / realCardWidth()).toFixed(3);

            return inches;
        }

        function in2px(inches){
            var pixels = Math.ceil((realCardWidth()*inches)/3.375);

            return pixels;
        }

        function px2mm(pixels) {
            var mm = ((pixels * 85.725) / realCardWidth()).toFixed(3);

            return mm;
        }

        function mm2px(mm) {
            var pixels = Math.ceil((realCardWidth()*mm)/85.725);

            return pixels;
        }

        $('#positionKeepAspectRatio').change(function() {
            var object = canvas.getActiveObject();

            if(!object || object.type=="line") return;

            if($(this).is(':checked'))
                object.lockUniScaling = true;
            else
                object.lockUniScaling = false;

            canvas.renderAll();
        });

        $("#positionLeft, #positionTop, #positionWidth, #positionHeight").keyup(function (e) {
            if(canvas.getActiveGroup()) {
                alert("Can't perform this action: Multiple objects are selected");
                return;
            }

            updateObjectValues(canvas.getActiveObject(), this.id, $('#positionKeepAspectRatio').is(':checked'));
        });

        function updateObjectValues(object, id, aspectRatio, noRepeat) {
            if(!object) return;

            var top = parseFloat($('#positionTop').val()),
                left = parseFloat($('#positionLeft').val()),
                width = parseFloat($('#positionWidth').val()),
                height = parseFloat($('#positionHeight').val());

            if(object.type=="line") {
                aspectRatio = false;
                height = 0;
            }

            if(metric == "in") {
                left = in2px(left);
                top = in2px(top);
                width = in2px(width);
                height = in2px(height);
            }
            else if(metric == "mm") {
                left = mm2px(left);
                top = mm2px(top);
                width = mm2px(width);
                height = mm2px(height);
            }

            if(aspectRatio && id=="positionWidth") {
                var oldWidth = object.width;

                if(oldWidth!=0) {
                    var ratio = width / oldWidth;
                    height = height*ratio;
                }
            }
            else if(aspectRatio && id=="positionHeight") {
                var oldHeight = object.height;

                if(oldHeight!=0) {
                    var ratio = height / oldHeight;
                    width = width * ratio;
                }
            }

            object.top = top + topPadding;
            object.left = left + leftPadding;
            object.width = width;
            object.height = height;

            if(isTextRect(object)) {
                recalcTextPosition(object.textID);
                resizeObject(getTextByTextID(object.textID));
            }

            fixObjectBorder(object);
            object.setCoords();
            canvas.renderAll();
            updatePositionValues(object);

            if(isTextRect(object) && !noRepeat)
                updateObjectValues(object, id, aspectRatio, true);
        }

        function updatePositionValues(object) {
            if(!object) {
                $('#positionLeft').val("");
                $('#positionTop').val("");
                $('#positionWidth').val("");
                $('#positionHeight').val("");
                $('#positionKeepAspectRatio').prop('checked', false);
                return;
            }

            if(object.hasOwnProperty("type") && object.type=="static-text") object = getRectByTextID(object.textID);

            if(!object.hasOwnProperty("height") || !object.hasOwnProperty("width") || !object.hasOwnProperty("top") || !object.hasOwnProperty("left")) {
                alert("Error: Something is wrong with the selected object");
                return;
            }

            if(object.lockUniScaling)
                $('#positionKeepAspectRatio').prop('checked', true);
            else
                $('#positionKeepAspectRatio').prop('checked', false);

            var left = object.left - leftPadding,
                top = object.top - topPadding,
                width = object.width,
                height = object.height;

            if(metric=="in") {
                left = px2in(left);
                top = px2in(top);
                width = px2in(width);
                height = px2in(height);
            }
            else if(metric=="mm") {
                left = px2mm(left);
                top = px2mm(top);
                width = px2mm(width);
                height = px2mm(height);
            }

            $('#positionLeft').val(left);
            $('#positionTop').val(top);
            $('#positionWidth').val(width);
            $('#positionHeight').val(height);
        }

        // Variable Images
        $( 'input[name="editVarImageResizing"]:radio' ).change(function() {
            var object = canvas.getActiveObject();
            object.set('scaleType', $(this).val());
        });

        $(document).on("change","#editVarImageVariable",function (event) {
            var object = canvas.getActiveObject();
            var newLabel = getVarImageNameFromID($(this).val());

            templateFieldsChangeVariable("image", object.name, newLabel, {width: object.width, height: object.height});

            object.set('name', newLabel);
            canvas.renderAll();
            updateLayerList();
        });

        function selectVarImageByName(name) {
            $('#editVarImageVariable option').prop('selected', false);
            $('#editVarImageVariable option[value="'+getVarImageIDFromName(name)+'"]').prop('selected', true);
        }

        // TAB: Card
        $('#cardSize').change(function() {
            resizeCardBasedOnSelectVal($(this).val());
        });

        $('#cardOneSided').on("click", function() {
            setNumberOfSides(1);
        });

        $('#cardDoubleSided').on("click", function() {
            setNumberOfSides(2);
        });

        function setNumberOfSides(num){
            if(num==1) {
                $('#cardDoubleSided').removeClass('active');
                $('#cardOneSided').addClass('active');
                if(selectedSideID()==1) {
                    $("#sideFront").addClass("active");
                    $("#sideBack").removeClass("active");
                    flipSides();
                }
                $('#sideBack').prop('disabled', true);
                sides = "single";
                $('#cardBackSideColoring').addClass('hidden');
                $('#frontSideCopy').prop('disabled', true);
            }
            else {
                $('#cardOneSided').removeClass('active');
                $('#cardDoubleSided').addClass('active');
                $('#sideBack').prop('disabled', false);
                sides = "double";
                $('#cardBackSideColoring').removeClass('hidden');
                $('#frontSideCopy').prop('disabled', false);
            }

            updateTemplateColors();
        }

        function setColorOfSides(color) {
            if(!color) return;

            var frontColor = color.slice(0,5),
                backColor = color.slice(5);

            $('#cardFrontSideColor, #cardFrontSideBW, #cardBackSideColor, #cardBackSideBW').removeClass('active');

            if(frontColor=="black")
                $('#cardFrontSideBW').addClass('active');
            else
                $('#cardFrontSideColor').addClass('active');

            if(backColor=="black")
                $('#cardBackSideBW').addClass('active');
            else
                $('#cardBackSideColor').addClass('active');

            updateTemplateColors();
        }

        $('#cardPortrait').on("click", function() {
            $('#cardLandscape').removeClass('active');
            $(this).addClass('active');

            if(orientation=="landscape")
                changeOrientation();
        });

        $('#cardLandscape').on("click", function() {
            $('#cardPortrait').removeClass('active');
            $(this).addClass('active');

            if(orientation=="portrait")
                changeOrientation();
        });

        $('#cardFrontSideColor, #cardFrontSideBW').on("click", function() {
            $('#cardFrontSideColor, #cardFrontSideBW').removeClass('active');
            $(this).addClass('active');
            updateTemplateColors();
        });

        $('#cardBackSideColor, #cardBackSideBW').on("click", function() {
            $('#cardBackSideColor, #cardBackSideBW').removeClass('active');
            $(this).addClass('active');
            updateTemplateColors();

            colorCanvasIfNeeded();
            grayscaleCanvasIfNeeded();
        });

        function updateTemplateColors() {
            if($('#cardFrontSideColor').hasClass('active'))
                colors = 'color';
            else
                colors = 'black';

            if(sides=="double") {
                if($('#cardBackSideColor').hasClass('active'))
                    colors += 'color';
                else
                    colors += 'black';
            }
        }

        $('#cardSlotPunchNone, #cardSlotPunchLong, #cardSlotPunchShort').on("click", function() {
            $('#cardSlotPunchNone, #cardSlotPunchLong, #cardSlotPunchShort').removeClass('active');
            $(this).addClass('active');
            updateSlotPunch(this.id);
        });

        function updateSlotPunch(id){
            // id == cardSlotPunchLong, cardSlotPunchShort, cardSlotPunchNone
            // card: 3.375 x 2.125
            // 0.125" x 0.5"; 1/4â€ from edge
            //cardWidth  457  3.375  0.5    67px
            //cardHeight 288  2.125  0.125  18px

            if(!id) {
                if($('#cardSlotPunchNone').hasClass('active'))
                    slotPunch = 'none';
                else if($('#cardSlotPunchShort').hasClass('active'))
                    slotPunch = 'short';
                else
                    slotPunch = 'long';
            }
            else if(id == "cardSlotPunchLong")
                slotPunch = 'long';
            else if(id == "cardSlotPunchShort")
                slotPunch = 'short';
            else if(id == "cardSlotPunchNone")
                slotPunch = 'none';

            canvas.forEachObject(function(object) {
                if (object.get('name') == "slotPunch") {
                    canvas.remove(object);
                }
            });

            $('#cardSlotPunchLong, #cardSlotPunchShort, #cardSlotPunchNone').removeClass('active');
            if(slotPunch == 'none') {
                canvas.renderAll();
                $('#cardSlotPunchNone').addClass('active');
                return;
            }
            else if(slotPunch == 'long') {
                $('#cardSlotPunchLong').addClass('active');
            }
            else {
                $('#cardSlotPunchShort').addClass('active');
            }

            var width = mm2px(12.5),
                height = mm2px(3),
                left = Math.ceil((cardWidth - width) / 2),
                top = mm2px(5.5);

            if((slotPunch == 'long' && orientation=="landscape") || (slotPunch == 'short' && orientation=="portrait"))
                drawSlotPunch(left, top, width, height);
            else {
                left = top;
                top = Math.ceil((cardHeight-width)/2);
                drawSlotPunch(left, top, height, width);
            }
        }

        function drawSlotPunch(left, top, width, height) {
            canvas.add(new fabric.Rect({
                left: leftPadding+left,
                top: topPadding+top,
                originX: 'left',
                originY: 'top',
                width: width,
                height: height,
                fill: '#2a3035',
                stroke: '#697884',
                rx: 10,
                ry: 10,
                strokeWidth: 1,
                evented: false,
                selectable: false,
                name: 'slotPunch'}));

            newestObject(true).toObject = (function(toObject) {
                return function() {
                    return fabric.util.object.extend(toObject.call(this), {
                        name: this.name
                    });
                };
            })(newestObject(true).toObject);

            canvas.renderAll();
        }

        // TAB: Objects Align
        $('#objectsAlignLeft').on('click', function() { // FIX MAX WIDTH OF VAR TEXTS
            var group = canvas.getActiveGroup();

            var left, isSet;
            group.forEachObject(function(object) {
                if(!isSet) {
                    left = object.getLeft();
                    isSet = true;
                }
                else {
                    if(object.getLeft()<left) left = object.getLeft();
                }
            });

            group.forEachObject(function(object) {
                object.set('left', left);

                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        });

        $('#objectsAlignRight').on('click', function() {
            var group = canvas.getActiveGroup();

            var right, isSet;

            group.forEachObject(function(object) {
                if(!isSet) {
                    right = object.getLeft() + object.getWidth();
                    isSet = true;
                }
                else {
                    if(object.getLeft() + object.getWidth()>right) right = object.getLeft() + object.getWidth();
                }
            });

            group.forEachObject(function(object) {
                object.set('left', right-object.getWidth());

                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        });

        $('#objectsAlignCenter').on('click', function() {
            var group = canvas.getActiveGroup();
            groupCenterObjects(group);
        });

        $('#objectsAlignTop').on('click', function() {
            var group = canvas.getActiveGroup();

            var top, isSet;

            group.forEachObject(function(object) {
                if(!isSet) {
                    top = object.getTop();
                    isSet = true;
                }
                else {
                    if(object.getTop()<top) top = object.getTop();
                }
            });

            group.forEachObject(function(object) {
                object.set('top', top);

                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        });

        $('#objectsAlignBottom').on('click', function() {
            var group = canvas.getActiveGroup();

            var bottom, isSet;

            group.forEachObject(function(object) {
                if(!isSet) {
                    bottom = object.getTop() + object.getHeight();
                    isSet = true;
                }
                else {
                    if(object.getTop() + object.getHeight()>bottom) bottom = object.getTop() + object.getHeight();
                }
            });

            group.forEachObject(function(object) {
                object.set('top', bottom-object.getHeight());

                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        });

        $('#objectsAlignMiddle').on('click', function() {
            var group = canvas.getActiveGroup();

            var top, isSet;

            group.forEachObject(function(object) {
                if(!isSet) {
                    top = object.getTop();
                    isSet = true;
                }
                else {
                    if(object.getTop()<top) top = object.getTop();
                }
            });

            group.forEachObject(function(object) {
                object.set('top', top + Math.ceil((group.height-object.getHeight())/2));

                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        });

        function groupCenterObjects(group) {
            var left, isSet;
            group.forEachObject(function(object) {
                if(!isSet) {
                    left = object.getLeft();
                    isSet = true;
                }
                else {
                    if(object.getLeft()<left) left = object.getLeft();
                }
            });

            group.forEachObject(function(object) {
                object.set('left', left + Math.ceil((group.width-object.getWidth())/2));


                if(isTextRect(object)) {
                    recalcTextPosition(object.textID);
                    canvas.renderAll();
                }
            });

            canvas.deactivateAllWithDispatch();
            canvas.renderAll();
        }

        // TAB: Barcode
        $('#editBarcodeVariable').on('click', function() {
            barcodeShowVariable();

            var object = canvas.getActiveObject();
            var oldLabel = object.text,
                newLabel = $('#editBarcodeTextVariable option:selected').text();

            object.text = newLabel;

            templateFieldsChangeVariable("barcode", oldLabel, newLabel);

            cardDataAddBarcode(object);
        });

        $('#editBarcodeFixed').on('click', function() {
            barcodeShowFixed();

            var object = canvas.getActiveObject();
            var oldLabel = object.text;

            object.text = $('#editBarcodeText').val();

            templateFieldsChangeVariable("barcode", oldLabel, false);

            cardDataAddBarcode(object);
        });

        function barcodeShowVariable() {
            var object = canvas.getActiveObject();
            updateVarBarcodeList(object.barcodeType);

            $('#editBarcodeVariable').addClass('active');
            $('#editBarcodeFixed').removeClass('active');
            $('#editBarcodeTextRow').addClass('hidden');
            $('#editBarcodeVariableRow').removeClass('hidden');

            object.textType = 'variable';
        }

        function barcodeShowFixed() {
            barcodeHideGroup();

            $('#editBarcodeFixed').addClass('active');
            $('#editBarcodeVariable').removeClass('active');
            $('#editBarcodeTextRow').removeClass('hidden');
            $('#editBarcodeVariableRow').addClass('hidden');

            var object = canvas.getActiveObject();
            object.textType = 'fixed';
        }

        function barcodeShowGroup() {
            $('#editBarcodeVariableRow').addClass('hidden');
            $('#editBarcodeAddGroup').removeClass('hidden');
        }

        function barcodeHideGroup() {
            $('#editBarcodeVariableRow').removeClass('hidden');
            $('#editBarcodeAddGroup').addClass('hidden');
        }

        function cardDataAddBarcode(object) {
            var barcode = object.text,
                barWidth = 5,
                quietZone = 10;

            if(object.textType=="variable") barcode = '{{{'+removeUnsupportedCharacters(barcode)+'}}}';
            if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
            if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

            var barData = {
                type:   "barcode",
                token:  object.name,
                data:   [{
                    symbology: object.barcodeType
                },{
                    barcode: barcode
                },{
                    bar_width: barWidth
                },{
                    quiet_zone: quietZone
                }]
            };

            cardDataAdd(barData);
        }

        function selectVarBarcodeByName(name) {
            $('#editBarcodeTextVariable option').prop('selected', false);
            $('#editBarcodeTextVariable option[value="'+getVarBarcodeIDFromName(name)+'"]').prop('selected', true);
        }

        function selectVarQrcodeByName(name) {
            $('#editQrcodeTextVariable option').prop('selected', false);
            $('#editQrcodeTextVariable option[value="'+getVarBarcodeIDFromName(name)+'"]').prop('selected', true);
        }

        function updateBarcodeFixedTextTooltip(type) {
            var tooltip = "";

            if(type == "Code25" || type == "Code25Interleaved" || type == "Code25IATA")
                tooltip = "0-9 only";
            else
                tooltip = "0-9, A-Z (upper case only), space, minus (-), plus (+), period (.), dollar sign ($), slash (/), and percent (%)";

            $('#editBarcodeText').attr('data-original-title', tooltip).tooltip('fixTitle');
        }

        $('#editBarcodeType').on('change', function (event) {
            updateVarBarcodeList($(this).val());

            var object = canvas.getActiveObject(),
                barcodeText = object.text,
                isTypeAllowed = false;

            templateFieldsChangeVariable("barcode", barcodeText, false);

            if(object.textType=='variable') {
                for (i = 0; i < varBarcodeFields.length; i++) {
                    if (varBarcodeFields[i].name == barcodeText) {
                        for (z = 0; z < varBarcodeFields[i].type.length; z++) {
                            if (varBarcodeFields[i].type[z] == $(this).val())
                                isTypeAllowed = true;
                        }
                    }
                }

                if (!isTypeAllowed) {
                    barcodeText = $('#editBarcodeTextVariable option:selected').text();
                }
            }

            updateBarcodeFixedTextTooltip($(this).val());

            var barWidth = 5, quietZone = 10;
            if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
            if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

            createNewBarcode({
                posX: object.left,
                posY: object.top,
                width: object.width,
                height: object.height,
                type: $(this).val(),
                textType: object.textType,
                text: barcodeText,
                name: object.name,
                stroke: object.stroke,
                strokeWidth: object.strokeWidth,
                barWidth: barWidth,
                quietZone: quietZone
            });
            canvas.remove(object);
            selectNewestObject();
            canvas.renderAll();

            if(object.textType == "variable") {
                templateFieldsChangeVariable("barcode", false, barcodeText);
                barcodeText = '{{{' + barcodeText + '}}}';
            }

            var barWidth = 5, quietZone = 10;
            if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
            if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

            var barcodeData = {
                type:   "barcode",
                token:  object.name,
                data:   [{
                    symbology:  $(this).val()
                },{
                    barcode:    barcodeText
                },{
                    bar_width:  barWidth
                },{
                    quiet_zone: quietZone
                }]
            };

            cardDataAdd(barcodeData);
        });

        $(document).on("change","#editBarcodeTextVariable",function (event) {
            var object = canvas.getActiveObject();
            if(object.get('type') != 'barcode') return;

            var oldLabel = object.text,
                newLabel = $('#editBarcodeTextVariable option:selected').text();

            object.text = newLabel;

            templateFieldsChangeVariable("barcode", oldLabel, newLabel);

            cardDataAddBarcode(object);
        });

        $('#editBarcodeText').keyup(function () {
            var text = $(this).val().toUpperCase();
            $(this).val(text);
            $('#editBarcodeTextForm').validator('validate');

            var object = canvas.getActiveObject();

            object.text = text;

            var barWidth = 5, quietZone = 10;
            if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
            if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

            var barcodeData = {
                type:   "barcode",
                token:  object.name,
                data:   [{
                    symbology:  $('#editBarcodeType').val()
                },{
                    barcode:    text
                },{
                    bar_width:  barWidth
                },{
                    quiet_zone: quietZone
                }]
            };

            cardDataAdd(barcodeData);
        });

        $('#editBarcodeBorder').on('change', function() {
            var object = canvas.getActiveObject();

            if($(this).is(':checked')) { // draw a border
                // check if value is set and is a number
                var width = parseInt($('#editBarcodeBorderWidth').val());

                if(!width || !Number.isInteger(width)) {
                    $('#editBarcodeBorderWidth').val("1");
                    width = 1;
                }

                object.setStrokeWidth(width);
                object.setStroke($('#editBarcodeBorderColor').val());
            }
            else // remove a border
                object.setStroke();

            canvas.renderAll();
        });

        $('#editBarcodeBorderWidth').keyup(function (e) {
            $(this).val($(this).val().replace(/\D/g,'')); // only numbers
            if(!$('#editBarcodeBorder').is(':checked')) return;

            var width = parseInt($(this).val());
            if(!width) width=0;

            canvas.getActiveObject().setStrokeWidth(width);
            canvas.renderAll();
        });

        $('.editBarcodeBorderColor').colorpicker().on('changeColor.colorpicker', function(event){
            if(!$('#editBarcodeBorder').is(':checked')) return;

            var object = canvas.getActiveObject();
            object.setStroke(event.color.toHex());

            canvas.renderAll();
        });

        $('#editBarcodeBorderColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        function barcodePreviewUpdate() {
            var barcodeCanvas = document.createElement("canvas"),
                barcode = canvas.getActiveObject(),
                barcodeCardData;

            $('#modalBarcodePreviewWarning').addClass('hidden');

            for(var i=0; i<cardData.length; i++) {
                if(cardData[i].type == "barcode" && cardData[i].token == barcode.name)
                    barcodeCardData = cardData[i].data;
            }

            var format = "CODE39",
                barcodeFormat = getParamFromArray("symbology", barcodeCardData);

            if(barcodeFormat == "code128A" || barcodeFormat == "code128B" || barcodeFormat == "code128C")
                format = "CODE128";
            else if(barcodeFormat != "code39" && barcodeFormat != "code39extended")
                $('#modalBarcodePreviewWarning').removeClass('hidden');

            JsBarcode(barcodeCanvas, $('#modalBarcodePreviewValue').val(), {
                format: format,
                width: parseInt($('#editBarcodeBarWidth').val()),
                marginLeft: parseInt($('#editBarcodeQuietZone').val()),
                marginRight: parseInt($('#editBarcodeQuietZone').val()),
                displayValue: false
            });

            var barcodeBASE64 = barcodeCanvas.toDataURL("image/png");

            var cardJSON = JSON.parse(prepareTemplateForSaving(JSON.stringify(canvas)));

            for(var i=0; i<cardJSON.objects.length; i++) {
                if(cardJSON.objects[i].type == "barcode" && cardJSON.objects[i].name == barcode.name) {
                    cardJSON.objects[i].src = barcodeBASE64;
                }
            }

            var card = new Card(cardJSON);

            card.setMode("previewBarcode");

            card.base64(function(base64){
                $('#modalBarcodePreviewImage').attr("src", base64);
                $('#modalBarcodePreviewImage').removeClass('hidden');
            });
        }

        $('#modalBarcodePreviewUpdate').on("click", function(){
            barcodePreviewUpdate();
            //use getParamFromArray if needed
        });

        $('#modalBarcodePreview').on('shown.bs.modal', function() {
            barcodePreviewUpdate();
        });

        $('#modalBarcodePreview').on('hidden.bs.modal', function () {
            $('#modalBarcodePreviewImage').addClass('hidden');
            $('#modalBarcodePreviewWarning').addClass('hidden');
        });

        $('#editBarcodeBarWidth').keyup(function (e) {
            var barWidth = parseInt($(this).val().replace(/\D/g, ''));

            if(!barWidth || barWidth == 0) barWidth = 1;
            else if(barWidth>10) barWidth = 10;

            $(this).val(barWidth);

            var object = canvas.getActiveObject();
            object.barWidth = barWidth;
            cardDataAddBarcode(object);
        });

        $('#editBarcodeQuietZone').keyup(function (e) {
            var quietZone = parseInt($(this).val().replace(/\D/g, ''));

            if(!quietZone) quietZone = 0;
            else if(quietZone>100) quietZone = 100;

            $(this).val(quietZone);

            var object = canvas.getActiveObject();
            object.quietZone = quietZone;
            cardDataAddBarcode(object);
        });

        // TAB: QR code
        $('#editQrcodeVariable').on('click', function() {
            qrcodeShowVariable();

            var object = canvas.getActiveObject();
            var oldLabel = object.text,
                newLabel = $('#editQrcodeTextVariable option:selected').text();
            object.text = newLabel;

            templateFieldsChangeVariable("qrcode", oldLabel, newLabel);

            cardDataAddQrcode(object);
        });

        $('#editQrcodeFixed').on('click', function() {
            qrcodeShowFixed();

            var object = canvas.getActiveObject();
            var oldLabel = object.text;
            object.text = $('#editQrcodeText').val();

            templateFieldsChangeVariable("qrcode", oldLabel, false);

            cardDataAddQrcode(object);
        });

        $(document).on("change","#editQrcodeTextVariable",function (event) {
             var object = canvas.getActiveObject();
             if(object.get('type') != 'barcode') return;
            var oldLabel = object.text,
                newLabel = $('#editQrcodeTextVariable option:selected').text();
            object.text = newLabel;

            templateFieldsChangeVariable("qrcode", oldLabel, newLabel);

            cardDataAddQrcode(object);
        });

        function cardDataAddQrcode(object) {
            var qrcode = object.text;

            if(object.textType=="variable") qrcode = '{{{'+removeUnsupportedCharacters(qrcode)+'}}}';

            var qrData = {
                type:   "qrcode",
                token:  object.name,
                data:   [{
                    qrcode: qrcode
                }]
            };

            cardDataAdd(qrData);
        }

        function qrcodeShowVariable() {
            var object = canvas.getActiveObject();
            updateVarBarcodeList(object.barcodeType);

            $('#editQrcodeVariable').addClass('active');
            $('#editQrcodeFixed').removeClass('active');
            $('#editQrcodeTextRow').addClass('hidden');
            $('#editQrcodeVariableRow').removeClass('hidden');

            object.textType = 'variable';
        }

        function qrcodeShowFixed() {
            qrcodeHideGroup();

            $('#editQrcodeFixed').addClass('active');
            $('#editQrcodeVariable').removeClass('active');
            $('#editQrcodeTextRow').removeClass('hidden');
            $('#editQrcodeVariableRow').addClass('hidden');

            var object = canvas.getActiveObject();
            object.textType = 'fixed';
        }

        function qrcodeShowGroup() {
            $('#editQrcodeVariableRow').addClass('hidden');
            $('#editQrcodeAddGroup').removeClass('hidden');
        }

        function qrcodeHideGroup() {
            $('#editQrcodeVariableRow').removeClass('hidden');
            $('#editQrcodeAddGroup').addClass('hidden');
        }

        $('#editQrcodeText').keyup(function () {
            canvas.getActiveObject().text = $(this).val();

            var qrData = {
                type:   "qrcode",
                token:  canvas.getActiveObject().name,
                data:   [{
                    qrcode: $(this).val()
                }]
            };

            cardDataAdd(qrData);
        });

        $('#editQrcodeBorder').on('change', function() {
            var object = canvas.getActiveObject();

            if($(this).is(':checked')) { // draw a border
                // check if value is set and is a number
                var width = parseInt($('#editQrcodeBorderWidth').val());

                if(!width || !Number.isInteger(width)) {
                    $('#editQrcodeBorderWidth').val("1");
                    width = 1;
                }

                object.setStrokeWidth(width);
                object.setStroke($('#editQrcodeBorderColor').val());
            }
            else // remove a border
                object.setStroke();

            canvas.renderAll();
        });

        $('#editQrcodeBorderWidth').keyup(function (e) {
            $(this).val($(this).val().replace(/\D/g,'')); // only numbers
            if(!$('#editQrcodeBorder').is(':checked')) return;

            var width = parseInt($(this).val());
            if(!width) width=0;

            canvas.getActiveObject().setStrokeWidth(width);
            canvas.renderAll();
        });

        $('.editQrcodeBorderColor').colorpicker().on('changeColor.colorpicker', function(event){
            if(!$('#editQrcodeBorder').is(':checked')) return;

            var object = canvas.getActiveObject();
            object.setStroke(event.color.toHex());

            canvas.renderAll();
        });

        $('#editQrcodeBorderColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = canvas.getActiveObject();
        });

        // TAB: Magstripe
        function getMagstripeCardData() {
            var track = ["", "", ""];

            for(i=0; i<3; i++) {
                var trackID = i + 1;
                if ($('#editMagstripeFixed' + trackID).hasClass("active")) {
                    track[i] = $('#magstripeTrackFixed' + trackID).val();
                }
                else {
                    var label = $('#magstripeTrack' + trackID + '  option:selected').text();

                    track[i] = '{{{' + removeUnsupportedCharacters(label) + '}}}';

                    if(track[i] == '{{{}}}') track[i] = "";
                }
            }

            var magData = {
                type:   "magstripe",
                data:   [{
                    track1: track[0]
                },{
                    track2: track[1]
                },{
                    track3: track[2]
                }]
            };

            var oldMagStripe = ["", "", ""];
            for(i=0; i<cardData.length; i++) {
                if(cardData[i].type == "magstripe") {
                    oldMagStripe[0] = cardData[i].data[0].track1;
                    oldMagStripe[1] = cardData[i].data[1].track2;
                    oldMagStripe[2] = cardData[i].data[2].track3;
                }
            }

            templateFieldsChangeVariable("track1", stripBrackets(oldMagStripe[0]), stripBrackets(track[0]));
            templateFieldsChangeVariable("track2", stripBrackets(oldMagStripe[1]), stripBrackets(track[1]));
            templateFieldsChangeVariable("track3", stripBrackets(oldMagStripe[2]), stripBrackets(track[2]));

            return magData;
        }

        function updateMagstripeCardData() {
            cardDataAdd(getMagstripeCardData());
        }

        function updateMagstripeFieldsFromCardData(fullData) {
            var data = false;
            for(i=0; i<fullData.length; i++) {
                if(fullData[i].type == "magstripe")
                    data = fullData[i];
            }
            if(!data) return;

            var track1, track2, track3;
            if(data.data[0]) track1 = data.data[0].track1;
            else track1 = "";
            if(data.data[1]) track2 = data.data[1].track2;
            else track2 = "";
            if(data.data[2]) track3 = data.data[2].track3;
            else track3 = "";

            var track = [track1, track2, track3],
                tracksToUpdate = []; // {trackID, magName}

            for(z=0; z<3; z++) {
                if(track[z] == "") continue;

                var trackID = z + 1;
                if(track[z].substring(0, 3)=="{{{") { // var
                    var magName = stripBrackets(track[z]);
                    showMagstripeVariable(trackID, true);
                    selectMagstripeByName(magName, trackID);
                    tracksToUpdate.push(trackID);
                }
                else { // fixed
                    showMagstripeFixed(trackID);
                    $('#magstripeTrackFixed' + trackID).val(track[z]);
                }
            }
        }

        $('#magstripeTrackFixed1, #magstripeTrackFixed2, #magstripeTrackFixed3').keyup(function () {
            updateMagstripeCardData();
        });

        function cardDataAdd(data) {
            var cardDataID = cardDataGetID(data.type, data.token);

            if(cardDataID===false) {
                cardData.push(data);
            }
            else {
                cardData[cardDataID].data = data.data;
            }

            $('#cardData').text(JSON.stringify(cardData));
            updateCardDataTable();
        }

        function cardDataRemove(data) {
            var cardDataID = cardDataGetID(data.type, data.token);

            if(cardDataID) {
                cardData.splice(cardDataID, 1);
            }

            $('#cardData').text(JSON.stringify(cardData));
            updateCardDataTable();
        }

        function cardDataUpdate() { //TODO: barcode variable resets after changing type;
            cardData = [];

            canvas.forEachObject(function(object) {
                if(object.type=="barcode") {

                    var text = object.text;
                    if(object.textType == 'variable') {
                        //if(text.substring(0, 3) != '{{{')
                            text = '{{{' + removeUnsupportedCharacters(text) + '}}}';
                    }

                    if(object.barcodeType=='qrcode') {
                        cardData.push({
                            type:   "qrcode",
                            token:  object.name,
                            data:   [{
                                qrcode:    text
                            }]
                        });
                    }
                    else {
                        var barWidth = 5, quietZone = 10;
                        if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
                        if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

                        cardData.push({
                            type: "barcode",
                            token: object.name,
                            data: [{
                                symbology: object.barcodeType
                            }, {
                                barcode: text
                            }, {
                                bar_width: barWidth
                            }, {
                                quiet_zone: quietZone
                            }]
                        });
                    }

                }
            });

            if(sides=="double" && getUnselectedSide().json != "") {
                var data = JSON.parse(getUnselectedSide().json);

                for(i=0; i<data.objects.length; i++) {
                    if (data.objects[i].type == "barcode") {
                        var text = data.objects[i].text;
                        if(data.objects[i].textType == 'variable') {
                            text = '{{{' + removeUnsupportedCharacters(text) + '}}}';
                        }

                        if(data.objects[i].barcodeType=='qrcode') {
                            cardData.push({
                                type:   "qrcode",
                                token:  data.objects[i].name,
                                data:   [{
                                    qrcode:    text
                                }]
                            });
                        }
                        else {
                            var barWidth = 5, quietZone = 10;
                            if(data.objects[i].hasOwnProperty('barWidth')) barWidth = data.objects[i].barWidth;
                            if(data.objects[i].hasOwnProperty('quietZone')) quietZone = data.objects[i].quietZone;

                            cardData.push({
                                type: "barcode",
                                token: data.objects[i].name,
                                data: [{
                                    symbology: data.objects[i].barcodeType
                                }, {
                                    barcode: text
                                }, {
                                    bar_width: barWidth
                                }, {
                                    quiet_zone: quietZone
                                }]
                            });
                        }

                    }
                }
            }

            if(templateData.cardTypeID == cardTypeIDs.magStripe) {
                cardData.push(getMagstripeCardData());
            }
            else {
                templateFieldsChangeVariable("track1");
                templateFieldsChangeVariable("track2");
                templateFieldsChangeVariable("track3");
            }

            $('#cardData').text(JSON.stringify(cardData));
        }

        function cardDataGetID(type, token) {
            for(i=0; i<cardData.length; i++) {
                if(cardData[i].type==type) {
                    if((token && cardData[i].token == token) || !token)
                        return i;
                }
            }

            return false;
        }

        $('#editMagstripeFixed1, #editMagstripeFixed2, #editMagstripeFixed3').on("click", function(e) {
            e.preventDefault();

            var num = this.id.slice(-1);

            templateFieldsChangeVariable("track"+num);

            showMagstripeFixed(num);
            updateMagstripeCardData();
        });

        $('#editMagstripeVariable1, #editMagstripeVariable2, #editMagstripeVariable3').on("click", function(e) {
            e.preventDefault();

            var num = this.id.slice(-1);

            showMagstripeVariable(num);
            updateMagstripeCardData();
        });

        function showMagstripeFixed(num) {
            $('#editMagstripeFixed'+num).addClass('active');
            $('#editMagstripeVariable'+num).removeClass('active');
            $('#editMagstripeSelectGroupFixed'+num).removeClass('hidden');
            $('#editMagstripeSelectGroup'+num).addClass('hidden');
        }

        function showMagstripeVariable(num, dontUpdate) {
            $('#editMagstripeFixed'+num).removeClass('active');
            $('#editMagstripeVariable'+num).addClass('active');
            $('#editMagstripeSelectGroupFixed'+num).addClass('hidden');
            $('#editMagstripeSelectGroup'+num).removeClass('hidden');

            if(!dontUpdate)
                updateVarMagstripeLists();
        }

        $(document).on("change","#magstripeTrack1, #magstripeTrack2, #magstripeTrack3",function (event) {
            var num = this.id.slice(-1);

            templateFieldsChangeVariable("track"+num, $('#magstripeTrack' + num + '  option:selected').text(), false);

            updateMagstripeCardData();
        });

        function selectMagstripeByName(name, id) {
            $('#magstripeTrack'+id+' option').prop('selected', false);
            $('#magstripeTrack'+id+' option[value="'+getVarBarcodeIDFromName(name)+'"]').prop('selected', true);
        }

        function magStripeAdd() {
            magStripeRemove();

            if(selectedSideID()==0 || templateData.cardTypeID != cardTypeIDs.magStripe) return;

            if(orientation == "portrait") {
                var width = Math.ceil((cardWidth * 0.33) / 2.125),
                    height = cardHeight,
                    top = 0,
                    left = Math.ceil((cardWidth * 0.223) / 2.125);
            }
            else {
                var width   = cardWidth,
                    height  = Math.ceil((cardHeight * 0.33) / 2.125),
                    top     = Math.ceil((cardHeight * 0.223) / 2.125),
                    left    = 0;
            }

            canvas.add(new fabric.Rect({
                left: leftPadding+left,
                top: topPadding+top,
                originX: 'left',
                originY: 'top',
                width: width,
                height: height,
                fill: '#000',
                selectable: false,
                evented: false,
                name: 'magStripe'}));

            updateCustomParameters();

            canvas.renderAll();
        }

        function magStripeRemove() {
            canvas.forEachObject(function(object) {
                if (object.get('name') == "magStripe") {
                    canvas.remove(object);
                }
            });

            canvas.renderAll();
        }

        function moveAdditionalLayersToTheTop() {
            canvas.forEachObject(function(object) {
                if (object.name && (object.name == "magStripe" || object.name == "slotPunch" || object.name == "embedded_top")) {
                    canvas.bringToFront(object);
                }
                else if (object.name && (object.name == "embedded_bottom" || object.name == "bg")) {
                    canvas.sendToBack(object);
                }
            });

            canvas.renderAll();
        }

        // TAB: Front Side
        $('#frontSideRemoveBG').on('click', function(){
            canvas.forEachObject(function(object){
                if(object.name && object.name=="bg")
                {
                    object.remove(); //0-1
                    canvas.renderAll();
                }
            });
        });

        $('.frontSideBG').colorpicker().on('changeColor.colorpicker', function(event){
            setBackgroundColor(event.color.toHex());

            canvas.renderAll();
        });

        $('#frontSideColorPicker').on("click", function() {
            $('.btn-tool').removeClass("active");
            $(this).addClass("active");

            toolSelected = "textColorPicker";
            setCursorByTool(toolSelected);
            selectedTextObject = false;
        });

        $('#frontSideTransparency').on("change mousemove", function() {
            var val = $(this).val();

            canvas.forEachObject(function(object){
                if(object.name && object.name=="bg")
                {
                    object.setOpacity(val / 100); //0-1
                    canvas.renderAll();
                }
            });
        });

        function setBackgroundColor(color){
            canvas.setBackgroundImage(generatePixel(encodeHex(color)), canvas.renderAll.bind(canvas), {
                left: leftPadding,
                top: topPadding,
                width: cardWidth,
                height: cardHeight,
                originX: 'left',
                originY: 'top',
                crossOrigin: '*'
            });
        }

        // Genenerate background image (1x1 px gif)
        function encodeHex(s) {
            s = s.substring(1, 7);
            if (s.length < 6) {
                s = s[0] + s[0] + s[1] + s[1] + s[2] + s[2];
            }
            return encodeRGB(
                    parseInt(s[0] + s[1], 16), parseInt(s[2] + s[3], 16), parseInt(s[4] + s[5], 16));
        }

        function encodeRGB(r, g, b) {
            return encode_triplet(0, r, g) + encode_triplet(b, 255, 255);
        }

        function encode_triplet(e1, e2, e3) {
            var keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
            enc1 = e1 >> 2;
            enc2 = ((e1 & 3) << 4) | (e2 >> 4);
            enc3 = ((e2 & 15) << 2) | (e3 >> 6);
            enc4 = e3 & 63;
            return keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
        }

        function generatePixel(color) {
            return "data:image/gif;base64,R0lGODlhAQABAPAA" + color + "/yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==";
        }

        $('#frontSideCopy').on('click', function() {
            if(getUnselectedSide().json == "" || getUnselectedSide().json == cleanTemplate)
                copyThisSideToTheOtherSide();
            else
                $('#modalCopySide').modal('show');
        });

        $('#modalCopySideCopy').on('click', function() {
            copyThisSideToTheOtherSide();
        });

        function copyThisSideToTheOtherSide() {
            getUnselectedSide().json = prepareTemplateForSaving(JSON.stringify(canvas));

            $('#frontSideCopyDone').removeClass('hidden');

            setTimeout(function(){
                $('#frontSideCopyDone').addClass('hidden');
            }, 1500);
        }

        // TAB: Handling Options
        // Letters
        function loadLetters(organizationID, selectID) {
            if(organizationID == -1) {
                updateLetters();
                return;
            }

            $.ajax({
                type: 'GET',
                url: config.apiURL+'organizations/'+organizationID+'/letters',
                success: function(data) {
                    updateLetters(data, selectID);
                },
                error: function(data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function updateLetters(data, selectID) {
            if(selectID)
                var selectedNone = '<option value="none">None</option>';
            else
                var selectedNone = '<option value="none" selected>None</option>';

            $('#editHandlingLetter').empty().append(selectedNone);

            if(!data) return;

            // select an option if it's in card data (later)
            data.sort(dynamicSort("name"));

            for(i=0; i<data.length; i++) {
                var ifSelected = "";
                if(data[i].id == selectID)
                    ifSelected = " selected";

                $('#editHandlingLetter').append('<option value="'+data[i].id+'"'+ifSelected+'>'+data[i].name+'</option>');
            }
        }

        function loadSpecialHandlings(organizationID, selectArray) {
            if(organizationID == -1) {
                insertSpecialHandlingsList();
                return;
            }

            $.ajax({
                type: 'GET',
                url: config.apiURL+'organizations/'+organizationID+'/special_handlings',
                success: function(data) {
                    insertSpecialHandlingsList(data, selectArray);
                },
                error: function(data) {
                    alert(JSON.stringify(data));
                }
            })
        }

        function insertSpecialHandlingsList(data, selectArray) {
            $('#specialHandlings').empty();

            if(!data) return;

            for(i=0; i<data.length; i++) {
                $('#specialHandlings').append('<div class="checkbox"><label><input type="checkbox" value="'+data[i].id+'">'+data[i].name+'</label></div>');
            }

            selectSpecialHandlings(selectArray);
        }

        function selectSpecialHandlings(selectArray) {
            if(!selectArray) return;

            specialHandlings = selectArray;

            $("#specialHandlings input:checkbox").each(function(index) {
                $(this).prop('checked', false);

                for(i=0; i<selectArray.length; i++) {
                    if($(this).val() == selectArray[i].id)
                        $(this).prop('checked', true);
                }
            });
        }

        function updateSpecialHandlings() {
            specialHandlings = [];

            $("#specialHandlings input:checkbox").each(function(index) {
                if($(this).is(":checked")) {
                    specialHandlings.push({
                        id: $(this).val(),
                        name: $(this).parent().text()
                    });
                }
            });
        }

        $(document).on("change","#editHandlingLetter",function (event) {
            letter = $(this).val();
        });

        $(document).on("change","#specialHandlings input:checkbox", function(event){
            updateSpecialHandlings();
        });

        // TAB: View
        function updateGridSize() {
            gridSize = $('#editGridSize').val();
            var gridVal = gridSize;

            if(metric=="mm") {
                gridVal = Math.round(px2mm(gridSize));
                gridSize = mm2px(gridVal);
            }
            else if(metric=="in") {
                gridVal = parseFloat(px2in(gridSize)).toFixed(1);
                if(gridVal==0) gridVal = 0.1;
                gridSize = in2px(gridVal);
            }

            $('#gridSizeVal').text(gridVal+metric);
        }

        $('#editGridSize').on("change mousemove", function() {
            updateGridSize();

            if(gridDraw) {
                hideGrid();
                drawGrid(gridSize);
            }
        });

        $('#gridShow').change(function() {
            gridDraw = !gridDraw;

            if(gridDraw) {
                drawGrid(gridSize);
            }
            else {
                hideGrid();
            }
        });
        $('#gridSnap').change(function() {
            gridSnapTo = !gridSnapTo;
        });

        ///////////////////////////////////////////////////////////////
        //                                                           //
        //                          MODALS                           //
        //                                                           //
        ///////////////////////////////////////////////////////////////

        // MODAL: Template List
        $('#modalLoadTemplate').on('shown.bs.modal', function() {
            updateOrganizationsSelect('#modalLoadTemplateOrganization', templateData.organizationID, templateData.templateID);
            $('#modalLoadTemplateSelect').prop('disabled', true);
            $('#modalLoadTemplateDelete').prop('disabled', true);
        });

        $(document).on("change", "#modalLoadTemplateOrganization", function() {
            updateTemplatesSelect("#modalLoadTemplateTemplate", $(this).val());
        });

        $(document).on("change", "#modalLoadTemplateTemplate", function() {
            onTemplateSelected($(this).val());
        });

        function generateTemplatePreviewBase64(frontJSON, backJSON) {
            if(frontJSON) {
                var card = new Card(frontJSON);

                card.setMode("preview");

                card.base64(function(base64){
                    $('.previewFront').attr("src", base64);
                });
            }
            else
                $('.previewFront').attr("src", "");

            if(backJSON) {
                var card = new Card(backJSON);

                card.setMode("preview");

                card.base64(function(base64) {
                    $('.previewBack').attr("src", base64);
                });
            }
            else
                $('.previewBack').attr("src", "");
        }

        function onTemplateSelected(id) {
            $('#modalConfirmDeletionName').text($('#modalLoadTemplateTemplate option:selected').text());
            $('#modalLoadTemplateSelect').prop('disabled', false);
            $('#modalLoadTemplateDelete').prop('disabled', false);

            $('.previewFront').attr("src", "img/loading_spinner.gif");
            $('.previewBack').attr("src", "img/loading_spinner.gif");

            // load template preview here
            $.ajax({
                type: 'GET',
                url: config.apiURL+'card_templates/'+id+'?organization_id='+$('#modalLoadTemplateOrganization').val(),
                success: function (data) {
                    generateTemplatePreviewBase64(data.front_data, data.back_data);
                    var backColor = getOptionValueByKey(data.options, "color").slice(5);

                    if(backColor=="black")
                        $('.previewBack').addClass('grayscale');
                    else
                        $('.previewBack').removeClass('grayscale');
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        $('#modalLoadTemplateSelect').on("click", function(event) {
            loadCardTemplate($('#modalLoadTemplateOrganization').val(), $('#modalLoadTemplateTemplate').val());
            $('#modalLoadTemplate').modal('hide');
        });

        $('#modalConfirmDeletionDelete').on("click", function(event) {
            var id = $('#modalLoadTemplateTemplate').val();

            if(templateData.templateID==id)
                templateData.templateID = -1;

            deleteCardTemplate($('#modalLoadTemplateOrganization').val(), id);
            $('#modalConfirmDeletion').modal('hide');

            $('#modalLoadTemplateSelect').prop('disabled', true);
            $('#modalLoadTemplateDelete').prop('disabled', true);
            updateTemplatesSelect("#modalLoadTemplateTemplate", $("#modalLoadTemplateOrganization").val());
        });

        // MODAL: Add new image

        // https://instantcard.herokuapp.com:443/api/v1/card_templates/16/upload?organization_id=1

        $(document).on("click","#modalSelectImage .imageListPic img", function () {
            $('#modalSelectImagePreview').attr("src", $(this).attr("src"));
            $('.imageListPic img').removeClass('selected');
            $('#modalSelectImageSelect').prop('disabled', false);
            $(this).addClass('selected');
        });

        $('#modalSelectImageUpload').on("click", function() {
            $('#modalSelectImageUploadInput').trigger("click");
        });

        $("#modalSelectImageUploadInput").change(function() {
            var img = new FormData($('#modalSelectImageUploadForm')[0]);

            $.ajax({
                type: 'POST',
                url: config.apiURL+'card_templates/'+templateData.templateID+'/upload?organization_id='+templateData.organizationID,
                async: false,
                data: img,
                success: function (data) {
                    updateImageList();
                },
                error: function (response) {
                    alert('error: '+JSON.stringify(response));
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        $('#modalSelectImageSelect').on("click", function() {
            loadingCanvas(true);
            var width   = $('.imageListPic .selected').get(0).naturalWidth,
                height  = $('.imageListPic .selected').get(0).naturalHeight,
                left    = Math.ceil(config.canvasWidth/2 - width/2),
                top     = Math.ceil(config.canvasHeight/2 - height/2);

            // https://github.com/kangax/fabric.js/issues/263
            // https://github.com/kangax/fabric.js/issues/1617

            fabric.Image.fromURL($('.imageListPic .selected').attr('data-url'), function(img) {
                img.left = left;
                img.top = top;
                img.lockUniScaling = true;

                //if(width>=height && width>config.canvasWidth) img.scaleToWidth(config.canvasWidth-100);
                //else if (height>width && height>config.canvasHeight) img.scaleToHeight(config.canvasHeight-100);
                canvas.add(img);
                canvas.renderAll();
            }, {crossOrigin: '*'});

            setTimeout(function(){
                resizeHugeObject(newestObject());

                addSnapshotToHistory();
                selectDefaultTool();
                //selectNewestObject();
                // close the modal here
                $('#modalSelectImageSelect').prop('disabled', true);
                $('.imageListPic img').removeClass('selected');
                $('#modalSelectImage').modal('hide');
                loadingCanvas(false);
            }, 1000);
        });

        $('#modalSelectImage').on('shown.bs.modal', function() {
            if(templateData.templateID == -1) { // if the user haven't saved the template yet
                $('#menuTemplateSaveAs').trigger("click");
                $('#modalSaveAsTemplateWarning').removeClass('hidden');

                return;
            }

            updateImageList();
        });

        function updateImageList() {
            if(templateData.organizationID == -1 || templateData.templateID == -1) return;

            $.ajax({
                type: 'GET',
                url: config.apiURL+'card_templates/'+templateData.templateID+'?organization_id='+templateData.organizationID,
                success: function (data) {
                    $('#modalSelectImageList').empty();

                    for(i=0; i<data.images.length; i++) {
                        convertImgToBase64URL(data.images[i].url, function(base64Img, url){
                            $('#modalSelectImageList').append('<div class="imageListPic"><img class="img-responsive" data-url="'+url+'" src="' + base64Img + '"></div>');
                        });
                    }
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        function convertImgToBase64URL(url, callback, outputFormat){
            var img64 = new Image();
            img64.crossOrigin = 'Anonymous';
            img64.onload = function(){
                var canvas64 = document.createElement('CANVAS'),
                        ctx = canvas64.getContext('2d'), dataURL;
                canvas64.height = this.height;
                canvas64.width = this.width;
                ctx.drawImage(this, 0, 0);
                dataURL = canvas64.toDataURL(outputFormat);
                callback(dataURL, url);
                canvas64 = null;
            };
            img64.src = url;
        }

        // MODAL: Change background

        $(document).on("click","#modalSelectBG .imageListPic img", function () {
            $('#modalSelectBGPreview').attr("src", $(this).attr("src"));
            $('.imageListPic img').removeClass('selected');
            $('#modalSelectBGSelect').prop('disabled', false);
            $(this).addClass('selected');
        });

        $('#modalSelectBGUpload').on("click", function() {
            $('#modalSelectBGUploadInput').trigger("click");
        });

        $("#modalSelectBGUploadInput").change(function() {
            var img = new FormData($('#modalSelectBGUploadForm')[0]);

            $.ajax({
                type: 'POST',
                url: config.apiURL+'card_templates/'+templateData.templateID+'/upload?organization_id='+templateData.organizationID,
                async: false,
                data: img,
                success: function (data) {
                    updateBGImageList();
                },
                error: function (response) {
                    alert('error: '+JSON.stringify(response));
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        $('#modalSelectBG').on('shown.bs.modal', function() {
            if(templateData.templateID == -1) { // if the user haven't saved the template yet
                $('#menuTemplateSaveAs').trigger("click");
                $('#modalSaveAsTemplateWarning').removeClass('hidden');

                return;
            }

            updateBGImageList();
        });

        function updateBGImageList() {
            if(templateData.organizationID == -1 || templateData.templateID == -1) return;

            $.ajax({
                type: 'GET',
                url: config.apiURL+'card_templates/'+templateData.templateID+'?organization_id='+templateData.organizationID,
                success: function (data) {
                    $('#modalSelectBGImageList').empty();

                    for(i=0; i<data.images.length; i++) {
                        convertImgToBase64URL(data.images[i].url, function(base64Img, url){
                            $('#modalSelectBGImageList').append('<div class="imageListPic"><img class="img-responsive" data-url="' + url + '" src="' + base64Img + '"></div>');
                        });
                    }

                    for(i=0; i<defaultBG.length; i++) {
                        $('#modalSelectBGImageList').append('<div class="imageListPic"><img class="img-responsive" data-url="' + defaultBG[i].url + '" src="' + defaultBG[i].url + '"></div>');
                    }
                },
                error: function (data) {
                    alert(JSON.stringify(data));
                }
            });
        }

        $('#modalSelectBGSelect').on("click", function() {
            setBackground($('.imageListPic .selected').attr('data-url'));

            addSnapshotToHistory();
            selectDefaultTool();
            // close the modal here
            $('#modalSelectBGSelect').prop('disabled', true);
            $('.imageListPic img').removeClass('selected');
            $('#modalSelectBG').modal('hide');
        });

        function setBackground(url) {
            // remove previous bg
            canvas.forEachObject(function (object) { // check this side
                if (object.name && object.name == "bg") {
                    canvas.remove(object);
                }
            });

            // add new bg
            fabric.Image.fromURL(url, function(img) {
                img.left = leftPadding;
                img.top = topPadding;
                img.width = cardWidth;
                img.height = cardHeight;

                img.opacity = $('#frontSideTransparency').val() / 100;

                img.selectable = false;
                img.evented = false;

                img.name = "bg";

                canvas.add(img);
                canvas.renderAll();
            }, {crossOrigin: '*'});
        }

        //////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////
        // Initialization
        //

        var canvas          = new fabric.CanvasWithViewport('c');

        canvas.setHeight(config.canvasHeight); // main canvas
        canvas.setWidth(config.canvasWidth);

        //////////////////////////////////////////////////////////////////
        //                                                              //
        //                          FUNCTIONS                           //
        //                                                              //
        //////////////////////////////////////////////////////////////////

        // Preparing canvas
        function resizeCard(width, height, dontRemoveOffset) {    // gets width and height in mm and resizes the card in pixels
            var maxWidth    = 457,
                maxHeight   = 457;              // cardWidth = 457, cardHeight = 288; - now

            if(!dontRemoveOffset)
                removeOffsetFromAllObjects();
            //var json = JSON.stringify(canvas);

            if(width>=height) {
                cardWidth   = maxWidth;
                cardHeight  = Math.ceil((maxWidth/width)*height);
            }
            else {
                cardHeight  = maxHeight;
                cardWidth   = Math.ceil((maxHeight/height)*width);
            }

            leftPadding = Math.ceil((config.canvasWidth-cardWidth)/2);
            topPadding  = Math.ceil((config.canvasHeight-cardHeight)/2);

            getSelectedSide().leftPadding   = leftPadding;
            getSelectedSide().topPadding    = topPadding;

            //loadCanvasFromJSON(json);
            addOffsetToAllObjects();
            canvas.renderAll();
        }

        function resizeCardBasedOnSelectVal(val) {
            if(val==0) {
                if(getSelectedSide().orientation=="landscape")
                    resizeCard(85.6, 54);
                else
                    resizeCard(54, 85.6);
            }
            else if(val==1) {
                if(getSelectedSide().orientation=="landscape")
                    resizeCard(60, 20);
                else
                    resizeCard(20, 60);
            }
        }

        // Grid

        function drawGrid(size) {
            var gridCanvas = document.getElementById("gridCanvas");
            var gridContext = gridCanvas.getContext("2d");

            gridContext.clearRect(0, 0, gridCanvas.width, gridCanvas.height);

            var gridOpts = {
                distance:    parseInt(size),
                lineWidth:   1,
                gridColor:   "#ccc",
                caption:     true,
                width:       cardWidth,
                height:      cardHeight,
                paddingLeft: leftPadding,
                paddingTop:  topPadding,
                metric:      metric
            };
            new Grid(gridOpts).draw(gridContext);

            var gridBase64 = gridCanvas.toDataURL();
            canvas.setOverlayImage(gridBase64, canvas.renderAll.bind(canvas), {
                opacity: 0.4
            });
        }

        function hideGrid() {
            canvas.setOverlayImage(null, canvas.renderAll.bind(canvas));
        }

        //

        function textButtonsClearState() {
            $('#editTextText').val("");
            $("#editTextBold, #editVarTextBold").removeClass("active");
            $("#editTextItalic, #editVarTextItalic").removeClass("active");
            $("#editTextUnderline, #editVarTextUnderline").removeClass("active");
        }

        function selectDefaultTool() {
            selectTool("toolDefault");
        }

        function createNewTextObject(posX, posY, variable) {
            var text = 'Static Text';

            if(variable) {
                if(varTextFields[0] && varTextFields[0].name != "")
                    text = varTextFields[0].name;
                else
                    text = "Variable Text";

                templateFieldsChangeVariable("text", "", text);
            }

            canvas.add(new fabric.StaticText(text, {
                left: posX,
                top: posY,
                fontFamily: 'Arial',
                fontSize: 30,
                fontSizeOriginal: 30,
                evented: false,
                selectable: false,
                variable: variable,
                autoResize: variable,
                clipTo: function(ctx){
                    ctx.rect(this.clipLeft, this.clipTop, this.clipWidth, this.clipHeight);
                }
            }));
        }

        function createTextRect(options) {
            rect = new fabric.Rect({
                left: options.left,
                top: options.top,
                originX: 'left',
                originY: 'top',
                width: options.width,
                height: options.height,
                angle: 0,
                fill: 'rgba(0,0,0,0)',
                name: 'textRect'//,
                //lockRotation: true
            });

            canvas.add(rect);
        }

        function generateTextID() {
            var gotName = false,
                i = -1,
                textID;

            while(!gotName) {
                i++;
                textID = "text_"+i;
                gotName = true;

                canvas.forEachObject(function (object) { // check this side
                    if (object.textID == textID) {
                        gotName = false;
                    }
                });
            }

            return textID;
        }

        function attachTextToRect(text, rect) {
            var textID = generateTextID();
            text.textID = textID;
            rect.textID = textID;
        }

        function getTextByTextID(textID) {
            var text = false;

            canvas.forEachObject(function (object) {
                if ((object.type == "static-text" || object.type == "variable-text") && object.textID == textID) {
                    text = object;
                }
            });

            return text;
        }

        function getRectByTextID(textID) {
            var rect = false;

            canvas.forEachObject(function (object) {
                if (isTextRect(object) && object.textID == textID) {
                    rect = object;
                }
            });

            return rect;
        }

        function updateTextObject(text) {
            resizeObject(text);
            recalcTextPosition(text.textID);
        }

        function recalcTextPosition(textID, groupLeft, groupTop, groupAngle) {
            var text = getTextByTextID(textID),
                rect = getRectByTextID(textID),
                angle = rect.angle,
                top, left, rectLeft, rectTop;

            groupLeft = groupLeft || 0;
            groupTop = groupTop || 0;
            groupAngle = groupAngle || 0;

            if(groupAngle != 0) angle = groupAngle; //TODO: calc difference
            //canvas.renderAll();

            if(groupLeft != 0 || groupTop != 0) {
                left = groupLeft;
                top = groupTop;
            }
            else {
                top = rect.top;
                left = rect.left;
            }
            rectLeft = left;
            rectTop = top;

            if(rect.originX == "center") {
                var point = rect.translateToOriginPoint(new fabric.Point(left, top), "left", "top");
                rectLeft = point.x;
                rectTop = point.y;
            }

            if(text.textAlign == "center") {
                if(angle==270) {
                    top = rectTop - (rect.width - text.width)/2;
                    left = rectLeft;
                }
                else if(angle==90) {
                    top = rectTop + (rect.width - text.width)/2;
                    left = rectLeft;
                }
                else if(angle==180) {
                    top = rectTop;
                    left = rectLeft - (rect.width - text.width)/2;
                }
                else {
                    left = rectLeft + (rect.width - text.width)/2;
                    top = rectTop;
                }
            }
            else if(text.textAlign == "right") {
                if(angle==270) {
                    top = rectTop - (rect.width - text.width);
                    left = rectLeft;
                }
                else if(angle==90) {
                    top = rectTop + (rect.width - text.width);
                    left = rectLeft;
                }
                else if(angle==180) {
                    top = rectTop;
                    left = rectLeft - (rect.width - text.width);
                }
                else {
                    left = rectLeft + (rect.width - text.width);
                    top = rectTop;
                }
            }
            else {
                left = rectLeft;
                top = rectTop;
            }

            var setAngle = rect.angle;
            if(groupAngle) setAngle = groupAngle;

            text.set({
                left:   left,
                top:    top,
                //originX: rect.originX,
                //originY: rect.originY,
                angle: setAngle
                //width: width,
                //height: rect.height
            });

            recalcTextClipping(textID);

            /*
            var text = getTextByTextID(textID),
                rect = getRectByTextID(textID),
                top, left, width;

            groupLeft = groupLeft || 0;
            groupTop = groupTop || 0;

            canvas.renderAll();

            var realTextWidth = text.width*text.scaleX;

            var realText = new fabric.StaticText(text.text, {
                fontFamily: text.fontFamily,
                fontWeight: text.fontWeight,
                fontStyle: text.fontStyle,
                fontSize: text.fontSize
            });

            var realWidth = realText.getWidth();
            if(realTextWidth > realWidth) realTextWidth = realWidth;

            if(groupLeft != 0 || groupTop != 0) {
                left = groupLeft;
                top = groupTop;
            }
            else {
                top = rect.top;
                left = rect.left;
            }

            if (rect.width > realTextWidth && text.align != "left") {
                console.log(rect.width);
                console.log(realTextWidth);

                width = text.width;

                if(text.angle == "90") {
                    if(text.align == "center")
                        top = top + (rect.width - realTextWidth)/2;
                    else if(text.align == "right")
                        top = top + (rect.width - realTextWidth);
                }
                else if(text.angle == "270") {
                    if(text.align == "center")
                        top = top - (rect.width - realTextWidth)/2;
                    else if(text.align == "right")
                        top = top - (rect.width - realTextWidth);
                }
                else {
                    if(text.align == "center")
                        left = left + (rect.width - realTextWidth)/2;
                    else if(text.align == "right")
                        left = left + (rect.width - realTextWidth);
                }
            }
            else {
                left = left;
                width = rect.width;
            }

            text.set({
                left:   left,
                top:    top,
                originX: rect.originX,
                originY: rect.originY,
                angle: rect.angle,
                width: width,
                height: rect.height
            });

            recalcTextClipping(textID);*/
        }

        function recalcTextClipping(textID) {
            var text = getTextByTextID(textID),
                rect = getRectByTextID(textID);

                text.set({
                    clipLeft: -text.width / 2,
                    clipTop: -text.height / 2,
                    clipWidth: rect.width,
                    clipHeight: rect.height
                });

            //resizeObject(text);
        }

        function createNewVarImageObject(posX, posY, width, height) {
            var imgElement = document.getElementById('img-var-img');
            var imageName = "Variable Image";

            if(varImageFields[0] && varImageFields[0].name != "")
                imageName = varImageFields[0].name;

            if(!width || !height) {
                width = 128;
                height = 155;
            }

            var imgInstance = new fabric.VariableImage(imgElement, {
                left: posX,
                top: posY,
                width: width,
                height: height,
                name: imageName
            });
            canvas.add(imgInstance);

            templateFieldsChangeVariable("image", "", imageName, {width:width, height:height});
        }

        function generateBarcodeToken(type) {
            if(!type) return false;

            var token = "",
                isUnique = false,
                i = 0,
                data = false;

            if(sides=="double" && getUnselectedSide().json != "") {
                data = JSON.parse(getUnselectedSide().json);
            }

            if(type=="qrcode") token="qrcode_";
            else token="barcode_";

            while (!isUnique) {
                var notUnique = false,
                    thisToken = token+i;

                canvas.forEachObject(function (object) { // check this side
                    if (object.type == "barcode" && object.name == thisToken) {
                        notUnique = true;
                    }
                });

                if(data && !notUnique) { // check the other side
                    for (var z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == "barcode" && data.objects[z].name == thisToken) {
                            notUnique = true;
                        }
                    }
                }

                if(!notUnique) {
                    isUnique = true;
                    token = thisToken;
                }
                else i++;
            }

            return token;
        }

        function createNewBarcode(data) {
            data.type = data.type || 'code39';
            data.posX = data.posX || leftPadding;
            data.posY = data.posY || topPadding;
            data.textType = data.textType || 'fixed';
            data.text = data.text || "";

            if(!data.hasOwnProperty('stroke')) data.stroke = '#425564';
            if(!data.strokeWidth && data.strokeWidth !== 0) data.strokeWidth = 1;

            data.barWidth = data.barWidth || '5';
            if(!data.hasOwnProperty('quietZone')) data.quietZone = 10;

            var lockUniScaling = false;

            if(data.type=="qrcode") {
                data.width = data.width || 75;
                data.height = data.height || 75;
                lockUniScaling = true;
            }
            else {
                data.width = data.width || 155;
                data.height = data.height || 75;
            }

            if(!data.name) {
                var i=0;
                if(data.type=='qrcode') {
                    canvas.forEachObject(function(object) {
                        if (object.type == "barcode" && object.barcodeType == "qrcode") {
                            i++;
                        }
                    });
                    data.name = generateBarcodeToken("qrcode");
                }
                else {
                    canvas.forEachObject(function(object) {
                        if (object.type == "barcode" && object.barcodeType != "qrcode") {
                            i++;
                        }
                    });
                    data.name = generateBarcodeToken("barcode");
                }
            }

            var imgElement, width, height;

            if(data.type=='qrcode') {
                imgElement  = document.getElementById('img-barcode-qr');
                //barcodeType = 'qrcode';
            }
            else if(data.type.slice(0, -1)=='code128') {
                imgElement  = document.getElementById('img-barcode-code128');
                //barcodeType = 'code128';
            }
            else if(data.type=='Code25' || data.type=='Code25Interleaved' || data.type=='Code25IATA') {
                imgElement = document.getElementById('img-barcode-code25');
            }
            else if(data.type=='code39' || data.type=='code39extended') {
                imgElement  = document.getElementById('img-barcode-code39');
                //barcodeType = 'code39';
            }

            var imgInstance = new fabric.Barcode(imgElement, {
                left: data.posX,
                top: data.posY,
                stroke: data.stroke,
                strokeWidth: data.strokeWidth,
                width: data.width,
                height: data.height,
                name: data.name,
                barcodeType: data.type,
                textType: data.textType,
                text: data.text,
                lockUniScaling: lockUniScaling,
                barWidth: data.barWidth,
                quietZone: data.quietZone
            });

            canvas.add(imgInstance);

            var barcodeData;

            if(data.type=='qrcode') {
                barcodeData = {
                    type:   "qrcode",
                    token:  data.name,
                    data:   [{
                        qrcode:    data.text
                    }]
                };
            }
            else {
                barcodeData = {
                    type:   "barcode",
                    token:  data.name,
                    data:   [{
                        symbology:  data.type
                    },{
                        barcode:    data.text
                    },{
                        bar_width:  data.barWidth
                    },{
                        quiet_zone: data.quietZone
                    }]
                };
            }

            cardDataAdd(barcodeData);
        }

        function textFontDropdownSet(text) {
            $('#editTextFont, #editVarTextFont').html(text+'<span class="caret"></span>');

            $('#editTextFont, #editVarTextFont').css('font-family', text);
        }

        function selectTool(tool) {
            grabMode(false);

            if(tool=="toolText" || tool=="toolVarText" || tool=="toolVarImage" || tool=="toolDrawObject" || tool=="toolBarcode" || tool=="toolQrcode") {
                canvas.deactivateAllWithDispatch().renderAll();

                canvas.forEachObject(function(object){
                    object.selectable = false;
                    object.evented = false;
                });
            }
            else {
                canvas.forEachObject(function(object){
                    if(object.name != "magStripe" && object.name != "slotPunch" && object.name != "embedded_top" && object.name != "embedded_bottom" && object.name != "bg" && object.type != "static-text") {
                        object.selectable = true;
                        object.evented = true;
                    }
                });

                updateLayerList();
            }

            $('.btn-tool').removeClass("active");
            //$('#editTextColorPicker, #editVarTextColorPicker, #editShapeColorPicker, #frontSideColorPicker, #editImageBorderColorPicker, #editVarImageBorderColorPicker, #editShapeBorderColorPicker, #editImageRemoveWhiteColorPicker').removeClass("active");
            $('.fa-eyedropper').parent().removeClass('active');

            $('#'+tool).addClass("active");

            toolSelected = tool;
            setCursorByTool(tool);
        }

        function setCursorByTool(tool) {
            var cursor = "default";
            if (tool=="toolDefault") cursor = "default";
            else if (tool=="toolText" || tool=="toolVarText") cursor = "text";
            else if (tool=="textColorPicker" || tool=="toolDrawObject" || tool=="toolVarImage" || tool=="toolBarcode" || tool=="toolQrcode") cursor = "crosshair";

            canvas.defaultCursor = cursor;

            if (tool=="toolDefault")
                canvas.hoverCursor = "move";
            else
                canvas.hoverCursor = cursor;
        }

        function makeTabActive(name) {
            $('.nav-tabs li').removeClass('active');
            $('.'+name).parent().addClass('active');
            $('.tab').addClass('hidden');
            $('#'+name).removeClass('hidden');
            showTab(name);
            scrollerReset();
        }

        function showTab(name) {
            $('.'+name).parent().removeClass('hidden');
        }

        function makeFirstTabActive() {
            makeTabActive($('.nav-tabs li:not(.hidden):first a').attr('class'));
        }

        function hideTab(name) {
            $('.'+name).parent().addClass('hidden');
            $('#'+name).addClass('hidden');
            scrollerReset();
        }

        function hideToolTabs() {
            //$('.tab-newImage').parent().addClass('hidden');
            $('.tab-text').parent().addClass('hidden');
            $('.tab-varText').parent().addClass('hidden');
            $('.tab-shape').parent().addClass('hidden');
            $('.tab-image').parent().addClass('hidden');
            $('.tab-varImage').parent().addClass('hidden');
            $('.tab-barcode').parent().addClass('hidden');
            $('.tab-qrcode').parent().addClass('hidden');
            $('.tab-align').parent().addClass('hidden');
            makeTabActive('tab-card');
        }

        function selectNewestObject(dontSkipAdditionalLayers) {
            canvas.setActiveObject(newestObject(dontSkipAdditionalLayers));
        }

        function newestObject(dontSkipAdditionalLayers) {
            var canvas_objects = canvas._objects;

            if(canvas_objects.length == 0) return false;

            if(!dontSkipAdditionalLayers) {
                for(i=canvas_objects.length-1; i>-1; i--) {
                    var object = canvas_objects[i];
                    if(object.name != "magStripe" && object.name != "slotPunch" && object.name != "embedded_top" && object.name != "embedded_bottom")
                        return object;
                }
                /*var offset = 0;

                if (canvas_objects.length>0 && (canvas_objects[canvas_objects.length - 1].name == "slotPunch" || canvas_objects[canvas_objects.length - 1].name == "magStripe"))
                    offset++;
                if (canvas_objects.length>1 && (canvas_objects[canvas_objects.length - 2].name == "slotPunch" || canvas_objects[canvas_objects.length - 2].name == "magStripe"))
                    offset++;

                if (offset + 1 > canvas_objects.length) return;

                return canvas_objects[canvas_objects.length - 1 - offset]; //Get last object*/
            }
            else {
                return canvas_objects[canvas_objects.length - 1];
            }
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function stripBrackets(string) {
            if(string.substring(0, 3)=="{{{")
                return string.substring(3, string.length-3);
            else
                return string;
        }

        function updateLayerList() {
            $('.layersList').empty();
            $('.layersList').append('<ul>');

            var buttonsUp = '<a href="" class="layerUp"><i class="fa fa-angle-up"></i></a><a href="" class="layerUpAll"><i class="fa fa-angle-double-up"></i></a>',
                buttonsDown = '<a href="" class="layerDownAll"><i class="fa fa-angle-double-down"></i></a><a href="" class="layerDown"><i class="fa fa-angle-down"></i></a>',
                i = canvas.getObjects().length - 1,
                selectedObject = getSelectedObjectID();

            canvas.forEachObject(function(object){
                if(object.get('name')=="slotPunch" || object.get('name')=="magStripe" || object.evented == false) {
                    i--;
                    return;
                }

                var type = object.get('type');
                var text = type;

                //if(type=="static-text" || type=="variable-text") text=object.getText();
                if (isTextRect(object)) {
                    var txt = getTextByTextID(object.textID).text;
                    if(txt) text = txt;
                }
                else if(type=="variable-image") text = object.name;
                else if(type=="barcode") {
                    var barcodeName = object.name.split('_');
                    if(barcodeName[0] == "qrcode") text = "QR Code "+(parseInt(barcodeName[1])+1);
                    else text = "Barcode "+(parseInt(barcodeName[1])+1);
                }
                else if(type=="rect") text = "Rectangle";

                var layerClass = "btn-layer";
                if(selectedObject === i) layerClass += " active";

                $('.layersList').append('<li class="'+layerClass+'" id="layer'+i+'"><div class="row"><div class="col-xs-2">'+buttonsDown+'</div><div class="col-xs-8 layerText"><p class="text-nowrap">' + capitalizeFirstLetter(text) + '</p></div><div class="col-xs-2">'+buttonsUp+'</div></div></li>');
                i--;
            });

            $('.layersList').append('</ul>');
        }

        function removeCornersFromTextObjects() {
            canvas.forEachObject(function(object){
                if(object.get('type')=="static-text" || object.get('type')=="variable-text") {
                    object.hasControls = false;
                }
            });
        }

        function resizeAllTextObjects() {
            canvas.forEachObject(function(object) {
                resizeObject(object);
            });
        }

        function updateAlign(object) {
            /*
            if(object.get('type') == "static-text" || object.get('type')=="variable-text")
                object.setTextAlign(object.align);

            if(object.get('type')!="variable-text") return;

            object.left = object.left - object.offsetLeft; // move the object to the default position
            object.offsetLeft = 0;

            if(object.width > object.maxWidth) return;

            if(object.align=="right") {
                object.offsetLeft = object.maxWidth - object.width;
                object.left = object.left + object.offsetLeft;
            }
            else if(object.align=="center") {
                object.offsetLeft = Math.ceil((object.maxWidth - object.width)/2);
                object.left = object.left + object.offsetLeft;
            }

            object.setCoords();*/
        }

        function updateAlignOfAllObjects() {
            canvas.forEachObject(function(object){
                //updateAlign(object);
            });
            canvas.renderAll();
        }

        function addOffsetToAllObjects() {
            var left    = getSelectedSide().leftPadding,
                top     = getSelectedSide().topPadding;

            canvas.forEachObject(function(object){
                object.left += left;
                object.top  += top;
                object.setCoords();
            });

            if(canvas.backgroundImage) {
                canvas.backgroundImage.width = cardWidth;
                canvas.backgroundImage.height = cardHeight;
                canvas.backgroundImage.left += left;
                canvas.backgroundImage.top += top;
            }
        }

        function removeOffsetFromAllObjects() {
            var left    = getSelectedSide().leftPadding,
                top     = getSelectedSide().topPadding;

            canvas.forEachObject(function(object){
                object.left -= left;
                object.top  -= top;
            });

            if(canvas.backgroundImage) {
                canvas.backgroundImage.left -= left;
                canvas.backgroundImage.top -= top;
            }
        }

        function setCoordsOfAllObjects() {
            canvas.forEachObject(function(object){
                object.setCoords();
            });
        }

        function makeAllObjectsUnselectable() {
            canvas.deactivateAllWithDispatch().renderAll();
            canvas.forEachObject(function(object){ object.selectable = false });
        }

        function makeAllObjectsSelectable() {
            canvas.forEachObject(function(object){ object.selectable = true });
        }

        function getObjectID(object) {
            return canvas.getObjects().indexOf(object);
        }

        function getSelectedObjectID() {
            return canvas.getObjects().indexOf(canvas.getActiveObject());
        }

        // Variable Fields
        function updateVarTextList() {
            $("#editVarTextVariable option").remove();

            for(i=0; i<varTextFields.length; i++) {
                $('#editVarTextVariable')
                        .append($('<option>', { value : varTextFields[i].id })
                        .text(varTextFields[i].name));
            }
        }

        function getVarTextNameFromID(id) {
            for(i=0; i<varTextFields.length; i++) {
                if(varTextFields[i].id == id) return varTextFields[i].name;
            }
        }

        function getVarTextIDFromName(name) {
            for(i=0; i<varTextFields.length; i++) {
                if(varTextFields[i].name == name) return varTextFields[i].id;
            }
        }

        function getVarBarcodeNameFromID(id) {
            for(i=0; i<varBarcodeFields.length; i++) {
                if(varBarcodeFields[i].id == id) return varBarcodeFields[i].name;
            }
        }

        function getVarBarcodeIDFromName(name) {
            for(i=0; i<varBarcodeFields.length; i++) {
                if(varBarcodeFields[i].name == name || name == removeUnsupportedCharacters(varBarcodeFields[i].name)) {
                    return varBarcodeFields[i].id;
                }
            }
        }

        function updateVarBarcodeList(type) {
            if(type != "qrcode") type = "barcode";

            $("#editBarcodeTextVariable option, #editQrcodeTextVariable option").remove();

            for(i=0; i<varBarcodeFields.length; i++) {
                // check if type is correct
                for(z=0; z<varBarcodeFields[i].type.length; z++) {
                    if(type==varBarcodeFields[i].type[z]) {
                        $('#editBarcodeTextVariable, #editQrcodeTextVariable')
                                .append($('<option>', { value : varBarcodeFields[i].id })
                                    .text(varBarcodeFields[i].name));
                    }
                }
            }
        }

        function updateVarMagstripeLists() {
            $("#magstripeTrack1 option, #magstripeTrack2 option, #magstripeTrack3 option").remove();

            $("#magstripeTrack1, #magstripeTrack2, #magstripeTrack3")
                    .append($('<option>', { value : -1 })
                            .text(""));

            var track1 = getMagstripeVal('track1'),
                track2 = getMagstripeVal('track2'),
                track3 = getMagstripeVal('track3');

            for(i=0; i<varBarcodeFields.length; i++) {
                for(z=0; z<varBarcodeFields[i].type.length; z++) {
                    if(varBarcodeFields[i].type[z] == "track1" || varBarcodeFields[i].type[z] == "track2" || varBarcodeFields[i].type[z] == "track3") {
                        var option = "<option>";

                        if ((varBarcodeFields[i].type[z] == "track1" && track1 == '{{{'+removeUnsupportedCharacters(varBarcodeFields[i].name)+'}}}') ||
                            (varBarcodeFields[i].type[z] == "track2" && track2 == '{{{'+removeUnsupportedCharacters(varBarcodeFields[i].name)+'}}}') ||
                            (varBarcodeFields[i].type[z] == "track3" && track3 == '{{{'+removeUnsupportedCharacters(varBarcodeFields[i].name)+'}}}'))
                            option = "<option selected>";

                        $('#magstripe'+capitalizeFirstLetter(varBarcodeFields[i].type[z]))
                            .append($(option, { value : varBarcodeFields[i].id })
                                    .text(varBarcodeFields[i].name));
                    }
                }
            }
        }

        function getMagstripeVal(track) {
            for(i=0; i<cardData.length; i++) {
                if(cardData[i].type=="magstripe") {
                    if(track == "track1")
                        return cardData[i].data[0].track1;
                    else if(track == "track2")
                        return cardData[i].data[1].track2;
                    else
                        return cardData[i].data[2].track3;
                }
            }
            return false;
        }

        function updateVarImageList() {
            $("#editVarImageVariable option").remove();

            for(i=0; i<varImageFields.length; i++) {
                $('#editVarImageVariable')
                        .append($('<option>', { value : varImageFields[i].id })
                                .text(varImageFields[i].name));
            }
        }

        function getVarImageNameFromID(id) {
            for(i=0; i<varImageFields.length; i++) {
                if(varImageFields[i].id == id) return varImageFields[i].name;
            }
        }

        function getVarImageIDFromName(name) {
            for(i=0; i<varImageFields.length; i++) {
                if(varImageFields[i].name == name) return varImageFields[i].id;
            }
        }

        function resizeVariableImage(object) {
            var objectWidth     = object.getWidth(),
                objectHeight    = object.getHeight();

            object.scale(1);
            object.setWidth(objectWidth);
            object.setHeight(objectHeight);

            object.setCoords();
            canvas.renderAll();
        }

        // Dropdown in a scrollable div fix
        $('.dropdown-toggle').click(function (){
            dropDownFixPosition($(this),$('.dropdown-menu'));
        });

        function dropDownFixPosition(button,dropdown){
            var dropDownTop = button.offset().top + button.outerHeight() - $(window).scrollTop();
            dropdown.css('top', dropDownTop + "px");
            dropdown.css('left', button.offset().left + "px");
        }

        // front & back
        function flipSides(onSuccess) {
            unlockSelection();

            getSelectedSide().json = prepareTemplateForSaving(JSON.stringify(canvas));

            if(getUnselectedSide().json=="") {getUnselectedSide().orientation = orientation;}

            cardSides[0].isSelected = !cardSides[0].isSelected;
            cardSides[1].isSelected = !cardSides[1].isSelected;

            loadCanvasFromJSON(getSelectedSide().json, canvas, true, function(){

                getSelectedSide().leftPadding = leftPadding;
                getSelectedSide().topPadding = topPadding;

                if(cardSides[0].isSelected) {
                    $('.tab-frontSide').text('Front Side');
                    $('#frontSideRemoveBG').parents().eq(2).show();
                }
                else {
                    $('.tab-frontSide').text('Back Side');
                    $('#frontSideRemoveBG').parents().eq(2).hide();
                }

                updateLayerList();

                var thisSide = selectedSideID();

                if(thisSide != selectedSideID()) return;

                colorCanvasIfNeeded();
                grayscaleCanvasIfNeeded();
                updateSlotPunch('flipSides');
                magStripeAdd();
                clearHistory();
                addSnapshotToHistory();

                if(typeof(onSuccess) == "function")
                    onSuccess();
            });
        }

        // undo & redo

        var history = [];

        function addSnapshotToHistory(snapshot) {
            // find an active snapshot and delete everything after it if needed
            var deleteAfter = history.length;

            for(i=0; i<history.length; i++) {
                if(history[i].active==true) {
                    history[i].active = false;
                    deleteAfter = i+1;
                    break;
                }
            }

            if(deleteAfter != history.length) {
                history.splice(deleteAfter, history.length - deleteAfter);
            }

            // check if the new snapshot is different from the previous one and add it to history if it is
            var json;

            if(!snapshot)
                json = prepareTemplateForSaving(JSON.stringify(canvas));
            else
                json = snapshot;

            if(history.length==0 || json!=history[history.length-1].json) {
                history.push({
                    json: json,
                    active: true
                });
            }

            if(history.length>15) {
                history.splice(0, 1);
            }

            makeRedoButtonInactive();
            if(history.length>1) makeUndoButtonActive();
            else makeUndoButtonInactive();

            printHistory();
        }

        function printHistory() {
            //$('#history').text(JSON.stringify(history));
        }

        function undo() {
            if($('#undo').prop('disabled')) return;

            for(i=0; i<history.length; i++) {
                if(history[i].active) {
                    if(i==0) return;
                    else if(i==1) makeUndoButtonInactive();
                    makeRedoButtonActive();

                    history[i].active = false;
                    history[i-1].active = true;

                    loadCanvasFromJSON(history[i-1].json, true);
                    printHistory();
                    return;
                }
            }

            printHistory();
        }

        function redo() {
            if($('#redo').prop('disabled')) return;

            for(var i=0; i<history.length-1; i++) {
                if(history[i].active) {
                    history[i].active = false;
                    history[i+1].active = true;

                    if(i+2==history.length) {
                        makeRedoButtonInactive();
                        makeUndoButtonActive();
                    }

                    loadCanvasFromJSON(history[i+1].json, true);

                    printHistory();
                    return;
                }
            }

            printHistory();
        }

        function makeRedoButtonActive() {
            $('#redo').prop('disabled', false);
        }

        function makeRedoButtonInactive() {
            $('#redo').prop('disabled', true);
        }

        function makeUndoButtonActive() {
            $('#undo').prop('disabled', false);
        }

        function makeUndoButtonInactive() {
            $('#undo').prop('disabled', true);
        }

        function clearHistory() {
            history = [];
            makeUndoButtonInactive();
            makeRedoButtonInactive();
            printHistory();
        }

        // grayscale canvas

        function colorToGrayscale(color) {
            return new fabric.Color(color).toGrayscale().toRgba();
        }

        function colorCanvasIfNeeded() { // add this to saving to json later!!!
            //setTimeout(function() {
                if(colors == "colorcolor" || colors == "blackcolor") {
                    if(selectedSideID()==1)
                        grayscaleCanvas(false);
                    else
                        getUnselectedSide().json = colorJSON(getUnselectedSide().json);
                }
            //}, 500);
        }

        function grayscaleCanvasIfNeeded() {
            //setTimeout(function() {
                if (colors == "colorblack" || colors == "blackblack") {
                    if(selectedSideID() == 1)
                        grayscaleCanvas(true);
                    else
                        getUnselectedSide().json = grayscaleJSON(getUnselectedSide().json);
                }
            //}, 500);
        }

        function grayscaleCanvas(isGrayscale) {
            if(isGrayscale) { // make all objects grayscale
                canvas.forEachObject(function (object) {
                    if (object.type == "image" || object.type == "variable-image") {
                        object.filters[2] = new fabric.Image.filters.Grayscale();
                        object.applyFilters();
                    }

                    if (object.fill)
                        object.fill = colorToGrayscale(object.fill);
                    if (object.stroke)
                        object.stroke = colorToGrayscale(object.stroke);
                });

                if(canvas.backgroundImage) {
                    canvas.backgroundImage.filters[0] = new fabric.Image.filters.Grayscale();
                    canvas.backgroundImage.applyFilters(function () {
                        canvas.renderAll();
                    });
                }
            }
            else { // return color
                canvas.forEachObject(function (object) {
                    if (object.type == "image" || object.type == "variable-image") {
                        object.filters[2] = null;
                        object.applyFilters();
                    }
                });

                if(canvas.backgroundImage) {
                    canvas.backgroundImage.filters[0] = null;
                    canvas.backgroundImage.applyFilters(function () {
                        canvas.renderAll()
                    });
                }
            }

            /* // can be used later to generate previews
             grayscaleCanvas.clear();

             fabric.Image.fromURL(canvas.toDataURL('png'), function(img) {
             grayscaleCanvas.add(img);

             img.filters.push(new fabric.Image.filters.Grayscale());
             img.applyFilters(function(){
             $('#grayscaleImg').attr('src', grayscaleCanvas.toDataURL('png'));
             });
             });*/
        }

        function colorJSON(jsonData) {
            if(!jsonData) return jsonData;

            var data = JSON.parse(jsonData);

            for(var i=0; i<data.objects.length; i++) {
                if(data.objects[i].type == "image" || data.objects[i].type == "variable-image") {
                    var firstFilter = null,
                        secondFilter = null;

                    if(data.objects[i].filters.length > 0) {
                        firstFilter = data.objects[i].filters[0];
                    }

                    if(data.objects[i].filters.length > 1) {
                        secondFilter = data.objects[i].filters[1];
                    }

                    data.objects[i].filters = [firstFilter, secondFilter, null];
                }
            }

            if(data.backgroundImage && data.backgroundImage.filters)
                data.backgroundImage.filters = [null];

            return JSON.stringify(data);
        }

        function grayscaleJSON(jsonData) {
            if(!jsonData) return jsonData;

            var data = JSON.parse(jsonData);

            for(var i=0; i<data.objects.length; i++) {
                if(data.objects[i].type == "image" || data.objects[i].type == "variable-image") {
                    var firstFilter = null,
                        secondFilter = null;

                    if(data.objects[i].filters.length > 0) {
                        firstFilter = data.objects[i].filters[0];
                    }

                    if(data.objects[i].filters.length > 1) {
                        secondFilter = data.objects[i].filters[1];
                    }

                    data.objects[i].filters = [firstFilter, secondFilter, {type:"Grayscale"}];
                }

                if (data.objects[i].fill)
                    data.objects[i].fill = colorToGrayscale(data.objects[i].fill);
                if (data.objects[i].stroke)
                    data.objects[i].stroke = colorToGrayscale(data.objects[i].stroke);
            }

            if(data.backgroundImage && data.backgroundImage.filters)
                data.backgroundImage.filters = [{type:"Grayscale"}];

            return JSON.stringify(data);
        }

        // scrollable tabs
        var scrollBarWidths = 40;

        var widthOfList = function(){
            var itemsWidth = 0;
            $('.list li').each(function(){
                var itemWidth = $(this).outerWidth();
                itemsWidth+=itemWidth;
            });
            return itemsWidth;
        };

        var widthOfHidden = function(){
            return (($('.wrapper').outerWidth())-widthOfList()-getLeftPosi())-scrollBarWidths;
        };

        var getLeftPosi = function(){
            return $('.list').position().left;
        };

        var scrollerReset = function(){
            if (($('.wrapper').outerWidth()) < widthOfList()) {
                $('.scroller-right').show();
            }
            else {
                $('.scroller-right').hide();
            }

            if (getLeftPosi()<0) {
                $('.scroller-left').show();
            }
            else {
                $('.item').animate({left:"-="+getLeftPosi()+"px"},'slow');
                $('.scroller-left').hide();
            }
        };

        $(window).on('resize',function(e){
            scrollerReset();
        });

        $('.scroller-right').click(function() {

            $('.scroller-left').fadeIn('slow');
            $('.scroller-right').fadeOut('slow');

            $('.list').animate({left:"+="+widthOfHidden()+"px"},'slow',function(){

            });
        });

        $('.scroller-left').click(function() {

            $('.scroller-right').fadeIn('slow');
            $('.scroller-left').fadeOut('slow');

            $('.list').animate({left:"-="+getLeftPosi()+"px"},'slow',function(){

            });
        });

        // lock rotation to 90 deg
        function calculateClosestAngle(object) {
            var angle = object.angle;

            if(object.type=="barcode" || isTextRect(object) || isGroup(object)) {
                if (angle >= 45 && angle < 135) {
                    return 90;
                } else if (angle >= 135 && angle < 225) {
                    return 180;
                } else if (angle >= 225 && angle < 315) {
                    return 270;
                } else if ((angle >= 315 && angle <= 360) || (angle >= 0 && angle < 45)) {
                    return 0;
                }
            }
            else {
                var int = Math.floor(angle / 45);
                var lowest = int * 45;
                var highest = (int+1) * 45;
                var lowDiff = angle - lowest;
                var highDiff = highest - angle;

                if(highDiff>lowDiff) return lowest;
                else return highest;
            }
            return angle;
        }

        // tips
        function showTip(text) {
            $('#tip').text(text);
            var token = (new Date).getTime();
            $('#tip').attr('data-id', token);

            $('#tip').fadeIn(400);

            setTimeout(function(){
                if($('#tip').attr('data-id') == token)
                    $('#tip').fadeOut(400);
            }, 1000);
        }

        // warning message
        function warning(text) {
            $('#warning').text(text);
            $('#modalWarning').modal('show');
        }

        // template options
        function changeOrientation() {
            resizeCard(cardHeight, cardWidth);

            if(orientation == "landscape") {
                orientation = "portrait";
                $('#cardPortrait').addClass('active');
                $('#cardLandscape').removeClass('active');
            }
            else {
                orientation = "landscape";
                $('#cardLandscape').addClass('active');
                $('#cardPortrait').removeClass('active');
            }

            getSelectedSide().orientation = orientation;

            updateSlotPunch();

            if(templateData.cardTypeID == cardTypeIDs.magStripe) {
                magStripeRemove();
                magStripeAdd();
            }

            addOverlay();
        }

        function selectedSideID() {
            if(cardSides[0].isSelected) return 0;
            else return 1;
        }

        function unselectedSideID() {
            if(cardSides[0].isSelected) return 1;
            else return 0;
        }

        function getSelectedSide() {
            if(cardSides[0].isSelected) return cardSides[0];
            else return cardSides[1];
        }

        function getUnselectedSide() {
            if(cardSides[0].isSelected) return cardSides[1];
            else return cardSides[0];
        }

        function updateCardOptions() {
            //resizeCardBasedOnSelectVal($('#cardSize').val());

            if(orientation != getSelectedSide().orientation) {
                resizeCard(cardHeight, cardWidth);
                getSelectedSide().orientation = orientation;
            }
        }

        function templateOptionsJSON() {
            var templateOptions = [];

            templateOptions.push({
                "key":      "sides",
                "value":    sides
            },{
                "key":      "orientation",
                "value":    orientation
            },{
                "key":      "color",
                "value":    colors
            });

            if(slotPunch!="none") {
                templateOptions.push({
                    "key":      "slot_punch",
                    "value":    slotPunch
                });
            }

            if(letter!="none") {
                templateOptions.push({
                    "key":      "letter_id",
                    "value":    letter
                });
            }

            return JSON.stringify(templateOptions);
        }

        function removeUnsupportedCharacters(string) {
            if(!string) return "";

            return string.replace(/[^\w]/gi, '');
        }

        function templateFieldsJSON() {
            var templateFields = [],
                data = false;

            if(sides=="double" && getUnselectedSide().json != "") {
                data = JSON.parse(getUnselectedSide().json);
            }

            for(i=0; i<varTextFields.length; i++){
                var used = false;

                canvas.forEachObject(function (object) {
                    if (object.get('type') == "static-text" && object.variable == true && object.text == varTextFields[i].name) {
                        used = true;
                    }
                });

                if(!used && data) {
                    for (z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == 'static-text' && data.objects[z].variable == true && stripBrackets(data.objects[z].text) == varTextFields[i].name) {
                            used = true;
                        }
                    }
                }

                if(used) {
                    templateFields.push({
                        "type": "text",
                        "token": removeUnsupportedCharacters(varTextFields[i].name),
                        "label": varTextFields[i].name
                    });
                }
            }

            for(i=0; i<varImageFields.length; i++) {
                var used = false,
                    imageDimensions = {
                        "width":    0,
                        "height":   0
                    };

                canvas.forEachObject(function (object) {
                    if (object.get('type') == "variable-image" && object.name == varImageFields[i].name) {
                        used = true;
                        imageDimensions = getImageDimensionsByVarName(varImageFields[i].name);
                    }
                });

                if(!used && data) {
                    for (z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == 'variable-image' && stripBrackets(data.objects[z].src) == varImageFields[i].name) {
                            used = true;
                            imageDimensions.width = scale(data.objects[z].width, 457 / 1012);
                            imageDimensions.height = scale(data.objects[z].height, 457 / 1012);
                        }
                    }
                }

                if(used) {
                    templateFields.push({
                        "type":         "image",
                        "dimensions":   imageDimensions,
                        "token":        removeUnsupportedCharacters(varImageFields[i].name),
                        "label":        varImageFields[i].name
                    });
                }
            }

            var magData = getMagstripeCardData(),
                tracks = [magData.data[0].track1, magData.data[1].track2, magData.data[2].track3];

            for(i=0; i<3; i++) {
                if (tracks[i].substring(0, 3) == '{{{')
                    tracks[i] = stripBrackets(tracks[i]);
                else
                    tracks[i] = false;
            }

            for(i=varBarcodeFields.length-1; i>-1; i--) {
                var used = false;

                canvas.forEachObject(function(object) {
                    if(object.get('type') == "barcode" && object.text == varBarcodeFields[i].name) {
                        var type = "barcode";
                        if(object.barcodeType == "qrcode") type = "qrcode";

                        templateFields.push({
                            "type":     type,
                            "token":    removeUnsupportedCharacters(varBarcodeFields[i].name),
                            "label":    varBarcodeFields[i].name
                        });
                        used = true;
                    }
                });

                if(!used && data) {
                    for (z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == 'barcode' && data.objects[z].text == varBarcodeFields[i].name) {
                            var type = "barcode";
                            if(data.objects[z].barcodeType == "qrcode") type = "qrcode";

                            templateFields.push({
                                "type":     type,
                                "token":    removeUnsupportedCharacters(varBarcodeFields[i].name),
                                "label":    varBarcodeFields[i].name
                            });
                            used = true;
                        }
                    }
                }

                if(!used) {
                    for (z = 0; z < 3; z++) {
                        if (tracks[z] && tracks[z] == varBarcodeFields[i].name) {
                            templateFields.push({
                                "type": "track" + (z + 1),
                                "token":    removeUnsupportedCharacters(varBarcodeFields[i].name),
                                "label":    varBarcodeFields[i].name
                            })
                        }
                    }
                }
            }

            return JSON.stringify(templateFields);
        }

        function templateDataJSON(side) {
            if(side=="front") {
                if(cardSides[0].isSelected) {
                    return prepareTemplateForSaving(JSON.stringify(canvas));
                }
                else
                    return cardSides[0].json;
            }
            else {
                if(sides == "single") return "";

                if(cardSides[1].isSelected) {
                    return prepareTemplateForSaving(JSON.stringify(canvas));
                }
                else
                    return cardSides[1].json;
            }
        }

        function templateCardData() {
            return JSON.stringify(cardData);
        }

        function templateSpecialHandlings() {
            return JSON.stringify(specialHandlings);
        }

        function getImageDimensionsByVarName(name) {
            var imageDimensions = {
                "width":    0,
                "height":   0
            };

            canvas.forEachObject(function (object) {
                if (object.get('type') == "variable-image") {
                    if(object.name == name) {
                        imageDimensions.width   = object.getWidth();
                        imageDimensions.height  = object.getHeight();
                    }
                }
            });

            return imageDimensions;
        }

        function loadingCanvas(isLoading) {
            if(isLoading) {
                $('#canvasLoading').removeClass('hidden');

                var token = (new Date).getTime();
                $('#canvasLoading').attr('data-id', token);

                $('#menuTemplateNew, #menuTemplateSave, #menuTemplateSaveAs, #menuTemplateLoad, #menuListOfVariables').attr('disabled', true);

                setTimeout(function(){
                    loadingCheck(token);
                },60000);
            }
            else {
                $('#canvasLoading').addClass('hidden');
                $('#menuTemplateNew, #menuTemplateSave, #menuTemplateSaveAs, #menuTemplateLoad, #menuListOfVariables').attr('disabled', false);
            }
        }

        function loadingCheck(token) {
            if(!$('#canvasLoading').hasClass('hidden') && token == $('#canvasLoading').attr('data-id') && token != 0) {
                $('#canvasLoading').addClass('hidden');
                $('#menuTemplateNew, #menuTemplateSave, #menuTemplateSaveAs, #menuTemplateLoad, #menuListOfVariables').attr('disabled', false);
                alert('Oops! Something went wrong, please try again later.');
            }
        }

        function updateHeader() {
            if(templateData.organizationID == -1) {
                $('#headerTitle h1').text('New Template');
                return;
            }

            $.ajax({
                type: 'GET',
                url: config.apiURL+'organizations',
                success: function (data) {
                    for(i=0; i<data.length; i++) {
                        if(data[i].id == templateData.organizationID) {
                            var title = data[i].name + ' - ';

                            if(templateData.templateName == "") title += 'New Template';
                            else title += templateData.templateName;

                            $('#headerTitle h1').text(title);
                            $('#modalEditNameTitle').val(templateData.templateName);
                        }
                    }
                },
                error: function (data) {
                    alert('Can\'t connect to the api');
                }
            });
        }

        $('#headerTitle h1').on("click", function(){
            if(templateData.organizationID == -1 || templateData.templateName == "") {
                alert("You can't change the name of this template: you need to save it first!");
                return;
            }

            $('#modalEditName').modal('show');
        });

        $('#modalEditNameSave').on("click", function(){
            var newName = $('#modalEditNameTitle').val();

            if(!newName) {
                alert("Please enter a correct template name");
                return;
            }

            $('#modalEditName .modal-footer button').addClass('hidden');
            $('#modalEditName .modal-footer i').removeClass('hidden');

            $.ajax({
                type: 'PATCH',
                url: config.apiURL+'card_templates/'+templateData.templateID+'?organization_id='+templateData.organizationID,
                data: {
                    "card_template[name]":  newName
                },
                success: function () {
                    templateData.templateName = newName;
                    updateHeader();
                    $('#modalEditName .modal-footer button').removeClass('hidden');
                    $('#modalEditName .modal-footer i').addClass('hidden');
                    $('#modalEditName').modal('hide');
                },
                error: function (data) {
                    $('#modalEditName .modal-footer button').removeClass('hidden');
                    $('#modalEditName .modal-footer i').addClass('hidden');
                    alert(JSON.stringify(data));
                }
            });
        });

        function addOverlayRect(x, y, width, height, cardOrientation) {
            var rect = new fabric.Rect({
                left: x,
                top: y,
                width: width,
                height: height,
                fill: 'rgba(0,0,0,0.2)',
                selectable: false,
                evented: false,
                name: "embedded_top",
                cardType: cardOrientation
            });
            canvas.add(rect);
        }

        function checkOverlay(delay) {
            delay = delay || 1;

            setTimeout(function(){
                addOverlay();
            }, delay);
        }

        function addOverlay() {
            var alreadyDrawn = false,
                wrongOrientation = false,
                counter = 0;

            canvas.forEachObject(function(object){
                if(object.name=="embedded_top" && object.cardType) {
                    //alreadyDrawn = true;
                    counter++;

                    if(object.cardType != orientation)
                        wrongOrientation = true;
                }
            });

            if(counter>=4) alreadyDrawn = true;

            if(wrongOrientation || !alreadyDrawn) removeOverlay();

            if(alreadyDrawn && !wrongOrientation) return;

            var canvasWidth = canvas.getWidth(),
                canvasHeight = canvas.getHeight();

            addOverlayRect(0, 0, canvasWidth, (canvasHeight-cardHeight)/2, orientation); // top
            addOverlayRect(0, (canvasHeight-cardHeight)/2 + cardHeight, canvasWidth, (canvasHeight-cardHeight)/2, orientation); // bottom
            addOverlayRect(0, (canvasHeight-cardHeight)/2, (canvasWidth-cardWidth)/2, cardHeight, orientation); // left
            addOverlayRect((canvasWidth-cardWidth)/2 + cardWidth, (canvasHeight-cardHeight)/2, (canvasWidth-cardWidth)/2, cardHeight, orientation); // right
        }

        function removeOverlay() {
            canvas.forEachObject(function(object){
                if(object.name=="embedded_top" && object.cardType) {
                    object.remove();
                }
            });

            canvas.renderAll();
        }

        function makeAllObjectsUnevented() {
            canvas.forEachObject(function(object){
                object.evented = false;
                object.selectable = false;
            });
        }

        function makeAllObjectsEvented() {
            canvas.forEachObject(function(object){
                if(!(object.name && (object.name == "embedded_top" || object.name == "embedded_bottom" || object.name == "slotPunch" || object.name == "magStripe")) && !(object.type=="static-text")) {
                    object.evented = true;
                    object.selectable = true;
                }
            });
        }

        function moveObjectOnArrowKeyPress(keycode) {
            var object = canvas.getActiveObject();

            if(canvas.getActiveGroup()) object = canvas.getActiveGroup();

            if(!object)
                return;

            var top = 0,
                left = 0,
                distance = 3; //px

            switch(keycode) {
                case 37: // left
                        left = -distance;
                    break;
                case 38: // up
                        top = -distance;
                    break;
                case 39: // right
                        left = distance;
                    break;
                case 40: // down
                        top = distance;
                    break;
                default:
                    break;
            }

            object.top += top;
            object.left += left;

            if(isTextRect(object)) {
                recalcTextPosition(object.textID);
                resizeObject(getTextByTextID(object.textID));
            }

            fixObjectBorder(object);
            object.setCoords();
            canvas.renderAll();
            updatePositionValues(object);
        }

        function getParamFromArray(param, arr) {
            var value;

            for(var i=0; i<arr.length; i++) {
                if(arr[i].hasOwnProperty(param))
                    return arr[i][param];
            }
        }

        // event functions
        var selectedTextObject, lastClickTime;

        function onObjectSelected() {
            if(toolSelected=="textColorPicker") { // keep text object selected for the colorpicker
                if(selectedTextObject && canvas.getActiveObject()!=selectedTextObject) {
                    canvas.setActiveObject(selectedTextObject);
                }
                return;
            }

            if(lockedGroup) {
                if(lockedGroup == canvas.getActiveGroup()) return;

                canvas.setActiveGroup(lockedGroup);
                return;
            }
            else if((lockedObject && !lockedObjectSelected) || (lockedObject && lockedObjectSelected && lockedObject != canvas.getActiveObject())) { //TODO: CHANGE TO EVENTED=FALSE
                lockedObjectSelected = true;
                canvas.setActiveObject(lockedObject);
                return;
            }
            else if (lockedObject && lockedObjectSelected) {
                return;
            }

            hideToolTabs();

            $('#remove').prop("disabled", false);
            $('#copy').prop("disabled", false);
            $('#cut').prop("disabled", false);

            $('#objectCenter').prop("disabled", false);
            $('.btn-layer').removeClass('active');
            var group = canvas.getActiveGroup();

            if(group) { // if more than 1 selected object
                makeTabActive('tab-align');
                group.hasBorders = false;

                group.forEachObject(function(object){
                    object.hasBorders = false;

                    if(isTextRect(object)) {
                        var textObj = getTextByTextID(object.textID);
                        textObj.hasBorders = false;
                        group.addWithUpdate(textObj);
                    }

                    // make layers bold

                    $('#layer'+getObjectID(object)).addClass('active');
                });

                return;
            }


            var object = canvas.getActiveObject();
            var type = object.get('type');
            object.hasBorders = true;
            fixObjectBorder(object);
            object.setCoords();

            // make layer bold
            $('#layer'+getObjectID(object)).addClass('active');

            updatePositionValues(object);

            textButtonsClearState();

            if(isTextRect(object) && !getTextByTextID(object.textID).variable) {
                var textObject = getTextByTextID(object.textID);

                makeTabActive('tab-text');

                $('#editTextSize').val(textObject.getFontSize());
                $('#editTextText').val(textObject.getText());
                $('#editTextAutoResize').prop('checked', textObject.autoResize);
                $('#editTextNoClip').prop('checked', textObject.noClip);
                textFontDropdownSet(textObject.getFontFamily());

                $('.editTextColor').colorpicker('setValue', textObject.getFill());

                if(textObject.getFontWeight()=="bold") $("#editTextBold").addClass("active");
                if(textObject.getFontStyle()=="italic") $("#editTextItalic").addClass("active");
                if(textObject.getTextDecoration()=="underline") $("#editTextUnderline").addClass("active");

                $('#editTextAlignLeft, #editTextAlignCenter, #editTextAlignRight').removeClass("active");
                if(textObject.align == "left") $('#editTextAlignLeft').addClass("active");
                else if(textObject.align == "center") $('#editTextAlignCenter').addClass("active");
                else if(textObject.align == "right") $('#editTextAlignRight').addClass("active");
            }
            else if(isTextRect(object) && getTextByTextID(object.textID).variable) {
                var textObject = getTextByTextID(object.textID);

                makeTabActive('tab-varText');

                selectVarTextByName(textObject.text);

                $('#editVarTextSize').val(textObject.fontSizeOriginal);
                $('#editVarTextAutoResize').prop('checked', textObject.autoResize);
                $('#editVarTextNoClip').prop('checked', textObject.noClip);
                textFontDropdownSet(textObject.getFontFamily());

                $('.editVarTextColor').colorpicker('setValue', textObject.getFill());

                if(textObject.getFontWeight()=="bold") $("#editVarTextBold").addClass("active");
                if(textObject.getFontStyle()=="italic") $("#editVarTextItalic").addClass("active");
                if(textObject.getTextDecoration()=="underline") $("#editVarTextUnderline").addClass("active");

                $('#editVarTextAlignLeft, #editVarTextAlignCenter, #editVarTextAlignRight').removeClass("active");
                if(textObject.align == "left") $('#editVarTextAlignLeft').addClass("active");
                else if(textObject.align == "center") $('#editVarTextAlignCenter').addClass("active");
                else if(textObject.align == "right") $('#editVarTextAlignRight').addClass("active");
            }
            else if(type=="barcode") {
                if(object.barcodeType=="qrcode") {
                    makeTabActive('tab-qrcode');
                }
                else {
                    makeTabActive('tab-barcode');
                }

                if(object.barcodeType=="qrcode") {
                    if(object.textType=='fixed') {
                        $('#editQrcodeText').val(object.text);
                        qrcodeShowFixed();
                    }
                    else {
                        updateVarBarcodeList(object.barcodeType);
                        qrcodeShowVariable();
                        selectVarQrcodeByName(object.text);
                    }

                    if(object.getStroke()) {
                        $('#editQrcodeBorder').prop('checked', true);
                        $('#editQrcodeBorderWidth').val(object.getStrokeWidth());
                        $('.editQrcodeBorderColor').colorpicker('setValue', object.getStroke());
                    }
                    else {
                        $('#editQrcodeBorder').prop('checked', false);
                        $('#editQrcodeBorderWidth').val(1);
                    }
                }
                else {
                    $('#editBarcodeType').val(object.barcodeType);
                    updateBarcodeFixedTextTooltip(object.barcodeType);

                    if(object.textType=='fixed') {
                        $('#editBarcodeText').val(object.text);
                        barcodeShowFixed();
                    }
                    else {
                        updateVarBarcodeList(object.barcodeType);
                        barcodeShowVariable();
                        selectVarBarcodeByName(object.text);
                    }

                    if(object.getStroke()) {
                        $('#editBarcodeBorder').prop('checked', true);
                        $('#editBarcodeBorderWidth').val(object.getStrokeWidth());
                        $('.editBarcodeBorderColor').colorpicker('setValue', object.getStroke());
                    }
                    else {
                        $('#editBarcodeBorder').prop('checked', false);
                        $('#editBarcodeBorderWidth').val(1);
                    }

                    var barWidth = 5, quietZone = 10;

                    if(object.hasOwnProperty('barWidth')) barWidth = object.barWidth;
                    if(object.hasOwnProperty('quietZone')) quietZone = object.quietZone;

                    $('#editBarcodeBarWidth').val(barWidth);
                    $('#editBarcodeQuietZone').val(quietZone);
                }
            }
            else if (type=="rect" || type=="ellipse" || type=="triangle" || type=="line") {
                makeTabActive('tab-shape');

                $('#editShapeRectangle, #editShapeEllipse, #editShapeTriangle, #editShapeLine').removeClass("active");

                if(type=="line") {
                    $("#editShapeLine").addClass("active");
                    $('.editShapeColor').colorpicker('setValue', object.getStroke());
                    $('#editShapeLineWidth').parent().parent().removeClass('hidden');
                    $('#editShapeCorners').addClass('hidden');
                    $('#editShapeBorderWidth').parents().eq(4).addClass('hidden');
                    $('#editShapeLineWidth').val(object.getStrokeWidth());
                    $('#editShapeTransparency').val(object.getOpacity() * 100);
                    return;
                }

                $('#editShapeLineWidth').parent().parent().addClass('hidden');
                $('#editShapeCorners').removeClass('hidden');
                $('#editShapeBorderWidth').parents().eq(4).removeClass('hidden');


                $('#editShapeTransparency').val((new fabric.Color(object.getFill()).getAlpha())*100);
                $('.editShapeColor').colorpicker('setValue', object.getFill());

                if(type=="rect") {
                    $('#editShapeCorners').removeClass('hidden');
                    $('#editShapeCornersValue').val(object.rx);
                }
                else $('#editShapeCorners').addClass('hidden');

                if(object.getStroke()) {
                    $('#editShapeBorder').prop('checked', true);
                    $('#editShapeBorderWidth').val(object.getStrokeWidth());
                    $('.editShapeBorderColor').colorpicker('setValue', object.getStroke());
                }
                else {
                    $('#editShapeBorder').prop('checked', false);
                    $('#editShapeBorderWidth').val(1);
                }

                if(type=="rect") $("#editShapeRectangle").addClass("active");
                else if(type=="ellipse") $("#editShapeEllipse").addClass("active");
                else if(type=="triangle") $("#editShapeTriangle").addClass("active");
            }
            else if (type=="image") {
                makeTabActive('tab-image');

                if(object.strokeShow) {
                    $('#editImageBorder').prop('checked', true);
                    $('#editImageBorderWidth').val(object.strokeWidthNew);
                    $('.editImageBorderColor').colorpicker('setValue', object.getStroke());
                }
                else {
                    $('#editImageBorder').prop('checked', false);
                    $('#editImageBorderWidth').val(object.strokeWidthNew||1);
                }

                $('#editImageCornerRadius').val(object.cornerRadius);

                $('#editImageTransparency').val(object.getOpacity() * 100);

                if(object.filters[0]) $('#editImageGrayscale').prop('checked', true);
                else $('#editImageGrayscale').prop('checked', false);

                if(object.filters[1]) {
                    $('#editImageRemoveWhite').prop('checked', true);
                    $('#editImageRemoveWhiteThreshold').val(object.filters[1].threshold);

                    var color = object.filters[1].color;
                        color = 'rgb('+color[0]+','+color[1]+','+color[2]+')';

                    $('.editImageRemoveWhiteColor').colorpicker('setValue', color);
                }
                else {
                    $('#editImageRemoveWhite').prop('checked', false);
                    $('#editImageRemoveWhiteThreshold').val(60);
                    $('.editImageRemoveWhiteColor').colorpicker('setValue', 'rgb(255,255,255)');
                }
            }
            else if (type=="variable-image") {
                makeTabActive('tab-varImage');

                if(object.strokeShow) {
                    $('#editVarImageBorder').prop('checked', true);
                    $('#editVarImageBorderWidth').val(object.strokeWidthNew);
                    $('.editVarImageBorderColor').colorpicker('setValue', object.getStroke());
                }
                else {
                    $('#editVarImageBorder').prop('checked', false);
                    $('#editVarImageBorderWidth').val(object.strokeWidthNew||1);
                }

                $('#editVarImageCornerRadius').val(object.cornerRadius);

                selectVarImageByName(object.name);

                $('#editVarImageTransparency').val(object.getOpacity() * 100);

                if(object.filters[0]) $('#editVarImageGrayscale').prop('checked', true);
                else $('#editVarImageGrayscale').prop('checked', false);

                if(object.filters[1]) {
                    $('#editVarImageRemoveWhite').prop('checked', true);
                    $('#editVarImageRemoveWhiteThreshold').val(object.filters[1].threshold);

                    var color = object.filters[1].color;
                    color = 'rgb('+color[0]+','+color[1]+','+color[2]+')';

                    $('.editVarImageRemoveWhiteColor').colorpicker('setValue', color);
                }
                else {
                    $('#editVarImageRemoveWhite').prop('checked', false);
                    $('#editVarImageRemoveWhiteThreshold').val(60);
                    $('.editVarImageRemoveWhiteColor').colorpicker('setValue', 'rgb(255,255,255)');
                }
            }
        }

        function onSelectionCleared() {
            if(toolSelected=="textColorPicker" && selectedTextObject) { // keep text object selected for the colorpicker
                canvas.setActiveObject(selectedTextObject);
                return;
            }


            if(lockedGroup) {
                var objects = [];
                lockedGroup.forEachObject(function(obj) {
                    objects.push(obj);
                });

                var group = new fabric.Group(objects, {
                    canvas: canvas
                });
                group.addWithUpdate();
                canvas.setActiveGroup(group);
                group.saveCoords();
                canvas.fire('selection:created', { target: group });

                return;
            }
            else if(lockedObject) {
                lockedObjectSelected = false;
                canvas.setActiveObject(lockedObject);
                return;
            }

            $('.btn-layer').removeClass('active');
            $('#remove').prop("disabled", true);
            $('#copy').prop("disabled", true);
            $('#cut').prop("disabled", true);
            $('#objectCenter').prop("disabled", true);

            updatePositionValues();

            selectTool("toolDefault");
            textButtonsClearState();
            hideToolTabs();

            canvas.forEachObject(function(object){
                if(isText(object)) updateTextObject(object);
            });
        }

        function onSelectionCreated(options) {
            var group = options.target;

            if(isGroup(group)) {
                if(group.pasted) {
                    group.forEachObject(function(object){
                        if(isText(object)) updateTextObject(object);
                    });

                    return;
                }

                group.forEachObject(function(object){
                    object.hasBorders = false;

                    if(isTextRect(object)) {
                        var foundText = false;

                        group.forEachObject(function(object2){
                            if(isText(object2) && object2.textID == object.textID) {
                                foundText = true;
                            }
                        });

                        if(!foundText) {
                            var textObj = getTextByTextID(object.textID);
                            textObj.hasBorders = false;
                            group.addWithUpdate(textObj);
                        }
                    }
                });
            }
        }

        function onBeforeSelectionCleared() {

        }

        function onTextChanged() {
            var object = canvas.getActiveObject();
            $('#editTextText').val(object.getText());
            resizeObject(object);
            //updateAlign(object);
            updateLayerList();
        }

        //var rect, origX, origY;
        var rect, lastMouseDownCoords;

        function onMouseDown(options) {
            /*
            // Check if double click
            var date = new Date();
            var now = date.getTime();
            if(now - lastClickTime < 500){
                onDoubleClick(options);
            }
            lastClickTime = now;*/

            colorCanvasIfNeeded();
            grayscaleCanvasIfNeeded();

            lastMouseDownCoords = canvas.getPointer(options.e);
        }

        function onMouseUp(options) {
            var pointer = canvas.getPointer(options.e),
                posX1 = lastMouseDownCoords.x - 0.5,
                posY1 = lastMouseDownCoords.y,
                posX2 = pointer.x - 0.5,
                posY2 = pointer.y,
                posX, posY, width, height;

            if(posX1 > posX2) {
                posX = posX2;
                width = posX1 - posX2;
            }
            else {
                posX = posX1;
                width = posX2 - posX1;
            }

            if(posY1 > posY2) {
                posY = posY2;
                height = posY1 - posY2;
            }
            else {
                posY = posY1;
                height = posY2 - posY1;
            }

            if(width == 0) width = 150;
            if(height == 0) height = 100;

            if(toolSelected=="toolText") {
                createTextRect({left: posX, top: posY, width: width, height: height});
                var rect = newestObject();

                createNewTextObject(posX, posY);
                var text = newestObject();

                attachTextToRect(text, rect);
                updateTextObject(text);

                canvas.setActiveObject(rect);
                selectDefaultTool();
                addSnapshotToHistory();
            }
            else if(toolSelected=="toolVarText") {
                createTextRect({left: posX, top: posY, width: width, height: height});
                var rect = newestObject();

                createNewTextObject(posX, posY, true);
                var text = newestObject();

                attachTextToRect(text, rect);
                updateTextObject(text);

                canvas.setActiveObject(rect);
                selectDefaultTool();
                addSnapshotToHistory();
            }
            else if(toolSelected=="toolVarImage") {
                createNewVarImageObject(posX, posY, width, height);

                selectNewestObject();
                selectDefaultTool();
                addSnapshotToHistory();
            }
            else if(toolSelected=="toolBarcode") {
                createNewBarcode({posX: posX, posY: posY, width: width, height: height});

                selectNewestObject();
                selectDefaultTool();
                addSnapshotToHistory();
            }
            else if(toolSelected=="toolQrcode") {
                if(width<height) height = width;
                else width = height;
                createNewBarcode({posX: posX, posY: posY, width: width, height: height, type: 'qrcode'});

                selectNewestObject();
                selectDefaultTool();
                addSnapshotToHistory();
            }
            else if (toolSelected=="textColorPicker") {
                var canvasElement = document.getElementById('c');
                var ctx = canvasElement.getContext("2d");
                var px = ctx.getImageData(posX, posY, 1, 1).data;
                if(selectedTextObject) {
                    $('.fa-eyedropper').each(function(){
                        if($(this).parent().hasClass('active')) {
                            var className = $(this).parent().attr('id').replace("Picker", "");

                            $('.'+className).colorpicker('setValue', 'rgb(' + px[0] + ',' + px[1] + ',' + px[2] + ')');
                        }
                    });
                }
                else
                    $('.frontSideBG').colorpicker('setValue', 'rgb(' + px[0] + ',' + px[1] + ',' + px[2] + ')');

                selectDefaultTool();
            }
            else if (toolSelected=="toolDrawObject") {
                rect = new fabric.Rect({
                    left: posX,
                    top: posY,
                    originX: 'left',
                    originY: 'top',
                    width: width,
                    height: height,
                    angle: 0,
                    fill: 'rgba(55,55,0,1)'
                });

                canvas.add(rect);

                selectNewestObject();
                selectDefaultTool();
                addSnapshotToHistory();
            }

            var object = canvas.getActiveObject();
            if(!object) return;

            var type = object.get('type');

            if(type=="image" || type == "variable-image")
                resizeVariableImage(object);
        }

        function onMouseMove() {

        }

        function onDoubleClick(options) {
            /*
            if(options.target.type == "rect" && options.target.name == "textRect") {
                getTextByTextID(options.target.textID).enterEditing();
            }*/
        }

        function onObjectAdded(options) {
            if(options.target.type == "static-text") {
                recalcTextPosition(options.target.textID);
            }

            moveAdditionalLayersToTheTop();

            updateLayerList();

            colorCanvasIfNeeded();
            grayscaleCanvasIfNeeded();
            updateObjectsTable();
        }

        function onObjectRemoved(options) {
            if(options.target.name == "textRect") {
                var textObject = getTextByTextID(options.target.textID);

                if(textObject.variable)
                    templateFieldsChangeVariable("text", textObject.text, false);

                canvas.remove(textObject);
            }

            if(options.target.type=="variable-image") {
                templateFieldsChangeVariable("image", options.target.name, false);
                fixImageFieldsDimensions();
            }
            else if(options.target.type=="barcode" && options.target.barcodeType=="qrcode")
                templateFieldsChangeVariable("qrcode", options.target.text, false);
            else if(options.target.type=="barcode")
                templateFieldsChangeVariable("barcode", options.target.text, false);

            unlockSelection();
            updateLayerList();

            cardDataUpdate();
            updateObjectsTable();
        }

        function onObjectMoving(options) {
            if((gridSnapTo && !ctrlPressed) || (!gridSnapTo && ctrlPressed)) {
                options.target.set({
                    left: Math.round(options.target.left / gridSize) * gridSize + (leftPadding%gridSize),
                    top: Math.round(options.target.top / gridSize) * gridSize + (topPadding%gridSize)
                });
            }

            if(canvas.getActiveGroup()) return;

            var object = canvas.getActiveObject();
            var type = object.get('type');

            updatePositionValues(object);

            if(type == "image" || type == "variable-image" || (type=="barcode" && object.barcodeType=="qrcode")) {
                var tp = Math.round(object.getTop())-topPadding,
                    lft = Math.round(object.getLeft())-leftPadding;

                if(metric=="in") {
                    tp = px2in(tp);
                    lft = px2in(lft);
                }
                else if(metric=="mm") {
                    tp = px2mm(tp);
                    lft = px2mm(lft);
                }

                $('#editImageTop, #editVarImageTop, #editQrcodeTop').val(tp);
                $('#editImageLeft, #editVarImageLeft, #editQrcodeLeft').val(lft);
            }

            if(isTextRect(object)) {
                recalcTextPosition(object.textID);
            }

            if(gridSnapTo)
                showTip('Hold ctrl to move without snapping');
            else
                showTip('Hold ctrl to snap to the grid');
        }

        function fixImageFieldsDimensions() {
            for(i=0; i<templateData.template_fields.length; i++) {
                if(templateData.template_fields[i].type!="image") continue;

                var token = templateData.template_fields[i].token;

                var dimensions = {};

                canvas.forEachObject(function(object){
                    if(object.type=="variable-image" && ((object.name && removeUnsupportedCharacters(object.name)==token) || (object.fieldName && removeUnsupportedCharacters(object.fieldName)==token))) {
                        if(!dimensions.width || dimensions.width < object.width || dimensions.height < object.height) {
                            dimensions.width = object.width;
                            dimensions.height = object.height;
                        }
                    }
                });

                if(sides=="double" && getUnselectedSide().json != "") {
                    var data = JSON.parse(getUnselectedSide().json);

                    for (var z = 0; z < data.objects.length; z++) {
                        if (data.objects[z].type == "variable-image" && stripBrackets(data.objects[z].src)==token) {
                            if(!dimensions.width || dimensions.width < scale(data.objects[z].width, 457 / 1012) || dimensions.height < scale(data.objects[z].height, 457 / 1012)) {
                                dimensions.width = scale(data.objects[z].width, 457 / 1012);
                                dimensions.height = scale(data.objects[z].height, 457 / 1012);
                            }
                        }
                    }
                }

                templateData.template_fields[i].dimensions = dimensions;
            }
        }

        function onObjectScaling(options) {
            if(canvas.getActiveGroup()) {
                var thisGroup = canvas.getActiveGroup();

                if(thisGroup.pasted) return;

                /*
                thisGroup.forEachObject(function(obj) {
                    if(isTextRect(obj)) {

                        var text = getTextByTextID(obj.textID);
                        text.set({
                            left: thisGroup.left + (thisGroup.width/2 + obj.left)*thisGroup.scaleX,
                            top: thisGroup.top + (thisGroup.height/2 + obj.top)*thisGroup.scaleY,
                            width: obj.width*thisGroup.scaleX,
                            height: obj.height*thisGroup.scaleY,
                            clipLeft: -(obj.width*thisGroup.scaleX) / 2,
                            clipTop: -(obj.height*thisGroup.scaleY) / 2,
                            clipWidth: obj.width*thisGroup.scaleX,
                            clipHeight: obj.height*thisGroup.scaleY
                        });

                        resizeObject(text);
                        canvas.renderAll();
                    }
                });*/

                return;
            }

            fixImageFieldsDimensions();

            var object = options.target;
            var type = object.get('type');

            updatePositionValues(object);

            if(type == "image" || type == "variable-image" || (type=="barcode" && object.barcodeType=="qrcode")) {
                var wdth = Math.round(object.getWidth()),
                    hght = Math.round(object.getHeight()),
                    tp = Math.round(object.getTop())-topPadding,
                    lft = Math.round(object.getLeft())-leftPadding;

                if(metric=="in") {
                    wdth = px2in(wdth);
                    hght = px2in(hght);
                    tp   = px2in(tp);
                    lft  = px2in(lft);
                }
                else if(metric=="mm") {
                    wdth = px2mm(wdth);
                    hght = px2mm(hght);
                    tp   = px2mm(tp);
                    lft  = px2mm(lft);
                }

                $('#editImageWidth, #editVarImageWidth, #editQrcodeWidth').val(wdth);
                $('#editImageHeight, #editVarImageHeight, #editQrcodeHeight').val(hght);
                $('#editImageTop, #editVarImageTop, #editQrcodeTop').val(tp);
                $('#editImageLeft, #editVarImageLeft, #editQrcodeLeft').val(lft);
            }
            else if(isTextRect(object)) {
                recalcTextPosition(object.textID);
                resizeObject(getTextByTextID(object.textID));
            }

            fixObjectBorder(object);
        }

        function onObjectRotating(options) {
            var object = options.target;

            if(isTextRect(object)) {
                if(!ctrlPressed)
                    object.setAngle(calculateClosestAngle(object));

                recalcTextPosition(object.textID);
            }
            else if(((object.type == "barcode" || object.type == "line") && !ctrlPressed) || (!(object.type == "barcode" || object.type == "line") && ctrlPressed && !isGroup(object))) {
                object.setAngle(calculateClosestAngle(object));
                object.setCoords();
                canvas.renderAll();
            }

            if(object.type == "barcode" || object.type == "line" || isTextRect(object) || isGroup(object))
                showTip('Hold ctrl to rotate without snapping');
            else
                showTip('Hold ctrl to snap rotation to 45 deg');

            var group = canvas.getActiveGroup();
            if(group) {
                if(!ctrlPressed)
                    group.setAngle(calculateClosestAngle(group));
            }
        }

        function onObjectModified(options) {
            addSnapshotToHistory();

            colorCanvasIfNeeded();
            grayscaleCanvasIfNeeded();

            if(isTextRect(options.target)) {
                recalcTextPosition(options.target.textID);
            }

            updatePositionValues(options.target);
        }

        function onLaunch() {
            if(gridDraw) {
                drawGrid(gridSize);
            }

            scrollerReset();
            updateFilters();

            loadCanvasFromJSON(getSelectedSide().json, true);

            if(typeof to_load !== 'undefined' && to_load.org_id && to_load.card_template_id) {
                loadCardTemplate(to_load.org_id, to_load.card_template_id);
            }
            else {
                loadFonts(templateData.organizationID);
                loadLetters(templateData.organizationID);
                loadSpecialHandlings(templateData.organizationID);

                addDefaultVariableFields();

                updateVarTextList();
                updateVarImageList();
                updateCardTypes();
                updateHeader();
                updateFilters();
                //templateOptionsDefault();

                setTimeout(function(){
                    addSnapshotToHistory();
                    addOverlay();
                    updateObjectsTable();
                }, 510);
            }
        }

        // events
        canvas.on('mouse:down', function(options){
            onMouseDown(options);
        });
        canvas.on('mouse:move', onMouseMove);
        canvas.on('mouse:up', function(options){
            onMouseUp(options);
        });

        canvas.on('object:selected', onObjectSelected);
        canvas.on('object:added', function(options){
            onObjectAdded(options);
        });
        canvas.on('object:removed', function(options){
            onObjectRemoved(options);
        });
        canvas.on('object:moving', function (options) {
            onObjectMoving(options);
        });
        canvas.on('object:scaling', function (options) {
            onObjectScaling(options);
        });
        canvas.on('object:rotating', function(options){
            onObjectRotating(options);
        });
        canvas.on('object:modified', function (options) {
            onObjectModified(options);
        });

        canvas.on('before:selection:cleared', onBeforeSelectionCleared);
        canvas.on('selection:cleared', onSelectionCleared);
        canvas.on('selection:created', function (options) {
            onSelectionCreated(options);
        });

        canvas.on('text:changed', onTextChanged);

        onLaunch();
    });
</script>
