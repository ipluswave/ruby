<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">

    <link rel="stylesheet" href="css/bootstrap-yeti.min.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/fabric.js"></script>

    <script>
        var messages = {
            status: "waiting",
            messages: []
        };

        function addMessage(text, status) {
            console.log(status + ": " + text);

            messages.messages.push({
                message: text,
                status: status
            });

            $('#messages').text(JSON.stringify(messages));
        }

        function changeStatus(status) {
            messages.status = status;

            $('#messages').text(JSON.stringify(messages));
            //console.log(status);
            if(status=="success") {
                $("#imageReady").html("isReady");
            }
            else if(status=="error") {
                $('#loading').addClass('hidden');
                $("#imageReady").html("isReady");
            }
            else if(status=="migrating") {
                $("#imageReady").html("");
            }
        }
    </script>

    <script src="js/converter.js"></script>

    <style>
        textarea {
            width:100%;
        }

        #templateData, #templateDataImages {
            height: 320px;
            background-color: #ccc;
        }

        .previewFront, .previewBack {
            border: 1px solid #ccc;
            max-width: 500px;
            max-height: 500px;
        }
    </style>

    <title></title>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-xs-6">
            <div class="row">
                <div class="col-xs-12">
                    <h4>CARD_REF_NUM</h4>
                    <input type="text" id="card_ref_num" value="">
                    <button class="btn-primary" id="convert">Convert</button>
                    <h5 id="loading" class="hidden">LOADING</h5>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12">
                    <img class="previewFront" src="">
                    <img class="previewBack" src="">
                </div>
            </div>
        </div>

        <div class="col-xs-6">
            <div class="row">
                <div class="col-xs-12">
                    <h4>templateData.template</h4>
                    <textarea id="templateData"></textarea>
                    <h4>templateData.images</h4>
                    <textarea id="templateDataImages"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="messages" class="hidden"></div>

<script>
    var showPreviews = true,
        upload = false,
        create_new = false,
        slot_punch = false,
        color_color = false,
        mag_stripe = false;

    $( document ).ready(function() {
        function getUrlParameter(sParam)
        {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++)
            {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam)
                {
                    return sParameterName[1];
                }
            }
        }

        if(getUrlParameter("show_previews")) {
            if(getUrlParameter("show_previews")=="true")
                showPreviews = true;
            else
                showPreviews = false;
        }
        if(getUrlParameter("upload")) {
            if(getUrlParameter("upload")=="true")
                upload = true;
            else
                upload = false;
        }
        if(getUrlParameter("create_new")) {
            if(getUrlParameter("create_new")=="true")
                create_new = true;
            else
                create_new = false;
        }
        if(getUrlParameter("slot_punch")) {
            if(getUrlParameter("slot_punch")=="true")
                slot_punch = true;
            else
                slot_punch = false;
        }
        if(getUrlParameter("color_color")) {
            if(getUrlParameter("color_color")=="true")
                color_color = true;
            else
                color_color = false;
        }
        if(getUrlParameter("mag_stripe")) {
            if(getUrlParameter("mag_stripe")=="true")
                mag_stripe = true;
            else
                mag_stripe = false;
        }
        if(getUrlParameter("card_ref_num")) {
            _convert(parseInt(getUrlParameter("card_ref_num")));
        }


        $('#convert').on('click', function() {
            _convert(parseInt($('#card_ref_num').val()));
        });

        function uploadTemplate(templateData) {
            // upload template
            // upload images
            // update template with new image names

            $.ajax({
                type: 'POST',
                url: config.apiURL+'card_templates?organization_id='+templateData.template.organization_id,
                data: {
                    "card_template[card_type_id]":      templateData.template.card_type_id,
                    "card_template[name]":              templateData.template.name,
                    "card_template[front_data]":        JSON.stringify(templateData.template.front_data),
                    "card_template[back_data]":         JSON.stringify(templateData.template.back_data),
                    "card_template[options]":           JSON.stringify(templateData.template.options),
                    "card_template[template_fields]":   JSON.stringify(templateData.template.template_fields),
                    "card_template[card_data]":         JSON.stringify(templateData.template.card_data),
                    "card_template[special_handlings]": JSON.stringify(templateData.template.special_handlings)
                },
                success: function (data) {
                    var templateId = data.id;

                    var imagesToUpdate = [];
                    var uploadedImages = 0;

                    // upload images
                    for(var i=0; i<templateData.images.length; i++) {
                        var imgBlob = base64toBlob('data:image/jpeg;base64,'+templateData.images[i].base64);
                        var imgFile = blobToFile(imgBlob, templateData.images[i].src);

                        var fd = new FormData();
                        fd.append('card_template[images][]', imgFile, templateData.images[i].src);

                        $.ajax({
                            type: 'POST',
                            url: config.apiURL+'card_templates/'+templateId+'/upload?organization_id='+templateData.template.organization_id,
                            async: false,
                            data: fd,
                            contentType: false,
                            processData: false,
                            cache: false,
                            success: function (data) {
                                uploadedImages++;

                                var imgSuccess = false;
                                for(y=0; y<data.images.length; y++) {
                                    var filename = data.images[y].url,
                                            substr = "/",
                                            path = filename.split(substr);

                                    filename = path[path.length-1];

                                    if(filename == unsupportedCharactersToUnderscore(templateData.images[i].src)) {
                                        imagesToUpdate.push({
                                            name: templateData.images[i].src,
                                            src: data.images[y].url
                                        });

                                        imgSuccess = true;

                                        break;
                                    }
                                }

                                if(!imgSuccess) {
                                    addMessage("Couldn't upload the image ("+templateData.images[i].src+")", "error");
                                    changeStatus("error");
                                    console.log(templateData);
                                    console.log(data);
                                }

                                if(uploadedImages == templateData.images.length) {
                                    for(z=0; z<imagesToUpdate.length; z++) {
                                        var nameRegExp = new RegExp(imagesToUpdate[z].name, 'g');
                                        templateData.template.front_data = JSON.parse(JSON.stringify(templateData.template.front_data).replace(nameRegExp, imagesToUpdate[z].src));
                                        templateData.template.back_data = JSON.parse(JSON.stringify(templateData.template.back_data).replace(nameRegExp, imagesToUpdate[z].src));
                                    }

                                    updateTemplate(data.id, data.organization_id, templateData, false, false);
                                }
                            },
                            error: function (response) {
                                addMessage("Couldn't upload the image ("+templateData.images[i].src+")", "error");
                                changeStatus("error");
                                console.log('error: '+JSON.stringify(response));
                            }
                        });
                    }
                },
                error: function (response) {
                    addMessage("Couldn't upload the template", "error");
                    changeStatus("error");
                    console.log(JSON.stringify(response));
                }
            });
        }

        function updateTemplate(id, organization_id, templateData, uploadImages) {
            if(!uploadImages) {
                $.ajax({
                    type: 'PATCH',
                    url: config.apiURL+'card_templates/'+id+'?organization_id='+organization_id,
                    data: {
                        //"card_template[card_type_id]":      templateData.template.card_type_id,
                        "card_template[name]":              templateData.template.name,
                        "card_template[front_data]":        JSON.stringify(templateData.template.front_data),
                        "card_template[back_data]":         JSON.stringify(templateData.template.back_data),
                        "card_template[options]":           JSON.stringify(templateData.template.options),
                        "card_template[template_fields]":   JSON.stringify(templateData.template.template_fields),
                        "card_template[card_data]":         JSON.stringify(templateData.template.card_data)//,
                        //"card_template[special_handlings]": JSON.stringify(templateData.template.special_handlings)
                    },
                    success: function () {
                        addMessage("The migration has been completed successfully", "ok");
                        changeStatus("success");
                    },
                    error: function (data) {
                        addMessage("Couldn't upload the template (#1)", "error");
                        changeStatus("error");
                        console.log(JSON.stringify(data));
                    }
                });

                return;
            }

            if(uploadImages && templateData.images.length == 0) {
                updateTemplate(id, organization_id, templateData, false);

                return;
            }

            $.ajax({
                type: 'PATCH',
                url: config.apiURL+'card_templates/'+id+'?organization_id='+organization_id,
                data: {
                    //"card_template[card_type_id]":      templateData.template.card_type_id,
                    "card_template[name]":              templateData.template.name,
                    "card_template[front_data]":        JSON.stringify(templateData.template.front_data),
                    "card_template[back_data]":         JSON.stringify(templateData.template.back_data),
                    "card_template[options]":           JSON.stringify(templateData.template.options),
                    "card_template[template_fields]":   JSON.stringify(templateData.template.template_fields),
                    "card_template[card_data]":         JSON.stringify(templateData.template.card_data)//,
                    //"card_template[special_handlings]": JSON.stringify(templateData.template.special_handlings)
                },
                success: function () {
                    var templateId = id;

                    var imagesToUpdate = [];
                    var uploadedImages = 0;

                    // upload images
                    for(var i=0; i<templateData.images.length; i++) {
                        var imgBlob = base64toBlob('data:image/jpeg;base64,'+templateData.images[i].base64);
                        var imgFile = blobToFile(imgBlob, templateData.images[i].src);

                        var fd = new FormData();
                        fd.append('card_template[images][]', imgFile, templateData.images[i].src);

                        $.ajax({
                            type: 'POST',
                            url: config.apiURL+'card_templates/'+templateId+'/upload?organization_id='+templateData.template.organization_id,
                            async: false,
                            data: fd,
                            contentType: false,
                            processData: false,
                            cache: false,
                            success: function (data) {
                                uploadedImages++;

                                var imgSuccess = false;
                                for(y=0; y<data.images.length; y++) {
                                    var filename = data.images[y].url,
                                        substr = "/",
                                        path = filename.split(substr);

                                    filename = path[path.length-1];

                                    if(filename == unsupportedCharactersToUnderscore(templateData.images[i].src)) {
                                        imagesToUpdate.push({
                                            name: templateData.images[i].src,
                                            src: data.images[y].url
                                        });

                                        imgSuccess = true;

                                        break;
                                    }
                                }

                                if(!imgSuccess) {
                                    addMessage("Couldn't upload the image ("+templateData.images[i].src+")", "error");
                                    changeStatus("error");
                                    console.log(templateData);
                                    console.log(data);
                                }

                                if(uploadedImages == templateData.images.length) {
                                    for(z=0; z<imagesToUpdate.length; z++) {
                                        var nameRegExp = new RegExp(imagesToUpdate[z].name, 'g');
                                        templateData.template.front_data = JSON.parse(JSON.stringify(templateData.template.front_data).replace(nameRegExp, imagesToUpdate[z].src));
                                        templateData.template.back_data = JSON.parse(JSON.stringify(templateData.template.back_data).replace(nameRegExp, imagesToUpdate[z].src));
                                    }

                                    updateTemplate(data.id, data.organization_id, templateData, false);
                                }
                            },
                            error: function (response) {
                                addMessage("Couldn't upload the image ("+templateData.images[i].src+")", "error");
                                changeStatus("error");
                                console.log('error: '+JSON.stringify(response));
                            }
                        });
                    }
                },
                error: function (data) {
                    addMessage("Couldn't upload the template (#2)", "error");
                    changeStatus("error");
                    console.log(JSON.stringify(data));
                }
            });
        }

        function _convert(card_ref_num) {
            changeStatus("migrating");
            $('#loading').removeClass('hidden');
            $.ajax({
                type: 'GET',
                url: 'converter_backend.php?card_ref_num='+card_ref_num,
                success: function (data) {
                    if(data == "too many images") {
                        addMessage("Template with 10+ images", "error");
                        changeStatus("error");
                        return;
                    }
                    else if(data == "no template data") {
                        addMessage("No template data in the CARD database table", "error");
                        changeStatus("error");
                        return;
                    }

                    var card = data.CARD,
                        cardData = data.CARDDATA,
                        fieldsel = data.FIELDSEL;

                    var templateData = convertTemplate(card, cardData, {color: color_color, slot_punch: slot_punch, mag_stripe: mag_stripe, fieldsel: fieldsel});

                    $('#templateData').val(JSON.stringify(templateData.template));
                    $('#templateDataImages').val(JSON.stringify(templateData.images));

                    // Generating previews
                    if(showPreviews) {
                        var previewTemplate = $.extend(true,{},templateData.template);
                        swapImagesToBase64(prepareTemplateForPreview(previewTemplate.front_data), templateData.images, true);
                        swapImagesToBase64(prepareTemplateForPreview(previewTemplate.back_data), templateData.images, false);
                    }

                    // Send template and images to API
                    if(upload) {
                        if(create_new)
                            uploadTemplate(templateData);
                        else
                            updateTemplate(templateData.template.id, templateData.template.organization_id, templateData, true);
                    }

                    $('#loading').addClass('hidden');
                    //$("#imageReady").html("isReady");
                },
                error: function (data) {
                    console.log(data);
                    addMessage("Couldn't get the template data from the database", "error");
                    changeStatus("error");
                }
            });
        }
    });
</script>
<div id="imageReady" style="display:none"></div>
</body>
</html>